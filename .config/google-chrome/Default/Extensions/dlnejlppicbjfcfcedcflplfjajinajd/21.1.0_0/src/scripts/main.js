(()=>{var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty;var __esm=(fn,res)=>function(){return fn&&(res=(0,fn[__getOwnPropNames(fn)[0]])(fn=0)),res};var __commonJS=(cb,mod2)=>function(){return mod2||(0,cb[__getOwnPropNames(cb)[0]])((mod2={exports:{}}).exports,mod2),mod2.exports};var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})},__copyProps=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames(from))!__hasOwnProp.call(to,key)&&key!==except&&__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to};var __toESM=(mod2,isNodeMode,target)=>(target=mod2!=null?__create(__getProtoOf(mod2)):{},__copyProps(isNodeMode||!mod2||!mod2.__esModule?__defProp(target,"default",{value:mod2,enumerable:!0}):target,mod2));var require_dist=__commonJS({"node_modules/.deno/clickdown@1.3.4/node_modules/clickdown/dist/index.js"(exports,module){var __defProp2=Object.defineProperty,__getOwnPropDesc2=Object.getOwnPropertyDescriptor,__getOwnPropNames2=Object.getOwnPropertyNames,__hasOwnProp2=Object.prototype.hasOwnProperty,__export2=(target,all)=>{for(var name in all)__defProp2(target,name,{get:all[name],enumerable:!0})},__copyProps2=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames2(from))!__hasOwnProp2.call(to,key)&&key!==except&&__defProp2(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc2(from,key))||desc.enumerable});return to},__toCommonJS=mod2=>__copyProps2(__defProp2({},"__esModule",{value:!0}),mod2),index_exports={};__export2(index_exports,{onclickdown:()=>onclickdown8});module.exports=__toCommonJS(index_exports);function onclickdown8(target,callback,options){if(!target)throw new Error("Target is undefined");let isCheckbox=target.tagName==="INPUT"&&target.getAttribute("type")==="checkbox",isLink2=target.tagName==="A",isFast=!1;target?.addEventListener("pointerdown",downEvent),target?.addEventListener("keydown",downEvent),target?.addEventListener("click",clickEvent);function downEvent(event){let isKeydown=event.type==="keydown",code=event?.code??"",target2=event.target,tagName=target2.tagName??"";if(!(isKeydown&&!code.match(/Space|Enter/))&&!(isLink2&&isKeydown&&code==="Space")){if(tagName==="SUMMARY"){let details=target2;details.open=!details.open}if(isCheckbox){let checkbox=target2;checkbox.checked=!checkbox.checked}if(isLink2){let link=target2;globalThis.window.location.href=link.href}isFast=!0,callback(event,target2)}}function clickEvent(event){if(!(event.composedPath()[0]!==target&&options?.propagate===!1)){if(isFast===!1){callback(event,target);return}isFast=!1,event.preventDefault()}}}}});function Token(type,content,matchedStr,alias){this.type=type,this.content=content,this.alias=alias,this.length=matchedStr.length}var plainTextGrammar,rest,tokenize,resolve,languages,tokenizeText,withoutTokenizer,closingTag,openingTags,closingTags,highlightTokens,stringify,matchGrammar,init_index_bkac8M6P=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/index-bkac8M6P.js"(){plainTextGrammar={},rest=Symbol(),tokenize=Symbol(),resolve=id=>typeof id=="string"?languages[id]:id,languages={plain:plainTextGrammar,plaintext:plainTextGrammar,text:plainTextGrammar,txt:plainTextGrammar},tokenizeText=(text,grammar)=>(grammar[tokenize]||withoutTokenizer)(text,grammar),withoutTokenizer=(text,grammar)=>{for(var startNode=[text],restGrammar,array=[],i=0;restGrammar=resolve(grammar[rest]);)delete grammar[rest],Object.assign(grammar,restGrammar);for(matchGrammar(text,grammar,startNode,0);array[i++]=startNode[0],startNode=startNode[1];);return array},closingTag="</span>",openingTags="",closingTags="",highlightTokens=tokens=>{for(var str="",l=tokens.length,i=0;i<l;)str+=stringify(tokens[i++]);return str},stringify=token=>{if(token instanceof Token){var{type,alias,content}=token,prevOpening=openingTags,prevClosing=closingTags,opening=`<span class="token ${type+(alias?" "+alias:"")+(type=="keyword"&&typeof content=="string"?" keyword-"+content:"")}">`;closingTags+=closingTag,openingTags+=opening;var contentStr=stringify(content);return openingTags=prevOpening,closingTags=prevClosing,opening+contentStr+closingTag}return typeof token!="string"?highlightTokens(token):(token=token.replace(/&/g,"&amp;").replace(/</g,"&lt;"),closingTags&&token.includes(`
`)?token.replace(/\n/g,closingTags+`
`+openingTags):token)},matchGrammar=(text,grammar,startNode,startPos,rematch)=>{for(var token in grammar)if(grammar[token])for(var j=0,p=grammar[token],patterns=Array.isArray(p)?p:[p];j<patterns.length;++j){if(rematch&&rematch[0]==token&&rematch[1]==j)return;for(var patternObj=patterns[j],pattern=patternObj.pattern||patternObj,inside=resolve(patternObj.inside),lookbehind=patternObj.lookbehind,greedy=patternObj.greedy&&pattern.global,alias=patternObj.alias,currentNode=startNode,pos=startPos;currentNode&&(!rematch||pos<rematch[2]);pos+=currentNode[0].length,currentNode=currentNode[1]){var str=currentNode[0],removeCount=0,match,lookbehindLength;if(!(str instanceof Token)){if(pattern.lastIndex=greedy?pos:0,match=pattern.exec(greedy?text:str),match&&lookbehind&&match[1]&&(lookbehindLength=match[1].length,match.index+=lookbehindLength,match[0]=match[0].slice(lookbehindLength)),greedy){if(!match)break;if(match[0]){for(var from=match.index,to=from+match[0].length,l;from>=pos+(l=currentNode[0].length);currentNode=currentNode[1],pos+=l);if(currentNode[0]instanceof Token)continue;for(var k=currentNode,p=pos;(p+=k[0].length)<to;k=k[1],removeCount++);str=text.slice(pos,p),match.index-=pos}}if(match&&match[0]){for(var from=match.index,matchStr=match[0],after=str.slice(from+matchStr.length),reach=pos+str.length,newToken=new Token(token,inside?tokenizeText(matchStr,inside):matchStr,matchStr,alias),next=currentNode,i=0,nestedRematch;next=next[1],i++<removeCount;);after&&(!next||next[0]instanceof Token?next=[after,next]:next[0]=after+next[0]),pos+=from,currentNode[0]=from?str.slice(0,from):newToken,from?currentNode=currentNode[1]=[newToken,next]:currentNode[1]=next,removeCount&&(matchGrammar(text,grammar,currentNode,pos,nestedRematch=[token,j,reach]),reach=nestedRematch[2]),rematch&&reach>rematch[2]&&(rematch[2]=reach)}}}}}}});var createEditor,templateEl,createTemplate,addTextareaListener,getElement,userAgent,isMac,isChrome,isWebKit,numLines,languageMap,editorTemplate,preventDefault,selectionChange,init_index_BltwYS88=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/index-BltwYS88.js"(){init_index_bkac8M6P();createEditor=(container2,options,...extensions)=>{let language,grammar,prevLines=[],activeLine,value="",activeLineNumber,removed=!1,focused=!1,handleSelectionChange=!0,tokens=[],readOnly,lineCount=0,scrollContainer=editorTemplate(),wrapper=scrollContainer.firstChild,lines=wrapper.children,overlays=lines[0],textarea=overlays.firstChild,currentOptions={language:"text",value},currentExtensions=new Set(extensions),listeners={},setOptions=options2=>{if(Object.assign(currentOptions,options2),value=options2.value??value,language=currentOptions.language,!languages[language])throw Error(`Language '${language}' has no grammar.`);readOnly=!!currentOptions.readOnly,scrollContainer.style.tabSize=currentOptions.tabSize||2,textarea.inputMode=readOnly?"none":"",textarea.setAttribute("aria-readonly",readOnly),updateClassName(),updateExtensions(),(grammar!=(grammar=languages[language])||value!=textarea.value)&&(focusRelatedTarget(),textarea.value=value,textarea.selectionEnd=0,update())},update=()=>{tokens=tokenizeText(value=textarea.value,grammar),dispatchEvent("tokenize",tokens,language,value);let newLines=highlightTokens(tokens).split(`
`),start=0,end2=lineCount,end1=lineCount=newLines.length;for(;newLines[start]==prevLines[start]&&start<end1;)++start;for(;end1&&newLines[--end1]==prevLines[--end2];);if(start==end1&&start==end2)lines[start+1].innerHTML=newLines[start]+`
`;else{let insertStart=end2<start?end2:start-1,i=insertStart,newHTML="";for(;i<end1;)newHTML+=`<div class=pce-line aria-hidden=true>${newLines[++i]}
</div>`;for(i=end1<start?end1:start-1;i<end2;i++)lines[start+1].remove();for(newHTML&&lines[insertStart+1].insertAdjacentHTML("afterend",newHTML),i=insertStart+1;i<lineCount;)lines[++i].setAttribute("data-line",i);scrollContainer.style.setProperty("--number-width",Math.ceil(Math.log10(lineCount+1))+".001ch")}dispatchEvent("update",value),dispatchSelection(!0),handleSelectionChange&&setTimeout(setTimeout,0,()=>handleSelectionChange=!0),prevLines=newLines,handleSelectionChange=!1},updateExtensions=newExtensions=>{(newExtensions||currentExtensions).forEach(extension=>{typeof extension=="object"?(extension.update(self,currentOptions),newExtensions&&currentExtensions.add(extension)):(extension(self,currentOptions),newExtensions||currentExtensions.delete(extension))})},updateClassName=([start,end]=getInputSelection())=>{scrollContainer.className=`prism-code-editor language-${language}${currentOptions.lineNumbers==!1?"":" show-line-numbers"} pce-${currentOptions.wordWrap?"":"no"}wrap${currentOptions.rtl?" pce-rtl":""} pce-${start<end?"has":"no"}-selection${focused?" pce-focus":""}${readOnly?" pce-readonly":""}`},getInputSelection=()=>[textarea.selectionStart,textarea.selectionEnd,textarea.selectionDirection],keyCommandMap={Escape(){textarea.blur()}},inputCommandMap={},focusRelatedTarget=()=>isWebKit&&!focused&&addTextareaListener(self,"focus",e=>{let relatedTarget=e.relatedTarget;relatedTarget?relatedTarget.focus():textarea.blur()},{once:!0}),dispatchEvent=(name,...args)=>{listeners[name]?.forEach(handler=>handler.apply(self,args)),currentOptions["on"+name[0].toUpperCase()+name.slice(1)]?.apply(self,args)},dispatchSelection=force=>{if(force||handleSelectionChange){let selection=getInputSelection(),newLine=lines[activeLineNumber=numLines(value,0,selection[selection[2]<"f"?0:1])];newLine!=activeLine&&(activeLine?.classList.remove("active-line"),newLine.classList.add("active-line"),activeLine=newLine),updateClassName(selection),dispatchEvent("selectionChange",selection,value)}},self={scrollContainer,wrapper,overlays,textarea,get activeLine(){return activeLine},get activeLineNumber(){return activeLineNumber},get value(){return value},options:currentOptions,get focused(){return focused},get removed(){return removed},get tokens(){return tokens},inputCommandMap,keyCommandMap,extensions:{},setOptions,update,getSelection:getInputSelection,setSelection(start,end=start,direction){focusRelatedTarget(),textarea.setSelectionRange(start,end,direction),dispatchSelection(!0)},addExtensions(...extensions2){updateExtensions(extensions2)},addListener(name,handler){(listeners[name]||(listeners[name]=new Set)).add(handler)},removeListener(name,handler){listeners[name]?.delete(handler)},remove(){scrollContainer.remove(),removed=!0}};return addTextareaListener(self,"keydown",e=>{keyCommandMap[e.key]?.(e,getInputSelection(),value)&&preventDefault(e)}),addTextareaListener(self,"beforeinput",e=>{(readOnly||e.inputType=="insertText"&&inputCommandMap[e.data]?.(e,getInputSelection(),value))&&preventDefault(e)}),addTextareaListener(self,"input",update),addTextareaListener(self,"blur",()=>{selectionChange=null,focused=!1,updateClassName()}),addTextareaListener(self,"focus",()=>{selectionChange=dispatchSelection,focused=!0,updateClassName()}),addTextareaListener(self,"selectionchange",e=>{dispatchSelection(),preventDefault(e)}),getElement(container2)?.append(scrollContainer),options&&setOptions(options),self},templateEl=document.createElement("div"),createTemplate=html=>{templateEl.innerHTML=html;let node=templateEl.firstChild;return()=>node.cloneNode(!0)},addTextareaListener=(editor,type,listener,options)=>editor.textarea.addEventListener(type,listener,options),getElement=el=>typeof el=="string"?document.querySelector(el):el,userAgent=navigator.userAgent,isMac=/Mac|iPhone|iPod|iPad/i.test(navigator.platform),isChrome=/Chrome\//.test(userAgent),isWebKit=!isChrome&&/AppleWebKit\//.test(userAgent),numLines=(str,start=0,end=1/0)=>{let count=1;for(;(start=str.indexOf(`
`,start)+1)&&start<=end;count++);return count},languageMap={},editorTemplate=createTemplate("<div><div class=pce-wrapper><div class=pce-overlays><textarea spellcheck=false autocapitalize=off autocomplete=off>"),preventDefault=e=>{e.preventDefault(),e.stopImmediatePropagation()};document.addEventListener("selectionchange",()=>selectionChange?.())}});var init_dist=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/index.js"(){init_index_BltwYS88()}});var getLineStart,getLineEnd,addListener,getStyleValue,init_local_VpqO7_GV=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/local-VpqO7_GV.js"(){getLineStart=(text,position)=>position?text.lastIndexOf(`
`,position-1)+1:0,getLineEnd=(text,position)=>(position=text.indexOf(`
`,position))+1?position:text.length,addListener=(editor,type,listener)=>(editor.addListener(type,listener),()=>editor.removeListener(type,listener)),getStyleValue=(el,prop)=>parseFloat(getComputedStyle(el)[prop])}});var prevSelection,regexEscape,getLineBefore,getLines,getClosestToken,getLanguage,insertText,getModifierCode,init_utils=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/utils/index.js"(){init_index_BltwYS88();init_local_VpqO7_GV();regexEscape=str=>str.replace(/[$+?|.^*()[\]{}\\]/g,"\\$&"),getLineBefore=(text,position)=>text.slice(getLineStart(text,position),position),getLines=(text,start,end=start)=>[text.slice(start=getLineStart(text,start),end=getLineEnd(text,end)).split(`
`),start,end],getClosestToken=(editor,selector,marginLeft=0,marginRight=marginLeft,position=editor.getSelection()[0])=>{let value=editor.value,line=editor.wrapper.children[numLines(value,0,position)],walker=document.createTreeWalker(line,5),node=walker.lastChild(),offset=getLineEnd(value,position)+1-position-node.length;for(;-offset<=marginRight&&(node=walker.previousNode());)if(!node.lastChild&&(offset-=node.length||0,offset<=marginLeft)){for(;node!=line;node=node.parentNode)if(node.matches?.(selector))return node}},getLanguage=(editor,position)=>getClosestToken(editor,'[class*="language-"]',0,0,position)?.className.match(/language-(\S*)/)[1]||editor.options.language,insertText=(editor,text,start,end,newCursorStart,newCursorEnd)=>{if(editor.options.readOnly)return;prevSelection=editor.getSelection(),end??(end=start);let textarea=editor.textarea,value=editor.value,avoidBug=isChrome&&!value[end??prevSelection[1]]&&/\n$/.test(text)&&/^$|\n$/.test(value),removeListener;editor.focused||textarea.focus(),start!=null&&textarea.setSelectionRange(start,end),newCursorStart!=null&&(removeListener=addListener(editor,"update",()=>{textarea.setSelectionRange(newCursorStart,newCursorEnd??newCursorStart,prevSelection[2]),removeListener()})),isWebKit||textarea.dispatchEvent(new InputEvent("beforeinput",{data:text})),isChrome||isWebKit?(avoidBug&&(textarea.selectionEnd--,text=text.slice(0,-1)),isWebKit&&(text+=`
`),document.execCommand(text?"insertHTML":"delete",!1,text.replace(/&/g,"&amp;").replace(/</g,"&lt;")),avoidBug&&textarea.selectionStart++):document.execCommand(text?"insertText":"delete",!1,text),prevSelection=0},getModifierCode=e=>e.altKey+e.ctrlKey*2+e.metaKey*4+e.shiftKey*8}});var ignoreTab,clipboard,mod,setIgnoreTab,whitespaceEnd,defaultCommands,init_commands=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/extensions/commands.js"(){init_index_BltwYS88();init_utils();init_local_VpqO7_GV();ignoreTab=!1,clipboard=navigator.clipboard,mod=isMac?4:2,setIgnoreTab=newState=>ignoreTab=newState,whitespaceEnd=str=>str.search(/\S|$/),defaultCommands=(selfClosePairs=['""',"''","``","()","[]","{}"],selfCloseRegex=/([^$\w'"`]["'`]|.[[({])[.,:;\])}>\s]|.[[({]`/s)=>(editor,options)=>{let prevCopy,{keyCommandMap,inputCommandMap,getSelection:getSelection2,scrollContainer}=editor,getIndent=({insertSpaces=!0,tabSize}=options)=>[insertSpaces?" ":"	",insertSpaces?tabSize||2:1],scroll=()=>!options.readOnly&&!editor.extensions.cursor?.scrollIntoView(),selfClose=([start,end],[open,close],value,wrapOnly)=>(start<end||!wrapOnly&&selfCloseRegex.test((value[end-1]||" ")+open+(value[end]||" ")))&&!insertText(editor,open+value.slice(start,end)+close,null,null,start+1,end+1),skipIfEqual=([start,end],char,value)=>start==end&&value[end]==char&&!editor.setSelection(start+1),insertLines=(old,newL,start,end,selectionStart,selectionEnd)=>{let newLines=newL.join(`
`);if(newLines!=old.join(`
`)){let last=old.length-1,lastLine=newL[last],oldLastLine=old[last],lastDiff=oldLastLine.length-lastLine.length,firstDiff=newL[0].length-old[0].length,firstInsersion=start+whitespaceEnd((firstDiff<0?newL:old)[0]),lastInsersion=end-oldLastLine.length+whitespaceEnd(lastDiff>0?lastLine:oldLastLine),offset=start-end+newLines.length+lastDiff,newCursorStart=firstInsersion>selectionStart?selectionStart:Math.max(firstInsersion,selectionStart+firstDiff),newCursorEnd=selectionEnd+start-end+newLines.length;insertText(editor,newLines,start,end,newCursorStart,selectionEnd<lastInsersion?newCursorEnd+lastDiff:Math.max(lastInsersion+offset,newCursorEnd))}},indent=(outdent,lines,start1,end1,start,end,indentChar,tabSize)=>{insertLines(lines,lines.map(outdent?str=>str.slice(whitespaceEnd(str)?tabSize-whitespaceEnd(str)%tabSize:0):str=>str&&indentChar.repeat(tabSize-whitespaceEnd(str)%tabSize)+str),start1,end1,start,end)};inputCommandMap["<"]=(_e,selection,value)=>selfClose(selection,"<>",value,!0),selfClosePairs.forEach(([open,close])=>{let isQuote=open==close;inputCommandMap[open]=(_e,selection,value)=>(isQuote&&skipIfEqual(selection,close,value)||selfClose(selection,open+close,value))&&scroll(),isQuote||(inputCommandMap[close]=(_e,selection,value)=>skipIfEqual(selection,close,value)&&scroll())}),inputCommandMap[">"]=(e,selection,value)=>{let closingTag2=languageMap[getLanguage(editor)]?.autoCloseTags?.(selection,value,editor);closingTag2&&(insertText(editor,">"+closingTag2,null,null,selection[0]+1),preventDefault(e))},keyCommandMap.Tab=(e,[start,end],value)=>{if(ignoreTab||options.readOnly||getModifierCode(e)&6)return;let[indentChar,tabSize]=getIndent(options),shiftKey=e.shiftKey,[lines,start1,end1]=getLines(value,start,end);return start<end||shiftKey?indent(shiftKey,lines,start1,end1,start,end,indentChar,tabSize):insertText(editor,indentChar.repeat(tabSize-(start-start1)%tabSize)),scroll()},keyCommandMap.Enter=(e,selection,value)=>{let code=getModifierCode(e)&7;if(!code||code==mod){code&&(selection[0]=selection[1]=getLines(value,selection[1])[2]);let[indentChar,tabSize]=getIndent(),[start,end]=selection,autoIndent=languageMap[getLanguage(editor)]?.autoIndent,indenationCount=Math.floor(whitespaceEnd(getLineBefore(value,start))/tabSize)*tabSize,extraIndent=autoIndent?.[0]?.(selection,value,editor)?tabSize:0,extraLine=autoIndent?.[1]?.(selection,value,editor),newText=`
`+indentChar.repeat(indenationCount+extraIndent)+(extraLine?`
`+indentChar.repeat(indenationCount):"");if(newText[1]||value[end])return insertText(editor,newText,start,end,start+indenationCount+extraIndent+1),scroll()}},keyCommandMap.Backspace=(_e,[start,end],value)=>{if(start==end){let line=getLineBefore(value,start),tabSize=options.tabSize||2,isPair=selfClosePairs.includes(value.slice(start-1,start+1)),indenationCount=/[^ ]/.test(line)?0:(line.length-1)%tabSize+1;if(isPair||indenationCount>1)return insertText(editor,"",start-(isPair?1:indenationCount),start+isPair),scroll()}};for(let i=0;i<2;i++)keyCommandMap[i?"ArrowDown":"ArrowUp"]=(e,[start,end],value)=>{let code=getModifierCode(e);if(code==1){let newStart=i?start:getLineStart(value,start)-1,newEnd=i?value.indexOf(`
`,end)+1:end;if(newStart>-1&&newEnd>0){let[lines,start1,end1]=getLines(value,newStart,newEnd),line=lines[i?"pop":"shift"](),offset=(line.length+1)*(i?1:-1);lines[i?"unshift":"push"](line),insertText(editor,lines.join(`
`),start1,end1,start+offset,end+offset)}return scroll()}else if(code==9){let[lines,start1,end1]=getLines(value,start,end),str=lines.join(`
`),offset=i?str.length+1:0;return insertText(editor,str+`
`+str,start1,end1,start+offset,end+offset),scroll()}else if(code==2&&!isMac)return scrollContainer.scrollBy(0,getStyleValue(scrollContainer,"lineHeight")*(i?1:-1)),!0};addTextareaListener(editor,"keydown",e=>{let code=getModifierCode(e),keyCode=e.keyCode,[start,end,dir]=getSelection2();if(code==mod&&(keyCode==221||keyCode==219))indent(keyCode==219,...getLines(editor.value,start,end),start,end,...getIndent()),scroll(),preventDefault(e);else if(code==(isMac?10:2)&&keyCode==77)setIgnoreTab(!ignoreTab),preventDefault(e);else if(keyCode==191&&code==mod||keyCode==65&&code==9){let value=editor.value,isBlock=code==9,position=isBlock?start:getLineStart(value,start),language=languageMap[getLanguage(editor,position)]||{},{line,block}=language.getComments?.(editor,position,value)||language.comments||{},[lines,start1,end1]=getLines(value,start,end),last=lines.length-1;if(isBlock){if(block){let[open,close]=block,text=value.slice(start,end),pos=value.slice(0,start).search(regexEscape(open)+" ?$"),matches=RegExp("^ ?"+regexEscape(close)).test(value.slice(end));pos+1&&matches?insertText(editor,text,pos,end+ +(value[end]==" ")+close.length,pos,pos+end-start):insertText(editor,`${open} ${text} ${close}`,start,end,start+open.length+1,end+open.length+1),scroll(),preventDefault(e)}}else if(line){let escaped=regexEscape(line),regex=RegExp(`^\\s*(${escaped} ?|$)`),regex2=RegExp(escaped+" ?"),allWhiteSpace=!/\S/.test(value.slice(start1,end1)),newLines=lines.map(lines.every(line2=>regex.test(line2))&&!allWhiteSpace?str=>str.replace(regex2,""):str=>allWhiteSpace||/\S/.test(str)?str.replace(/^\s*/,`$&${line} `):str);insertLines(lines,newLines,start1,end1,start,end),scroll(),preventDefault(e)}else if(block){let[open,close]=block,insertionPoint=whitespaceEnd(lines[0]),hasComment=lines[0].startsWith(open,insertionPoint)&&lines[last].endsWith(close),newLines=lines.slice();newLines[0]=lines[0].replace(hasComment?RegExp(regexEscape(open)+" ?"):/(?=\S)|$/,hasComment?"":open+" ");let diff=newLines[0].length-lines[0].length;newLines[last]=hasComment?newLines[last].replace(RegExp(`( ?${regexEscape(close)})?$`),""):newLines[last]+" "+close;let newText=newLines.join(`
`),firstInsersion=insertionPoint+start1,newStart=firstInsersion>start?start:Math.max(start+diff,firstInsersion),newEnd=firstInsersion>end-(start!=end)?end:Math.min(Math.max(firstInsersion,end+diff),start1+newText.length);insertText(editor,newText,start1,end1,newStart,Math.max(newStart,newEnd)),scroll(),preventDefault(e)}}else if(code==8+mod&&keyCode==75){let value=editor.value,[lines,start1,end1]=getLines(value,start,end),column=dir>"f"?end-end1+lines.pop().length:start-start1,newLineLen=getLineEnd(value,end1+1)-end1-1;insertText(editor,"",start1-!!start1,end1+!start1,start1+Math.min(column,newLineLen)),scroll(),preventDefault(e)}}),["copy","cut","paste"].forEach(type=>addTextareaListener(editor,type,e=>{let[start,end]=getSelection2();if(start==end&&clipboard){let[[line],start1,end1]=getLines(editor.value,start,end);type=="paste"?e.clipboardData.getData("text/plain")==prevCopy&&(insertText(editor,prevCopy+`
`,start1,start1,start+prevCopy.length+1),scroll(),preventDefault(e)):(clipboard.writeText(prevCopy=line),type=="cut"&&(insertText(editor,"",start1,end1+1),scroll()),preventDefault(e))}}))}}});var insertBefore,toString,init_language_DPYOfXzt=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/language-DPYOfXzt.js"(){insertBefore=(grammar,before,insert)=>{var temp={};for(var token in grammar)temp[token]=grammar[token],delete grammar[token];for(var token in temp)token==before&&Object.assign(grammar,insert),insert.hasOwnProperty(token)||(grammar[token]=temp[token])},toString={}.toString}});var string,stringSrc,atruleInside,init_css=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/prism/languages/css.js"(){init_index_bkac8M6P();string=/(?:"(?:\\[^]|[^\\\n"])*"|'(?:\\[^]|[^\\\n'])*')/g,stringSrc=string.source,atruleInside={rule:/^@[\w-]+/,"selector-function-argument":{pattern:/(\bselector\s*\(\s*(?![\s)]))(?:[^()\s]|\s+(?![\s)])|\((?:[^()]|\([^)]*\))*\))+(?=\s*\))/,lookbehind:!0,alias:"selector"},keyword:{pattern:/(^|[^\w-])(?:and|not|only|or)(?![\w-])/,lookbehind:!0}};atruleInside[rest]=languages.css={comment:/\/\*[^]*?\*\//,atrule:{pattern:RegExp(`@[\\w-](?:[^;{\\s"']|\\s+(?!\\s)|${stringSrc})*?(?:;|(?=\\s*\\{))`),inside:atruleInside},url:{pattern:RegExp(`\\burl\\((?:${stringSrc}|(?:[^\\\\
"')=]|\\\\[^])*)\\)`,"gi"),greedy:!0,inside:{function:/^url/i,punctuation:/^\(|\)$/,string:{pattern:RegExp("^"+stringSrc+"$"),alias:"url"}}},selector:{pattern:RegExp(`(^|[{}\\s])[^{}\\s](?:[^{};"'\\s]|\\s+(?![\\s{])|${stringSrc})*(?=\\s*\\{)`),lookbehind:!0},string:{pattern:string,greedy:!0},property:{pattern:/(^|[^-\w\xa0-\uffff])(?!\d)(?:(?!\s)[-\w\xa0-\uffff])+(?=\s*:)/i,lookbehind:!0},important:/!important\b/i,function:{pattern:/(^|[^-a-z\d])[-a-z\d]+(?=\()/i,lookbehind:!0},punctuation:/[(){},:;]/}}});var css,unit,number,init_css_extras=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/prism/languages/css-extras.js"(){init_index_bkac8M6P();init_language_DPYOfXzt();init_css();css=languages.css,unit={pattern:/(\b\d+)(?:%|[a-z]+(?![\w-]))/,lookbehind:!0},number={pattern:/(^|[^\w.-])-?(?:\d+(?:\.\d+)?|\.\d+)/,lookbehind:!0};css.selector.inside=css.atrule.inside["selector-function-argument"].inside={"pseudo-element":/:(?:after|before|first-letter|first-line|selection)|::[-\w]+/,"pseudo-class":/:[-\w]+/,class:/\.[-\w]+/,id:/#[-\w]+/,attribute:{pattern:/\[(?:[^[\]"']|(["'])(?:\\[^]|(?!\1)[^\\\n])*\1)*\]/g,greedy:!0,inside:{punctuation:/^\[|\]$/,"case-sensitivity":{pattern:/(\s)[si]$/i,lookbehind:!0,alias:"keyword"},namespace:{pattern:/^(\s*)(?:(?!\s)[-*\w\xa0-\uffff])*\|(?!=)/,lookbehind:!0,inside:{punctuation:/\|$/}},"attr-name":{pattern:/^(\s*)(?:(?!\s)[-\w\xa0-\uffff])+/,lookbehind:!0},"attr-value":{pattern:/(=\s*)(?:(?!\s)[-\w\xa0-\uffff])+(?=\s*$)|(["'])(?:\\[^]|(?!\2)[^\\\n])*\2/,lookbehind:!0},operator:/[|~*^$]?=/}},"n-th":[{pattern:/(\(\s*)[+-]?\d*[\dn](?:\s*[+-]\s*\d+)?(?=\s*\))/,lookbehind:!0,inside:{number:/[\dn]+/,operator:/[+-]/}},{pattern:/(\(\s*)(?:even|odd)(?=\s*\))/i,lookbehind:!0}],combinator:/>|\+|~|\|\|/,punctuation:/[(),]/};insertBefore(css,"property",{variable:{pattern:/(^|[^-\w\xa0-\uffff])--(?!\d)(?:(?!\s)[-\w\xa0-\uffff])*/i,lookbehind:!0}});insertBefore(css,"function",{operator:{pattern:/(\s)[/*+-](?!\S)/,lookbehind:!0},hexcode:{pattern:/\B#[a-f\d]{3,8}\b/i,alias:"color"},color:[{pattern:/(^|[^\w-])(?:(?:alice|cadet|cornflower|deepsky|dodger|midnight|powder|royal|sky|steel)blue|antiquewhite|aqua|aquamarine|azure|beige|bisque|black|blanchedalmond|blueviolet|brown|burlywood|chartreuse|chocolate|coral|cornsilk|crimson|(?:dark)?(?:blue|cyan|goldenrod|gr[ae]y|green|khaki|magenta|olivegreen|orange|orchid|red|salmon|seagreen|slateblue|slategr[ae]y|turquoise|violet)|deeppink|dimgr[ae]y|firebrick|floralwhite|(?:forest|lawn|lime|pale|spring)green|fuchsia|gainsboro|ghostwhite|gold|greenyellow|honeydew|hotpink|indianred|indigo|ivory|lavender|lavenderblush|lemonchiffon|light(?:blue|coral|cyan|goldenrodyellow|gr[ae]y|green|pink|salmon|seagreen|skyblue|slategr[ae]y|steelblue|yellow)|lime|linen|maroon|medium(?:aquamarine|blue|orchid|purple|seagreen|slateblue|springgreen|turquoise|violetred)|mintcream|mistyrose|moccasin|navajowhite|navy|oldlace|olive|olivedrab|orangered|palegoldenrod|paleturquoise|palevioletred|papayawhip|peachpuff|peru|pink|plum|purple|rebeccapurple|rosybrown|saddlebrown|sandybrown|seashell|sienna|silver|snow|tan|teal|thistle|tomato|transparent|wheat|white|whitesmoke|yellow|yellowgreen)(?![\w-])/i,lookbehind:!0},{pattern:/\b(?:hsl|rgb)\(\s*\d{1,3}\s*,\s*\d{1,3}%?\s*,\s*\d{1,3}%?\s*\)\B|\b(?:hsl|rgb)a\(\s*\d{1,3}\s*,\s*\d{1,3}%?\s*,\s*\d{1,3}%?\s*,\s*(?:0|0?\.\d+|1)\s*\)\B/i,inside:{function:/^[^(]+/,unit,number,punctuation:/[(),]/}}],entity:/\\[a-f\d]{1,8}/i,unit,number})}});var init_uri=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/prism/languages/uri.js"(){init_index_bkac8M6P();languages.url=languages.uri={scheme:{pattern:/^[a-z][a-z\d+.-]*:/img,greedy:!0,inside:{"scheme-delimiter":/:$/}},fragment:{pattern:/#[\w.~!$&'()*,;=%:@/?+-]*/,inside:{"fragment-delimiter":/^#/}},query:{pattern:/\?[\w.~!$&'()*,;=%:@/?+-]*/,inside:{"query-delimiter":{pattern:/^\?/g,greedy:!0},"pair-delimiter":/[&;]/,pair:{pattern:/^[^=][^]*/,inside:{key:/^[^=]+/,value:{pattern:/(^=)[^]+/,lookbehind:!0}}}}},authority:{pattern:/^\/\/(?:[\w.~!$&'()*,;=%:+-]*@)?(?:\[(?:[a-fA-F\d:.]{2,48}|v[a-fA-F\d]+\.[\w.~!$&'()*,;=+-]+)\]|[\w.~!$&'()*,;=%+-]*)(?::\d*)?/m,inside:{"authority-delimiter":/^\/\//,"user-info-segment":{pattern:/^[\w.~!$&'()*,;=%:+-]*@/,inside:{"user-info-delimiter":/@$/,"user-info":/^[\w.~!$&'()*,;=%:+-]+/}},"port-segment":{pattern:/:\d*$/,inside:{"port-delimiter":/^:/,port:/^\d+/}},host:{pattern:/[^]+/,inside:{"ip-literal":{pattern:/^\[[^]+\]$/,inside:{"ip-literal-delimiter":/^\[|\]$/,"ipv-future":/^v[^]+/,"ipv6-address":/^[^]+/}},"ipv4-address":/^(?:(?:[03-9]\d?|[12]\d{0,2})\.){3}(?:[03-9]\d?|[12]\d{0,2})$/}}}},path:{pattern:/^[\w.~!$&'()*,;=%:@/+-]+/m,inside:{"path-separator":/\//}}}}});var isBracketPair,openBracket,testBracketPair,clikeComment,bracketIndenting,init_index_CHhGi2gg=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/index-CHhGi2gg.js"(){init_utils();isBracketPair=/\[]|\(\)|{}/,openBracket=/[([{][^)\]}]*$/,testBracketPair=([start,end],value)=>isBracketPair.test(value[start-1]+value[end]),clikeComment={line:"//",block:["/*","*/"]},bracketIndenting=(comments=clikeComment,indentPattern=openBracket)=>({comments,autoIndent:[([start],value)=>indentPattern.test(getLineBefore(value,start)),testBracketPair]})}});var init_css2=__esm({"node_modules/.deno/prism-code-editor@3.4.0/node_modules/prism-code-editor/dist/languages/css.js"(){init_index_BltwYS88();init_index_CHhGi2gg();languageMap.css=bracketIndenting({block:["/*","*/"]});languageMap.less=languageMap.scss=bracketIndenting();languageMap.sass={comments:clikeComment}}});var csseditor_exports={};__export(csseditor_exports,{createBackgroundUrlsEditor:()=>createBackgroundUrlsEditor,createCssEditor:()=>createCssEditor});function createCssEditor(options){return createEditor("#css-editor",options,defaultCommands())}function createBackgroundUrlsEditor(options){return createEditor("#background-urls-editor",options,defaultCommands())}var init_csseditor=__esm({"src/scripts/features/csseditor.ts"(){init_dist();init_commands();init_css_extras();init_uri();init_css2()}});var langList={en:"English",fr:"Fran\xE7ais",de:"Deutsch",it:"Italiano",es:"Espa\xF1ol",ca:"Catal\xE0","pt-BR":"Portugu\xEAs (Brasil)","pt-PT":"Portugu\xEAs (Portugal)",nl:"Nederlands",da:"Dansk",sv:"Svenska",nb:"Norsk",is:"\xCDslenska",fi:"suomi",pl:"Polski",cs:"\u010Ce\u0161tina",hr:"Hrvatski",sk:"Slovensk\xFD",hu:"Magyar",ro:"Rom\xE2n\u0103",el:"\u0395\u03BB\u03BB\u03B7\u03BD\u03B9\u03BA\u03AC",sr:"\u0421\u0440\u043F\u0441\u043A\u0438 (\u045B\u0438\u0440\u0438\u043B\u0438\u0446\u0430)","sr-YU":"Srpski (latinica)",be:"\u0411\u0435\u043B\u0430\u0440\u0443\u0441\u043A\u0430\u044F",uk:"\u0423\u043A\u0440\u0430\u0457\u043D\u0441\u044C\u043A\u0430",ru:"\u0420\u0443\u0441\u0441\u043A\u0438\u0439",tr:"T\xFCrk\xE7e",he:"\u05E2\u05B4\u05D1\u05E8\u05B4\u05D9\u05EA",hy:"\u0540\u0561\u0575\u0565\u0580\u0565\u0576",ar:"\u0627\u0644\u0639\u0631\u0628\u064A\u0629",az:"Az\u0259rbaycan",fa:"\u0641\u0627\u0631\u0633\u06CC",te:"\u0C24\u0C46\u0C32\u0C41\u0C17\u0C41",id:"Indonesia",vi:"Ti\u1EBFng Vi\u1EC7t","zh-CN":"\u4E2D\u56FD\u7B80\u4F53\u4E2D\u6587","zh-HK":"\u9999\u6E2F\u7E41\u9AD4\u4E2D\u6587","zh-TW":"\u81FA\u7063\u6B63\u9AD4\u4E2D\u6587","nan-Hant-TW":"\u81FA\u7063\u53F0\u8A9E\uFF08\u6F22\u7F85\uFF09",ko:"\uD55C\uAD6D\uC5B4",ja:"\u65E5\u672C\u8A9E"},subsets={el:"greek",ar:"arabic",fa:"arabic",ru:"cyrillic",uk:"cyrillic",sr:"cyrillic",be:"cyrillic",sk:"latin-ext",nb:"latin-ext",is:"latin-ext",hr:"latin-ext",cs:"latin-ext",pl:"latin-ext",ro:"latin-ext",tr:"latin-ext",hu:"latin-ext",vi:"latin-ext",az:"latin-ext",ja:"japanese",hy:"armenian",te:"telugu",he:"hebrew","zh-CN":"chinese-simplified","zh-HK":"chinese-traditional","zh-TW":"chinese-traditional","nan-Hant-TW":"chinese-traditional",ko:"korean"};var navigator2=globalThis.navigator,iosUA="iPad Simulator|iPhone Simulator|iPod Simulator|iPad|iPhone|iPod".split("|"),mobileUA="Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini".split("|"),CURRENT_VERSION="21.1.0",API_DOMAIN="https://services.bonjourr.fr",ENVIRONNEMENT=globalThis.ENV??"TEST",SYSTEM_OS=iosUA.includes(navigator2.platform)||navigator2.userAgent?.includes("Mac")&&"ontouchend"in document?"ios":navigator2.appVersion?.includes("Macintosh")?"mac":navigator2.appVersion?.includes("Windows")?"windows":navigator2.userAgent?.toLowerCase()?.includes("android")?"android":"unknown",PLATFORM=globalThis.location?.protocol==="moz-extension:"?"firefox":globalThis.location?.protocol==="chrome-extension:"?"chrome":globalThis.location?.protocol==="safari-web-extension:"?"safari":"online",BROWSER=navigator2?.userAgentData?.brands.some(b=>b.brand==="Microsoft Edge")?"edge":navigator2?.userAgentData?.brands.some(b=>b.brand==="Opera")?"opera":navigator2?.userAgentData?.brands.some(b=>b.brand==="Chromium")?"chrome":navigator2.userAgent?.toLowerCase()?.indexOf("firefox")>-1?"firefox":navigator2.userAgent?.toLowerCase()?.indexOf("safari")>-1?"safari":"other",EXTENSION=PLATFORM==="online"?void 0:PLATFORM==="firefox"?browser:chrome,IS_MOBILE=navigator2.userAgentData?navigator2.userAgentData.mobile:mobileUA.some(ua=>navigator2.userAgent.includes(ua)),DEFAULT_LANG=(()=>{for(let code of Object.keys(langList))if(navigator2.language.replace("-","_").includes(code))return code;return"en"})(),SEARCHBAR_ENGINES=["default","google","ddg","startpage","qwant","yahoo","bing","brave","ecosia","lilo","baidu","custom"],SYNC_DEFAULT={about:{browser:PLATFORM,version:CURRENT_VERSION},showall:!1,lang:DEFAULT_LANG,dark:"system",favicon:"",tabtitle:"",greeting:"",pagegap:1,pagewidth:1600,time:!0,main:!0,dateformat:"auto",quicklinks:!0,textShadow:.2,announcements:"major",review:0,css:"",hide:{},linkstyle:"medium",linktitles:!0,linkbackgrounds:!0,linknewtab:!1,linksrow:6,linkgroups:{on:!1,selected:"default",groups:["default"],pinned:[],synced:[]},backgrounds:{type:"images",fadein:600,blur:15,bright:.8,frequency:"hour",color:"#185A63",urls:"",images:"bonjourr-images-daylight",videos:"bonjourr-videos-daylight",queries:{},texture:{type:"none"}},clock:{size:1,ampm:!1,analog:!1,seconds:!1,ampmlabel:!1,worldclocks:!1,timezone:"auto"},analogstyle:{face:"none",hands:"modern",shape:"round",border:"#ffff",background:"#fff2"},worldclocks:[],weather:{city:void 0,unit:"metric",provider:"",moreinfo:"none",forecast:"auto",temperature:"actual",geolocation:"approximate"},notes:{on:!1,width:40,opacity:.1,align:"left"},searchbar:{on:!1,opacity:.1,newtab:!1,suggestions:!0,engine:"default",request:"",placeholder:""},quotes:{on:!1,author:!1,type:DEFAULT_LANG==="zh-CN"?"hitokoto":"classic",frequency:"day",last:void 0},font:{family:"",size:"14",system:!0,weightlist:[],weight:SYSTEM_OS==="windows"?"400":"300"},supporters:{enabled:!0,closed:!1,month:new Date().getMonth()+1},move:{selection:"single",layouts:{}}},LOCAL_DEFAULT={syncType:PLATFORM==="online"?"off":"browser",gistToken:"",userQuoteSelection:0,translations:void 0,quotesCache:[],backgroundUrls:{},backgroundFiles:{},backgroundCollections:{},backgroundCompressFiles:!0,backgroundLastChange:"",lastWeather:void 0};var sunrise=420,sunset=1320,dusk=60,userSetDate;function userDate(timezone="auto"){let date=new Date;if(timezone==="auto"&&userSetDate)return userSetDate;if(timezone==="auto")return date;try{let intl=new Intl.DateTimeFormat("en",{timeZone:timezone,dateStyle:"medium",timeStyle:"medium"});return userSetDate=new Date(intl.format(date)),userSetDate}catch(e){console.warn(e),console.info("Your timezone is not valid")}return date}function daylightPeriod(time){let mins=minutator(time?new Date(time):new Date);return mins>=0&&mins<=sunrise-60?"night":mins<=sunrise+60?"noon":mins<=sunset-60?"day":mins<=sunset+60?"evening":mins>=sunset+60?"night":"day"}function suntime(rise,set){return rise&&set&&(sunrise=minutator(new Date(rise)),sunset=minutator(new Date(set))),dusk=100-(60*24-sunset)/8,{sunrise,sunset,dusk}}function needsChange(every,last){let nowDate=userDate(),lastDate=last!==void 0?new Date(last):nowDate,changed={date:nowDate.getDate()!==lastDate.getDate(),hour:nowDate.getHours()!==lastDate.getHours()};switch(every){case"day":return changed.date;case"hour":return changed.date||changed.hour;case"tabs":return!0;case"pause":return last===0;case"period":return last===0?!0:daylightPeriod()!==daylightPeriod(+lastDate);default:return!1}}function minutator(date){return date.getHours()*60+date.getMinutes()}function stringMaxSize(str,size){return str.length>size?str.slice(0,size):str}function randomString(len){let chars="abcdefghijklmnopqr";return Array.from({length:len},()=>chars[Math.floor(Math.random()*chars.length)]).join("")}function equalsCaseInsensitive(a,b){return a.localeCompare(b,void 0,{sensitivity:"accent"})===0}function opacityFromHex(hex){return Number.parseInt(hex.slice(4),16)}function rgbToHex(r,g,b){return`#${componentToHex(r)}${componentToHex(g)}${componentToHex(b)}`}function hexToRGB(hex){let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return{r,g,b}}function hexToHSL(hex){if(hex=hex.replace(/^#/,""),hex.length===3&&(hex=hex.split("").map(c=>c+c).join("")),hex.length!==6)throw new Error("Invalid HEX color.");let r=parseInt(hex.substring(0,2),16)/255,g=parseInt(hex.substring(2,4),16)/255,b=parseInt(hex.substring(4,6),16)/255,max=Math.max(r,g,b),min=Math.min(r,g,b),delta=max-min,h=0,s=0,l=(max+min)/2;if(delta!==0){switch(s=delta/(1-Math.abs(2*l-1)),max){case r:h=(g-b)/delta+(g<b?6:0);break;case g:h=(b-r)/delta+2;break;case b:h=(r-g)/delta+4;break}h*=60}return{h:Math.round(h),s:Math.round(s*100),l:Math.round(l*100)}}function getReadableTextColor(bgColor){return Math.round((bgColor.r*299+bgColor.g*587+bgColor.b*114)/1e3)<150?"white":"black"}function componentToHex(c){let hex=c.toString(16);return hex.length===1?"0hex":hex}function deepEqual(object1,object2){function isObject2(object){return object!==null&&typeof object=="object"}let keys1=Object.keys(object1),keys2=Object.keys(object2);if(keys1.length!==keys2.length)return!1;for(let key of keys1){let val1=object1[key],val2=object2[key],areObjects=isObject2(val1)&&isObject2(val2);if(areObjects&&!deepEqual(val1,val2)||!areObjects&&val1!==val2)return!1}return!0}function parse(str=""){try{return JSON.parse(str)}catch{str!==""&&console.info("Cannot parse")}}function promisifyRequest(request){return new Promise((resolve2,reject)=>{request.oncomplete=request.onsuccess=()=>resolve2(request.result),request.onabort=request.onerror=()=>reject(request.error)})}function createStore(dbName,storeName){let request=indexedDB.open(dbName);request.onupgradeneeded=()=>request.result.createObjectStore(storeName);let dbp=promisifyRequest(request);return(txMode,callback)=>dbp.then(db=>callback(db.transaction(storeName,txMode).objectStore(storeName)))}var defaultGetStoreFunc;function defaultGetStore(){return defaultGetStoreFunc||(defaultGetStoreFunc=createStore("keyval-store","keyval")),defaultGetStoreFunc}function clear(customStore=defaultGetStore()){return customStore("readwrite",store=>(store.clear(),promisifyRequest(store.transaction)))}function eachCursor(store,callback){return store.openCursor().onsuccess=function(){this.result&&(callback(this.result),this.result.continue())},promisifyRequest(store.transaction)}function entries(customStore=defaultGetStore()){return customStore("readonly",store=>{if(store.getAll&&store.getAllKeys)return Promise.all([promisifyRequest(store.getAllKeys()),promisifyRequest(store.getAll())]).then(([keys,values])=>keys.map((key,i)=>[key,values[i]]));let items=[];return customStore("readonly",store2=>eachCursor(store2,cursor=>items.push([cursor.key,cursor.value])).then(()=>items))})}var storage={sync:{get:syncGet,set:syncSet,remove:syncRemove,clear:syncClear},local:{get:localGet,set:localSet,remove:localRemove,clear:localClear},init,clearall,type:storageTypeFn()};function storageTypeFn(){let type="webext-sync";function get(){return type}function init2(){return globalThis.chrome?.storage===void 0?(type="localstorage","localstorage"):globalThis.startupStorage?.local?.syncStorage?(type="webext-local","webext-local"):type}function change(type2,data){globalThis.chrome?.storage!==void 0&&(type2==="local"&&chrome.storage.local.set({syncStorage:data}),type2==="sync"&&chrome.storage.local.remove("syncStorage").then(()=>{chrome.storage.sync.set(data)}))}return{init:init2,get,change}}async function syncGet(key){switch(storage.type.get()){case"webext-sync":{let data=await chrome.storage.sync.get(key??null);return verifyDataAsSync(data)}case"webext-local":{let data=(await chrome.storage.local.get("syncStorage")).syncStorage;return verifyDataAsSync(data)}default:return verifyDataAsSync(parse(localStorage.bonjourr)??{})}}async function syncSet(keyval,fn=()=>{}){switch(storage.type.get()){case"webext-sync":{chrome.storage.sync.set(keyval,fn);return}case"webext-local":{let data={...(await chrome.storage.local.get("syncStorage")).syncStorage,...keyval};chrome.storage.local.set({syncStorage:data},fn);return}case"localstorage":{if(typeof keyval!="object")return;let data=verifyDataAsSync(parse(localStorage.bonjourr)??{});for(let[k,v]of Object.entries(keyval))data[k]=v;localStorage.bonjourr=JSON.stringify(data??{}),globalThis.dispatchEvent(new Event("storage"));return}default:}}async function syncRemove(key){switch(storage.type.get()){case"webext-sync":{chrome.storage.sync.remove(key);return}case"webext-local":{let data=(await chrome.storage.local.get("syncStorage")).syncStorage;await chrome.storage.local.remove("syncStorage"),delete data[key],chrome.storage.local.set({syncStorage:data});return}case"localstorage":{localStorage.removeItem(key);return}default:}}async function syncClear(){switch(storage.type.get()){case"webext-sync":{await chrome.storage.sync.clear();return}case"webext-local":{await chrome.storage.local.remove("syncStorage");return}case"localstorage":{localStorage.removeItem("bonjourr");return}default:}}function localSet(value){switch(storage.type.get()){case"webext-sync":case"webext-local":{chrome.storage.local.set(value);return}default:{for(let[key,val]of Object.entries(value))typeof val=="string"?localStorage.setItem(key,val):localStorage.setItem(key,JSON.stringify(val));return}}}async function localGet(keys){switch(storage.type.get()){case"webext-sync":case"webext-local":return await chrome.storage.local.get(keys);default:{let result=structuredClone(LOCAL_DEFAULT);keys===void 0&&(keys=Object.keys(LOCAL_DEFAULT)),typeof keys=="string"&&(keys=[keys]);let localKeys=Object.keys(globalThis.localStorage),neededKeys=keys.filter(k=>localKeys.includes(k));for(let key of neededKeys){let item=globalThis.localStorage.getItem(key),isJson=item&&(item.startsWith("{")||item.startsWith("[")),isBool=item&&(item==="true"||item==="false"),isNoom=item&&Number.isNaN(Number(item))===!1;isJson?result[key]=parse(item):isBool?result[key]=item==="true":isNoom?result[key]=Number.parseFloat(item):result[key]=item}return result}}}function localRemove(key){switch(storage.type.get()){case"webext-sync":case"webext-local":return chrome.storage.local.remove(key);case"localstorage":{localStorage.removeItem(key);return}default:}}async function localClear(){switch(storage.type.get()){case"webext-sync":{chrome.storage.local.clear();return}case"webext-local":{let sync=(await chrome.storage.local.get("syncStorage")).syncStorage;await chrome.storage.local.clear(),await chrome.storage.local.set({syncStorage:sync});return}case"localstorage":{for(let key of Object.keys(LOCAL_DEFAULT))localStorage.removeItem(key);return}default:}}async function init(){let store=globalThis.startupStorage??{};switch(PLATFORM!=="online"&&!webextStoreReady()&&(globalThis.pageReady=!0,await new Promise(resolve2=>{document.addEventListener("webextstorage",event=>{event.detail==="sync"&&(store.sync=globalThis.startupStorage.sync),event.detail==="local"&&(store.local=globalThis.startupStorage.local),webextStoreReady()&&resolve2(!0)})})),storage.type.init()){case"webext-local":{store.sync=globalThis.startupStorage.local?.syncStorage,store.local=globalThis.startupStorage.local;break}case"webext-sync":{store.sync=globalThis.startupStorage.sync,store.local=globalThis.startupStorage.local;break}case"localstorage":{store.sync=await syncGet(),store.local=await localGet();break}default:}Object.keys(store.sync??{})?.length===0&&(store.sync=await getSyncDefaults());let sync=verifyDataAsSync(store.sync),local=verifyDataAsLocal(store.local);return{sync,local};function webextStoreReady(){return!!store.sync&&!!store.local}}async function clearall(){sessionStorage.clear(),localStorage.clear();try{clear()}catch{console.info("You are on Firefox Private Browsing");return}try{globalThis.caches.delete("local-files")}catch(err){console.warn(err)}switch(globalThis.startupStorage=void 0,storage.type.get()){case"webext-sync":{await chrome.storage.sync.clear(),await chrome.storage.local.clear(),chrome.storage.sync.set(SYNC_DEFAULT),chrome.storage.local.set(LOCAL_DEFAULT);return}case"webext-local":{await chrome.storage.sync.clear(),await chrome.storage.local.clear(),chrome.storage.local.set({...LOCAL_DEFAULT,syncStorage:SYNC_DEFAULT});return}default:}}async function getSyncDefaults(){try{let json=await(await fetch("config.json")).json();return verifyDataAsSync(json)}catch{}return SYNC_DEFAULT}function isStorageDefault(data){let current=structuredClone(data);return current.review=SYNC_DEFAULT.review,current.showall=SYNC_DEFAULT.showall,current.weather.city=SYNC_DEFAULT.weather.city,current.quotes.last=SYNC_DEFAULT.quotes.last,deepEqual(current,SYNC_DEFAULT)}function verifyDataAsSync(data={}){return{...SYNC_DEFAULT,...data}}function verifyDataAsLocal(data={}){return{...LOCAL_DEFAULT,...data}}function debounce(callback,waitFor){let timeout,debounced=(...args)=>{clearTimeout(timeout),timeout=setTimeout(()=>callback(...args),waitFor)};return debounced.cancel=()=>clearTimeout(timeout),debounced}var eventDebounce=debounce(value=>{storage.sync.set(value)},400);var trns,currentTrnsLang="en";async function setTranslationCache(language,local){let lang=countryCodeToLanguageCode(language);if(lang==="en"){storage.local.remove("translations"),trns=void 0;return}let cachedLang=local?.translations?.lang;local&&cachedLang===lang?trns=local.translations:(trns=await(await fetch(`../../_locales/${lang}/translations.json`)).json(),storage.local.set({translations:trns})),currentTrnsLang=lang}function traduction(scope,lang="en"){if(lang!=="en"){if(trns){let tags=(scope??document.body).querySelectorAll(".trn"),text;for(let tag of tags)text=tag.textContent?.trim()??"",tag.textContent=trns[text]??text}document.documentElement.setAttribute("lang",lang),currentTrnsLang=lang}}async function toggleTraduction(lang){let tags=document.querySelectorAll(".trn"),toggleDict={},currentDict={...trns},text;await setTranslationCache(lang);let newDict=(await storage.local.get("translations")).translations;if(newDict&&currentDict?.lang===void 0)for(let key of Object.keys(newDict))currentDict[key]=key;for(let[key,val]of Object.entries(currentDict))lang==="en"?toggleDict[val]=key:newDict&&(toggleDict[val]=newDict[key]);for(let tag of tags)text=tag.textContent??"",tag.textContent=toggleDict[text]??text;currentTrnsLang=lang}function getLang(){return currentTrnsLang}function tradThis(str){return trns?trns[str]??str:str}function countryCodeToLanguageCode(lang){let sanitizedLang=lang;return lang.includes("ES")&&(sanitizedLang="es"),lang==="gr"&&(sanitizedLang="el"),lang==="jp"&&(sanitizedLang="ja"),lang==="cz"&&(sanitizedLang="cs"),sanitizedLang=sanitizedLang.replace("_","-"),sanitizedLang}function favicon(val,isEvent){function createFavicon(emoji){let svg=`data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="85">${emoji}</text></svg>`,defaulticon=`/src/assets/${BROWSER==="edge"?"monochrome.png":"favicon.ico"}`,domfavicon=document.getElementById("favicon");domfavicon.href=emoji?svg:defaulticon}if(isEvent){let isEmojiOrShape=val?.match(/[\p{Emoji}\u25A0-\u25FF]/gu)&&!val?.match(/[0-9a-z]/g);eventDebounce({favicon:isEmojiOrShape?val:""}),document.getElementById("head-favicon")?.remove()}BROWSER==="firefox"?setTimeout(()=>createFavicon(val),0):createFavicon(val)}function tabTitle(val,isEvent){val??="",document.title=stringMaxSize(val,80)||tradThis("New tab"),isEvent&&eventDebounce({tabtitle:stringMaxSize(val,80)})}function pageControl(val,isEvent){if(val.width){let property=`${val.width??SYNC_DEFAULT.pagewidth}px`;document.documentElement.style.setProperty("--page-width",property),isEvent&&eventDebounce({pagewidth:val.width})}if(typeof val.gap=="number"){let property=`${val.gap??SYNC_DEFAULT.pagegap}em`;document.documentElement.style.setProperty("--page-gap",property),isEvent&&eventDebounce({pagegap:val.gap})}}function darkmode(value,isEvent){let settings=document.querySelector("aside"),theme="light";switch(value){case"disable":theme="light";break;case"enable":theme="dark";break;case"system":theme=globalThis.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";break;default:{let now=minutator(new Date),{sunrise:sunrise2,sunset:sunset2}=suntime();theme=now<=sunrise2||now>sunset2?"dark":"light"}}if(document.documentElement.dataset.theme=theme,isEvent){storage.sync.set({dark:value}),settings?.classList.add("change-theme"),setTimeout(()=>settings?.classList.remove("change-theme"),333);return}globalThis.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",event=>{document.documentElement.dataset.theme=event.matches?"dark":"light"})}function textShadow(init2,event){let val=init2??event;document.documentElement.style.setProperty("--text-shadow-alpha",(val??.2)?.toString()),typeof event=="number"&&eventDebounce({textShadow:val})}var callbackList=[],areSettingsLoaded=!1;function onSettingsLoad(callback){areSettingsLoaded?callback():callbackList.push(callback)}function loadCallbacks(){for(let callback of callbackList)callback();areSettingsLoaded=!0}var import_mod=__toESM(require_dist());var monthBackgrounds=["https://images.unsplash.com/photo-1457269449834-928af64c684d?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1613136391099-c2757009bb12?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1457670912047-6ad4485d43eb?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1528834342297-fdefb9a5a92b?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1486608766848-9b9fe0c37b9d?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1551516114-063f4cef7213?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1577353716826-9151912dcdd1?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1600699260196-aca47e6d2125?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1508255139162-e1f7b7288ab7?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1507834392452-0559ec185662?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1505567745926-ba89000d255a?q=80&w=700&auto=format&fit=crop","https://images.unsplash.com/photo-1513267257196-91be473829b3?q=80&w=700&auto=format&fit=crop"],modalDataLoaded=!1;function supportersNotifications(init2,update){if(update?.translate){translateNotif();return}if(update){updateSupportersOption(update);return}canShowSupporters(init2)&&(updateSupportersOption({closed:!1,month:!0}),onSettingsLoad(()=>{initSupportersModal()}),document.documentElement.dataset.supporters="")}function canShowSupporters(sync){if(!sync?.supporters||!sync.supporters.enabled)return!1;let closed=sync?.supporters.closed,month=sync?.supporters.month,hasClosedReview=sync?.review===-1,closedThisMonth=new Date().getMonth()+1===month&&closed;return hasClosedReview&&!closed&&!closedThisMonth}function initSupportersSettingsNotif(sync){if(!canShowSupporters(sync))return;let settingsNotifs=document.getElementById("supporters-notif-container"),settingsNotifContent=document.getElementById("supporters-notif-content"),notifClose=document.getElementById("supporters-notif-close"),image=monthBackgrounds[sync.supporters.month-1];settingsNotifs?.classList.add("shown"),settingsNotifs?.style.setProperty("--background",`url(${image})`),translateNotif(),(0,import_mod.onclickdown)(settingsNotifContent,()=>{toggleSupportersModal(!0),loadModalData()}),(0,import_mod.onclickdown)(notifClose,()=>{delete document.documentElement.dataset.supporters,settingsNotifs?.classList.remove("shown"),updateSupportersOption({closed:!0})})}async function updateSupportersOption(update){let data=await storage.sync.get();update.enabled!==void 0&&(data.supporters.enabled=update.enabled),update.closed!==void 0&&(data.supporters.closed=update.closed),update.month!==void 0&&(data.supporters.month=new Date().getMonth()+1),storage.sync.set({supporters:data.supporters})}function translateNotif(){let currentMonthLocale=new Date().toLocaleDateString(getLang(),{month:"long"}),introString="This <currentMonth>, Bonjourr is brought to you by our lovely supporters.",notifTitle=document.getElementById("supporters-notif-title"),notifButton=document.getElementById("supporters-notif-button");notifTitle&&notifButton&&(notifTitle.textContent=tradThis(introString).replace("<currentMonth>",currentMonthLocale),notifButton.textContent=tradThis("Find out who they are"))}function initSupportersModal(){let template=document.getElementById("supporters-modal-template"),doc=document.importNode(template.content,!0),supportersModal=doc.getElementById("supporters-modal-container");tradTemplateString(doc,"header h2 span","Supporters like you make Bonjourr possible"),tradTemplateString(doc,"header p","Here are the wonderful people who supported us last month. Thanks to them, we can keep Bonjourr free, open source, and constantly evolving."),tradTemplateString(doc,"#supporters-monthly h3","Our monthly supporters"),tradTemplateString(doc,"#supporters-once h3","Our one-time supporters"),tradTemplateString(doc,"footer p","Join the community and get your name in Bonjourr."),tradTemplateString(doc,"footer a span","Donate");let close=doc.getElementById("supporters-modal-close");document.querySelector("#interface")?.insertAdjacentElement("beforebegin",supportersModal),close.addEventListener("click",()=>{toggleSupportersModal(!1)}),supportersModal.addEventListener("click",event=>{event.target?.id==="supporters-modal-container"&&toggleSupportersModal(!1)}),document.addEventListener("keyup",event=>{let hasDataset=document.documentElement.dataset.supportersModal!==void 0;event.key==="Escape"&&hasDataset&&toggleSupportersModal(!1)})}function toggleSupportersModal(toggle){document.dispatchEvent(new Event("toggle-settings")),toggle?document.documentElement.dataset.supportersModal="":delete document.documentElement.dataset.supportersModal}async function loadModalData(){if(modalDataLoaded)return;document.body.className.includes("potato")||initGlitter();let currentMonth=new Date().getMonth()+1,currentYear=new Date().getFullYear(),isJanuary=currentMonth===1,monthToGet,yearToGet=currentYear;isJanuary?(monthToGet=12,yearToGet-=1):monthToGet=currentMonth-1;let modal=document.querySelector("#supporters-modal"),main=document.querySelector("#supporters-modal main"),monthly=document.querySelector("#supporters-monthly ul"),once=document.querySelector("#supporters-once ul");try{let url=`https://kofi.bonjourr.fr/list?date=${yearToGet}-${monthToGet}`,supporters=await(await fetch(url))?.json();if(supporters.length>0){supporters.sort((a,b)=>b.amount-a.amount);for(let supporter of supporters){let parent=supporter.monthly?monthly:once,li=`<li>${supporter.name}</li>`;parent?.insertAdjacentHTML("beforeend",li)}modal?.classList.add("loaded")}}catch{main&&(main.innerHTML="<i>An error occured or we might be offline!</i>")}modalDataLoaded=!0}function tradTemplateString(doc,selector,text){let toTranslate=doc.querySelector(selector);toTranslate&&(toTranslate.innerText=tradThis(text))}function initGlitter(){let snowfall={};snowfall.canvas=document.getElementById("glitter"),snowfall.context=snowfall.canvas.getContext("2d"),snowfall.snowflake=class{size;x;baseX;distance;opacity;radians;fallSpeed;y;constructor(){this.size=Math.random()*1.5+1.5,this.x=Math.random()*snowfall.canvas.width-this.size-1+this.size+1,this.baseX=this.x,this.distance=Math.random()*50+1,this.opacity=Math.random(),this.radians=Math.random()*Math.PI*2,this.fallSpeed=Math.random()*1.5+.5,this.y=Math.random()*snowfall.canvas.height-this.size-1+this.size+1}draw=()=>{this.y>snowfall.canvas.height+this.size?this.y=-this.size:this.y+=this.fallSpeed,this.radians+=.02,this.x=this.baseX+this.distance*Math.sin(this.radians),snowfall.context.beginPath(),snowfall.context.arc(this.x,this.y,this.size,0,Math.PI*2),snowfall.context.shadowBlur=8,snowfall.context.shadowColor=`rgba(255, 202, 56, ${this.opacity})`,snowfall.context.fillStyle=`rgba(255, 202, 56, ${this.opacity})`,snowfall.context.fill(),snowfall.context.closePath(),snowfall.context.shadowBlur=0,snowfall.context.shadowColor="transparent"}},snowfall.setup=()=>{snowfall.canvas.width=snowfall.context.canvas.clientWidth,snowfall.canvas.height=snowfall.context.canvas.clientHeight,snowfall.flakes=[];for(let x=0;x<Math.ceil(snowfall.canvas.width*snowfall.canvas.height/2e4);x++)snowfall.flakes.push(new snowfall.snowflake)};let snowfallDebounce=debounce(snowfall.setup,200);globalThis.addEventListener("resize",snowfallDebounce),snowfall.animate=()=>{requestAnimationFrame(snowfall.animate),snowfall.context.clearRect(0,0,snowfall.canvas.width,snowfall.canvas.height);for(let snowflake of snowfall.flakes)snowflake.draw()},snowfall.setup(),snowfall.animate()}async function setGistStatus(token,id){let wrapper=document.getElementById("gist-sync-status-wrapper"),base=document.getElementById("gist-sync-status-base");if(!token)return document.querySelector("#gist-sync-status")?.remove(),base.textContent=tradThis("Waiting for authentification"),!1;if(!id)return document.querySelector("#gist-sync-status")?.remove(),base.textContent=tradThis("No saved data yet"),!1;let resp=await fetch(`https://api.github.com/gists/${id}`,{headers:gistHeaders(token)});if(resp.status!==200)return document.querySelector("#gist-sync-status")?.remove(),base.textContent=tradThis("No saved data yet"),!1;let json=await resp.json(),isoDate=json.updated_at,dateString=new Date(isoDate).toLocaleString(getLang(),{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"});document.querySelector("#gist-sync-status")?.remove();let link=document.createElement("a");return link.id="gist-sync-status",link.href=json.html_url,link.textContent=dateString,wrapper?.appendChild(link),base.textContent=tradThis("Last update"),!0}async function retrieveGist(token,id){if(!token)throw new Error(GIST_ERROR.TOKEN);if(!id)throw new Error(GIST_ERROR.ID);let req=await fetch(`https://api.github.com/gists/${id}`,{headers:gistHeaders(token)});if(req.status===200){let gist=await req.json(),content=Object.values(gist?.files??{})[0]?.content??"";try{return JSON.parse(content)}catch{throw new Error(GIST_ERROR.JSON)}}throw new Error(GIST_ERROR.OTHER)}async function sendGist(token,id,data){let description="File automatically generated by Bonjourr. Learn more on https://bonjourr.fr/docs/overview/#sync",files={"bonjourr-export.json":{content:JSON.stringify(data,void 0,2)}};if(isStorageDefault(data))throw new Error(GIST_ERROR.DEFAULT);if(id===void 0){let resp2=await fetch("https://api.github.com/gists",{body:JSON.stringify({files,description,public:!1}),headers:gistHeaders(token),method:"POST"});if(resp2.status===401)throw new Error(GIST_ERROR.TOKEN);if(resp2.status>=300)throw new Error(GIST_ERROR.OTHER);return(await resp2.json()).id}if(isGistIdValid(id)===!1)throw new Error(GIST_ERROR.ID);let resp=await fetch(`https://api.github.com/gists/${id}`,{body:JSON.stringify({files,description}),headers:gistHeaders(token),method:"PATCH"});if(resp.status===404)throw new Error(GIST_ERROR.NOGIST);if(resp.status===401)throw new Error(GIST_ERROR.TOKEN);if(resp.status>=300)throw new Error(GIST_ERROR.OTHER);return id}async function findGistId(token){if(!token)throw new Error(GIST_ERROR.TOKEN);let resp=await fetch("https://api.github.com/gists?per_page=100",{headers:gistHeaders(token)});if(resp.status===401)throw new Error(GIST_ERROR.TOKEN);if(resp.status>=300)throw new Error(GIST_ERROR.OTHER);return(await resp.json()).filter(gist=>!gist.public&&gist.files["bonjourr-export.json"]?.size>0)[0]?.id}async function isGistTokenValid(token=""){if(!token)return!1;try{let isoDate=new Date()?.toISOString();return(await fetch(`https://api.github.com/gists?since=${isoDate}`,{headers:gistHeaders(token)})).status===200}catch{return!1}}function isGistIdValid(id){if(!id||id.length>32)return!1;for(let char of id){let code=char.charCodeAt(0);if(!(code>=97&&code<=102||code>=48&&code<=57))return!1}return!0}function gistHeaders(token){return{Authorization:`Bearer ${token}`,Accept:"application/vnd.github+json","X-GitHub-Api-Version":"2022-11-28"}}var GIST_ERROR={ID:tradThis("Invalid Gist ID in settings."),TOKEN:tradThis("Invalid token."),NOGIST:tradThis("Bonjourr file not found in Gists."),NOCONN:tradThis("Cannot connect to GitHub."),JSON:tradThis("Invalid JSON response from GitHub."),OTHER:tradThis("Unexpected GitHub Gist error."),DEFAULT:tradThis("Tried to send default config.")};async function receiveFromURL(url=""){let resp;try{new URL(url)}catch{throw new Error(DISTANT_ERROR.URL)}try{resp=await fetch(url)}catch{try{resp=await fetch("https://services.bonjourr.fr/proxy",{method:"POST",body:url})}catch{throw new Error(DISTANT_ERROR.PROXY)}}try{return JSON.parse(await resp.text())}catch{throw new Error(DISTANT_ERROR.JSON)}}async function isDistantUrlValid(url=""){try{return await receiveFromURL(url),!0}catch{return!1}}var DISTANT_ERROR={URL:tradThis("Not a valid URL"),FAIL:tradThis("Cannot access resource right now"),PROXY:tradThis("Cannot access resource, even with proxy"),JSON:tradThis("Response is not valid JSON")};function networkForm(targetId2){let form,button,message,loadTimeout=0;onSettingsLoad(()=>{form=document.getElementById(targetId2),button=form?.querySelector("button:last-of-type"),message=form?.querySelector("small");for(let input of form.querySelectorAll("input"))input?.addEventListener("input",()=>{let isSame=input.getAttribute("placeholder")===input.value,isEmpty=input.value==="",isValid=form.checkValidity();form.classList.toggle("valid",isValid),form.classList.toggle("remove",isValid&&(isSame||isEmpty))});form?.addEventListener("input",()=>{form.classList.contains("warn")&&(form.classList.remove("warn"),button.removeAttribute("disabled"))})});function reset(){form.classList.remove("load","warn","valid","remove"),button.removeAttribute("disabled"),clearTimeout(loadTimeout)}function load(){loadTimeout=setTimeout(()=>{form.classList.remove("warn"),form.classList.add("valid","load"),button.setAttribute("disabled","disabled")},50)}function warn(err){form.classList.add("warn"),form.classList.remove("load"),button.setAttribute("disabled",""),message.textContent=err,clearTimeout(loadTimeout)}function accept(inputId,value){if(inputId&&form.checkValidity()){form.classList.remove("valid");let input=document.getElementById(inputId);input&&value&&input.setAttribute("placeholder",value)}clearTimeout(loadTimeout),setTimeout(()=>reset(),200)}return{load,warn,reset,accept}}function toggleDisabled(element,force){element&&((force!==void 0?force:typeof element.getAttribute("disabled")=="string")?element.setAttribute("disabled",""):element.removeAttribute("disabled"))}function getSplitRangeData(id){let wrapper=document.querySelector(`#${id.replace("#","")}`),range=wrapper?.querySelector("input"),button=wrapper?.querySelector("button"),span=wrapper?.querySelectorAll("span"),isButtonOn=button?.classList?.contains("on");return{range:range?.value,button:span?.[isButtonOn?1:0].dataset.value}}function getHTMLTemplate(id,selector){return document.getElementById(id)?.content.cloneNode(!0)?.querySelector(selector)}function getComposedPath(target){if(!target)return[];let path=[],node=target;for(;node;)path.push(node),node=node.parentElement;return path}function turnRefreshButton(event,canTurn){let target=event.target;target.tagName==="path"&&target.parentElement&&(target=target.parentElement),target.tagName!=="svg"&&target.firstElementChild&&(target=target.firstElementChild),target.tagName!=="svg"&&target.firstElementChild&&(target=target.firstElementChild),target?.animate(canTurn?[{transform:"rotate(360deg)"}]:[{transform:"rotate(0deg)"},{transform:"rotate(90deg)"},{transform:"rotate(0deg)"}],{duration:600,easing:"ease-out"})}function fadeOut(){let dominterface3=document.getElementById("interface");dominterface3.click(),dominterface3.style.transition="opacity .4s",setTimeout(()=>{dominterface3.style.opacity="0"}),setTimeout(()=>{location.reload()},400)}var inputThrottle=(elem,time=800)=>{let isThrottled=!0;setTimeout(()=>{isThrottled=!1,elem.removeAttribute("disabled")},time),isThrottled&&elem.setAttribute("disabled","")};function hexColorFromSplitRange(id){let{range,button}=getSplitRangeData(id),opacity=Number.parseInt(range??"0"),color=button==="dark"?"#000":"#fff",alpha=opacity.toString(16);return color+alpha}function colorInput(id,color){let wrapper=document.getElementById(id),button=wrapper?.querySelector("button"),input=wrapper?.querySelector("input");if(button&&input){color??=input.value;let hsl=hexToHSL(color);hsl.l=Math.max(0,hsl.l-10),button.style.borderColor=`hsl(${hsl.h}, ${hsl.s}%, ${hsl.l}%)`,button.textContent=color,button.style.backgroundColor=color,button.style.color=getReadableTextColor(hexToRGB(color))}}var gistsyncform=networkForm("f_gistsync"),urlsyncform=networkForm("f_urlsync");function synchronization(init2,update){init2&&onSettingsLoad(()=>{toggleSyncSettingsOption(init2),setTimeout(()=>handleStoragePersistence(init2.syncType),200)}),update&&updateSyncOption(update)}async function updateSyncOption(update){let local=await storage.local.get(["gistId","gistToken","distantUrl","syncType"]),data=await storage.sync.get();if(update.down){if(local.syncType==="gist"){gistsyncform.load();try{let id=local.gistId??"",token=local.gistToken??"",update2=await retrieveGist(token,id);storage.sync.set(update2),fadeOut()}catch(err){gistsyncform.warn(err)}}if(local.syncType==="url"){urlsyncform.load();try{let update2=await receiveFromURL(local.distantUrl);storage.sync.set(update2),fadeOut()}catch(err){urlsyncform.warn(err)}}}if(update.up&&local.syncType==="gist"){gistsyncform.load();try{let token=local.gistToken??"",id=await sendGist(token,local.gistId,data);gistsyncform.accept(),local.gistId=id,storage.local.set({gistId:id}),toggleSyncSettingsOption(local)}catch(error){gistsyncform.warn(error)}}if(update.gistToken===""){local.gistToken="",local.gistId="",storage.local.remove("gistToken"),storage.local.remove("gistId"),gistsyncform.accept(),toggleSyncSettingsOption(local);return}if(update.url===""){local.distantUrl="",storage.local.remove("distantUrl"),toggleSyncSettingsOption(local);return}if(update.gistToken){gistsyncform.load();try{local.gistToken=update.gistToken,local.gistId=await findGistId(local.gistToken),storage.local.set({gistId:local.gistId}),storage.local.set({gistToken:local.gistToken}),gistsyncform.accept(),toggleSyncSettingsOption(local)}catch(error){gistsyncform.warn(error)}}if(update.url){urlsyncform.load();try{await receiveFromURL(update.url),urlsyncform.accept("i_urlsync",update.url),local.distantUrl=update.url,storage.local.set({distantUrl:update.url}),toggleSyncSettingsOption(local)}catch(error){urlsyncform.warn(error)}}isSyncType(update.type)&&(local.syncType=update.type,storage.local.set({syncType:local.syncType}),storage.type.change(update.type==="browser"?"sync":"local",data),toggleSyncSettingsOption(local),handleStoragePersistence(update.type)),update.firefoxPersist&&(localStorage.choseStoragePersistence="true",toggleSyncSettingsOption(local))}async function handleStoragePersistence(type){if(!navigator?.storage?.persisted)return;let persisted=await navigator.storage.persisted();type==="off"&&(persisted||await navigator.storage.persist())}async function toggleSyncSettingsOption(local){let gistId=local?.gistId,gistToken=local?.gistToken,distantUrl=local?.distantUrl,type=local?.syncType,iGistsync=document.querySelector("#i_gistsync"),iUrlsync=document.querySelector("#i_urlsync"),bGistdown=document.querySelector("#b_gistdown"),bGistup=document.querySelector("#b_gistup"),bUrldown=document.querySelector("#b_urldown");bGistdown?.setAttribute("disabled",""),bUrldown?.setAttribute("disabled",""),bGistup?.setAttribute("disabled",""),iGistsync&&gistToken&&(iGistsync.value=gistToken),iUrlsync&&distantUrl&&(iUrlsync.value=distantUrl);let choseStoragePersistence=localStorage.choseStoragePersistence==="true";switch(document.getElementById("disabled-sync")?.classList.toggle("shown",!choseStoragePersistence),type){case"off":case"browser":{document.getElementById("url-sync")?.classList.remove("shown"),document.getElementById("sync-freq")?.classList.remove("shown"),document.getElementById("gist-sync")?.classList.remove("shown");break}case"gist":{document.getElementById("gist-sync")?.classList.add("shown"),document.getElementById("url-sync")?.classList.remove("shown"),document.getElementById("disabled-sync")?.classList.remove("shown"),await isGistTokenValid(gistToken)&&(bGistdown?.removeAttribute("disabled"),bGistup?.removeAttribute("disabled")),setGistStatus(gistToken,gistId);break}case"url":{document.getElementById("url-sync")?.classList.add("shown"),document.getElementById("gist-sync")?.classList.remove("shown"),document.getElementById("disabled-sync")?.classList.remove("shown"),await isDistantUrlValid(distantUrl)&&bUrldown?.removeAttribute("disabled");break}default:}}function isSyncType(val=""){return["browser","gist","url","off"].includes(val)}var import_mod2=__toESM(require_dist());function initCreditEvents(){(0,import_mod2.onclickdown)(document.getElementById("b_interface-background-pause"),()=>{toggleBackgroundPause()}),(0,import_mod2.onclickdown)(document.getElementById("b_interface-background-refresh"),event=>{backgroundUpdate({refresh:event})}),(0,import_mod2.onclickdown)(document.getElementById("b_interface-background-download"),()=>{downloadImage()})}function toggleCredits(backgrounds){let domcontainer2=document.getElementById("credit-container"),domcredit=document.getElementById("credit"),domsave=document.getElementById("a_interface-background-download");switch(backgrounds.type){case"color":{domcontainer2?.classList.remove("shown");return}case"urls":case"files":{domcontainer2?.classList.add("shown"),domcredit?.classList.add("hidden"),domsave?.classList.add("hidden");break}case"videos":{domcontainer2?.classList.add("shown"),domcredit?.classList.remove("hidden"),domsave?.classList.add("hidden");break}default:domcontainer2?.classList.add("shown"),domcredit?.classList.remove("hidden"),domsave?.classList.remove("hidden")}}function updateCredits(image){let domcontainer2=document.getElementById("credit-container"),domcredit=document.getElementById("credit"),domsave=document.getElementById("download-background");if(!(domcontainer2&&domcredit&&image?.page&&image?.username))return;if(image?.format==="video"){if(image.username){let dompage=document.createElement("a");dompage.textContent=tradThis(`Video by ${image.username}`),dompage.href=image.page,domcredit.textContent="",domcredit.append(dompage)}return}let hasLocation=image.city||image.country,exif="",credits="";if(image.exif){let{iso,model,aperture,exposure_time,focal_length}=image.exif;model&&(exif+=`${model} - `),aperture&&(exif+=`f/${aperture} `),exposure_time&&(exif+=`${exposure_time}s `),iso&&(exif+=`${iso}ISO `),focal_length&&(exif+=`${focal_length}mm`)}if(hasLocation){let city=image.city||"",country=image.country||"";credits=`${city}${city&&country?", ":""}${country} <name>`}else credits=tradThis("Photo by <name>");let[location2,rest2]=credits.split(" <name>"),domlocation=document.createElement("a"),domspacer=document.createElement("span"),domrest=document.createElement("span"),domartist=document.createElement("a"),domexif=document.createElement("p");domexif.className="exif",domexif.textContent=exif,domlocation.textContent=location2,domartist.textContent=image.username.slice(0,1).toUpperCase()+image.username.slice(1),domspacer.textContent=hasLocation?" - ":" ",domrest.textContent=rest2,image.page.includes("unsplash")?(domlocation.href=`${image.page}?utm_source=Bonjourr&utm_medium=referral`,domartist.href=`https://unsplash.com/@${image.username}?utm_source=Bonjourr&utm_medium=referral`):domlocation.href=image.page,domcredit.textContent="",domcredit.append(domexif,domlocation,domspacer,domartist,domrest),image.download&&domsave&&(domsave.dataset.downloadUrl=image.download)}async function toggleBackgroundPause(){let freqInput=document.querySelector("#i_freq"),paused=document.getElementById("b_interface-background-pause")?.classList.contains("paused"),sync=await storage.sync.get("backgrounds"),last=localStorage.lastBackgroundFreq||"hour";freqInput&&(freqInput.value=paused?last:"pause"),paused?backgroundUpdate({freq:last}):(localStorage.lastBackgroundFreq=sync.backgrounds.frequency,backgroundUpdate({freq:"pause"}))}async function downloadImage(){let dombutton=document.querySelector("#b_interface-background-download"),domsave=document.querySelector("#download-background");if(!domsave){console.warn("?");return}dombutton?.classList.replace("idle","loading");try{let baseUrl="https://services.bonjourr.fr/unsplash",downloadUrl=new URL(domsave.dataset.downloadUrl??""),apiDownloadUrl=baseUrl+downloadUrl.pathname+downloadUrl.search,downloadResponse=await fetch(apiDownloadUrl);if(!downloadResponse)return;let data=await downloadResponse.json(),imageResponse=await fetch(data.url);if(!imageResponse.ok)return;let blob=await imageResponse.blob();domsave.href=URL.createObjectURL(blob),domsave.download=downloadUrl.pathname.split("/")[2],domsave.click()}finally{dombutton?.classList.replace("loading","idle")}}var globalUrlValue="",backgroundUrlsEditor;function getUrlsAsCollection(local){let urls=Object.entries(local.backgroundUrls).filter(entry=>entry[1].state==="OK").toSorted((a,b)=>new Date(a[1].lastUsed).getTime()-new Date(b[1].lastUsed).getTime()).map(([key])=>key);return[urls,urls.map(url=>({format:"image",page:"",username:"",urls:{full:url,medium:url,small:url}}))]}async function initUrlsEditor(backgrounds,local){globalUrlValue=backgrounds.urls;let{createBackgroundUrlsEditor:createBackgroundUrlsEditor2}=await Promise.resolve().then(()=>(init_csseditor(),csseditor_exports)),options={language:"uri",value:backgrounds.urls};backgroundUrlsEditor=createBackgroundUrlsEditor2(options);let tabCommand=backgroundUrlsEditor.keyCommandMap.Tab;backgroundUrlsEditor.textarea.id="background-urls-editor-textarea",backgroundUrlsEditor.textarea.maxLength=8080,backgroundUrlsEditor.textarea.placeholder=`https://picsum.photos/200
`,backgroundUrlsEditor.addListener("update",value=>{toggleUrlsButton(globalUrlValue,stringMaxSize(value,8080))}),backgroundUrlsEditor.keyCommandMap.Tab=(e,selection,value)=>document.body.matches(".tabbing")?!1:tabCommand?.(e,selection,value);for(let[url,{state}]of Object.entries(local.backgroundUrls))highlightUrlsEditorLine(url,state)}function highlightUrlsEditorLine(url,state){let line=backgroundUrlsEditor.wrapper.querySelectorAll(".pce-line").values().find(l=>l.textContent===`${url}
`),lineState=!line?.textContent?.replace(`
`,"")?"NONE":state;line?.classList.toggle("loading",lineState==="LOADING"),line?.classList.toggle("error",lineState==="NOT_IMAGE"),line?.classList.toggle("good",lineState==="OK"),line?.classList.toggle("warn",lineState==="CANT_REACH"||lineState==="NOT_URL")}function toggleUrlsButton(storage2,value){let button=document.querySelector("#b_background-urls");storage2===value?button?.setAttribute("disabled",""):button?.removeAttribute("disabled")}function applyUrls(backgrounds){let editorValue=backgroundUrlsEditor.value,backgroundUrls={};for(let url of editorValue.split(`
`))backgroundUrls[url]={lastUsed:userDate().toString(),state:"NONE"};globalUrlValue=backgrounds.urls=editorValue,storage.local.set({backgroundUrls}),storage.sync.set({backgrounds}),toggleUrlsButton("osef","osef"),checkUrlStates(backgroundUrls)}async function checkUrlStates(backgroundUrls){let entries2=Object.entries(backgroundUrls);for(let[url]of entries2)highlightUrlsEditorLine(url,"LOADING");for(let[url,item]of entries2)item.state=await getState(url),backgroundUrls[url]=item,highlightUrlsEditorLine(url,item.state),storage.local.set({backgroundUrls})}async function getState(item){let isImage=resp2=>resp2.headers.get("content-type")?.includes("image/"),proxy="https://services.bonjourr.fr/backgrounds/proxy/",resp,url;try{url=new URL(item)}catch{return"NOT_URL"}try{if(resp=await fetch(url),isImage(resp)===!1)return"NOT_IMAGE"}catch{try{if(resp=await fetch(proxy+url),isImage(resp)===!1)return"NOT_IMAGE"}catch{return"CANT_REACH"}}return resp.headers.get("content-type")?.includes("image/")?"OK":"NOT_IMAGE"}var TEXTURE_RANGES={grain:{opacity:{min:"0.02",max:"0.3",step:"0.01",value:"0.1"},size:{min:"140",max:"300",step:"5",value:"220"},color:void 0},verticalDots:{opacity:{min:"0.1",max:"1.0",step:"0.1",value:"0.3"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},diagonalDots:{opacity:{min:"0.1",max:"1.0",step:"0.1",value:"0.3"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},checkerboard:{opacity:{min:"0.1",max:"1.0",step:"0.1",value:"0.3"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},isometric:{opacity:{min:"0.1",max:"1.0",step:"0.1",value:"0.3"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},topographic:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.4"},size:{min:"400",max:"600",step:"10",value:"500"},color:"#ffffff"},grid:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.4"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},verticalLines:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.4"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},horizontalLines:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.4"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},diagonalStripes:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.4"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},verticalStripes:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.4"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},horizontalStripes:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.4"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},diagonalLines:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.4"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},aztec:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.2"},size:{min:"10",max:"100",step:"1",value:"30"},color:"#ffffff"},circuitBoard:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.2"},size:{min:"150",max:"500",step:"1",value:"250"},color:"#ffffff"},ticTacToe:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.2"},size:{min:"50",max:"400",step:"1",value:"100"},color:"#ffffff"},endlessClouds:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.2"},size:{min:"80",max:"400",step:"1",value:"150"},color:"#ffffff"},waves:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.2"},size:{min:"80",max:"400",step:"1",value:"150"},color:"#ffffff"},honeycomb:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.2"},size:{min:"25",max:"300",step:"5",value:"75"},color:"#ffffff"},vectorGrain:{opacity:{min:"0.1",max:"1.0",step:"0.05",value:"0.5"},size:{min:"250",max:"1000",step:"10",value:"350"},color:"#ffffff"},none:{opacity:{min:"",max:"",value:"",step:""},size:{min:"",max:"",value:"",step:""},color:void 0}};var IMAGES=[{optgroup:"Bonjourr",options:[{name:"Bonjourr Daylight",value:"bonjourr-images-daylight"}]},{optgroup:"Unsplash",options:[{name:"Unsplash Collections",value:"unsplash-images-collections"},{name:"Unsplash Search",value:"unsplash-images-search"}]}],VIDEOS=[{optgroup:"Bonjourr",options:[{name:"Bonjourr Daylight",value:"bonjourr-videos-daylight"}]},{optgroup:"Pixabay",options:[{name:"Pixabay Search",value:"pixabay-videos-search"}]}],PROVIDERS={IMAGES,VIDEOS};async function compressMedia(blob,options){let blobUrl=globalThis.URL.createObjectURL(blob),canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),img=new Image;img.src=blobUrl;let type=options.type??"jpeg",size=options.size??300,q=options.q??.9;return await new Promise(resolve2=>{img.onload=()=>{let orientation=img.height>img.width?"portrait":"landscape",ratio=0,x=0,y=0;orientation==="landscape"&&(ratio=size/img.height,canvas.height=y=size,canvas.width=x=img.width*ratio),orientation==="portrait"&&(ratio=size/img.width,canvas.height=y=img.height*ratio,canvas.width=x=size),ctx?.drawImage(img,0,0,x,y),resolve2(!0)}}),await new Promise(resolve2=>{ctx?.canvas.toBlob(resolve2,`image/${type}`,q)})}var import_mod3=__toESM(require_dist());function hashcode(str){let h1=3735928559,h2=1103547991,i,ch;for(i=0,ch=0;i<str.length;i++)ch=str.charCodeAt(i),h1=Math.imul(h1^ch,2654435761),h2=Math.imul(h2^ch,1597334677);h1=Math.imul(h1^h1>>>16,2246822507),h1^=Math.imul(h2^h2>>>13,3266489909),h2=Math.imul(h2^h2>>>16,2246822507),h2^=Math.imul(h1^h1>>>13,3266489909);let array=(4294967296*(2097151&h2)+(h1>>>0)).toString().split(""),charlist="arosmwxcvn".split("");return array.map(num=>charlist[Number.parseInt(num)]).join("")}var thumbnailVisibilityObserver,thumbnailSelectionObserver;async function localFilesCacheControl(backgrounds,local,needNew){local=await indexedDbToCacheStorage(local);let ids2=lastUsedBackgroundFiles(local.backgroundFiles);if(ids2.length===0){removeBackgrounds();return}let freq=backgrounds.frequency,metadata=local.backgroundFiles[ids2[0]],lastUsed=new Date(metadata.lastUsed).getTime();if(needNew??=needsChange(freq,lastUsed),ids2.length>1&&needNew){ids2.shift();let rand=Math.floor(Math.random()*ids2.length),id=ids2[rand];applyBackground(await imageFromLocalFiles(id,local)),local.backgroundFiles[id].lastUsed=userDate().toString(),storage.local.set(local)}else applyBackground(await imageFromLocalFiles(ids2[0],local))}async function addLocalBackgrounds(filelist,local){try{let dateString=userDate().toString(),thumbnailsContainer=document.getElementById("thumbnails-container"),filesData={},newids=[];if(filelist.length===0)return;for(let file of filelist){let infosString=file.size.toString()+file.name+file.lastModified.toString(),hashString=hashcode(infosString).toString();if(Object.keys(local.backgroundFiles).includes(hashString))continue;newids.push(hashString);let thumbnail=createThumbnail(hashString);thumbnailsContainer?.appendChild(thumbnail)}if(thumbnailsContainer){let idsAmount=Object.keys(local.backgroundFiles).length+newids.length,columnsAmount=Math.min(idsAmount,5).toString();thumbnailsContainer.style.setProperty("--thumbnails-columns",columnsAmount)}for(let i=0;i<newids.length;i++){let file=filelist[i],id=newids[i],isLandscape=globalThis.screen.orientation.type==="landscape-primary",long=isLandscape?globalThis.screen.width:globalThis.screen.height,short=isLandscape?globalThis.screen.height:globalThis.screen.width,density=Math.min(2,globalThis.devicePixelRatio),ratio=Math.min(1.8,long/short),averagePixelHeight=short*ratio*density,raw,full,medium,small;file.type==="image/gif"?(raw=file,full=file,medium=file,small=await compressMedia(file,{size:360,q:.4})):(raw=file,full=await compressMedia(file,{size:averagePixelHeight,q:.8}),medium=await compressMedia(full,{size:averagePixelHeight/3,q:.6}),small=await compressMedia(medium,{size:360,q:.4})),local.backgroundFiles[id]={lastUsed:dateString,position:{size:"cover",x:"50%",y:"50%"}},filesData[id]={raw,full,medium,small},saveFileToCache(id,filesData[id]),addThumbnailImage(id,local,filesData[id]),storage.local.set({backgroundFiles:local.backgroundFiles})}if(newids.length>0){let id=newids[0],image=await imageFromLocalFiles(id,local,filesData[id]);unselectAll(),applyBackground(image),handleFilesSettingsOptions(local)}let uploadInput=document.querySelector("#i_background-upload");uploadInput&&(uploadInput.value="")}catch(e){console.info(e);return}}async function removeLocalBackgrounds(){try{let local=await storage.local.get(),selectedIds=getSelection();if(selectedIds.length===0||!local.backgroundFiles)return;for(let id of selectedIds){removeFilesFromCache([id]),delete local.backgroundFiles[id];let thumbnail=document.querySelector(`#${id}`);thumbnail?.classList.toggle("hiding",!0),setTimeout(()=>{thumbnail?.remove(),toggleLocalFileButtons()},100)}let filesIds=lastUsedBackgroundFiles(local.backgroundFiles);filesIds.length>0?applyBackground(await imageFromLocalFiles(filesIds[0],local)):removeBackgrounds(),handleFilesSettingsOptions(local),storage.local.remove("backgroundFiles"),storage.local.set({backgroundFiles:local.backgroundFiles})}catch(err){console.info(err);return}}async function updateBackgroundPosition(type,value){let img=document.querySelector("#background-media div"),selection=getSelection()[0],local=await storage.local.get("backgroundFiles"),file=local.backgroundFiles[selection];img&&file&&(type==="size"&&(file.position.size=value==="100"?"cover":`${value}%`,img.style.backgroundSize=file.position.size),type==="vertical"&&(file.position.y=`${value}%`,img.style.backgroundPositionY=file.position.y),type==="horizontal"&&(file.position.x=`${value}%`,img.style.backgroundPositionX=file.position.x),local.backgroundFiles[selection]=file,storage.local.set({backgroundFiles:local.backgroundFiles}))}function initFilesSettingsOptions(local){thumbnailSelectionObserver=new MutationObserver(toggleLocalFileButtons),thumbnailVisibilityObserver=new IntersectionObserver(intersectionEvent),IS_MOBILE&&document.getElementById("thumbnails-container")?.style.setProperty("--thumbnails-columns","2"),sanitizeMetadatas(local).then(newlocal=>{handleFilesSettingsOptions(newlocal)}),(0,import_mod3.onclickdown)(document.getElementById("b_thumbnail-remove"),removeLocalBackgrounds),(0,import_mod3.onclickdown)(document.getElementById("b_thumbnail-position"),()=>handlePositionOption()),document.getElementById("b_thumbnail-zoom")?.addEventListener("click",handleGridView),document.getElementById("i_background-size")?.addEventListener("input",handleFilePosition),document.getElementById("i_background-vertical")?.addEventListener("input",handleFilePosition),document.getElementById("i_background-horizontal")?.addEventListener("input",handleFilePosition)}function handleFilesSettingsOptions(local){let backgroundFiles=local.backgroundFiles,thumbnailsContainer=document.getElementById("thumbnails-container"),thumbs=document.querySelectorAll(".thumbnail"),thumbIds=Object.values(thumbs).map(el=>el.id),fileIds=Object.keys(backgroundFiles)??[],lastUsed=lastUsedBackgroundFiles(local.backgroundFiles),missingThumbnails=fileIds.filter(id=>!thumbIds.includes(id));if(missingThumbnails.length>0)for(let id of missingThumbnails){let thumbnail=createThumbnail(id);thumbnailsContainer?.appendChild(thumbnail),thumbnailVisibilityObserver?.observe(thumbnail),thumbnailSelectionObserver?.observe(thumbnail,{attributes:!0}),id===lastUsed[0]&&thumbnail.classList.add("selected")}toggleLocalFileButtons()}function handleFilesMoveOptions(file){let backgroundSize=document.querySelector("#i_background-size"),backgroundVertical=document.querySelector("#i_background-vertical"),backgroundHorizontal=document.querySelector("#i_background-horizontal");backgroundSize&&backgroundVertical&&backgroundHorizontal&&(backgroundSize.value=(file.position.size==="cover"?"100":file.position.size).replace("%",""),backgroundVertical.value=file.position.y.replace("%",""),backgroundHorizontal.value=file.position.x.replace("%",""))}function handlePositionOption(force){let domoptions=document.getElementById("background-position-options");domoptions&&domoptions.classList.toggle("shown",force)}function handleGridView(){let container2=document.getElementById("thumbnails-container");if(container2){let currentZoom=globalThis.getComputedStyle(container2).getPropertyValue("--thumbnails-columns"),newZoom=Math.max((Number.parseInt(currentZoom)+1)%6,1);container2.style.setProperty("--thumbnails-columns",newZoom.toString())}}function handleFilePosition(){let{id,value}=this;id==="i_background-size"&&updateBackgroundPosition("size",value),id==="i_background-vertical"&&updateBackgroundPosition("vertical",value),id==="i_background-horizontal"&&updateBackgroundPosition("horizontal",value)}function intersectionEvent(entries2){for(let{target,isIntersecting}of entries2){let id=target.id??"";isIntersecting&&target.classList.contains("loading")&&getFileFromCache(id).then(data=>{storage.local.get("backgroundFiles").then(local=>{data&&(addThumbnailImage(id,local,data),thumbnailVisibilityObserver.unobserve(target))})})}}function toggleLocalFileButtons(_){let thmbRemove=document.getElementById("b_thumbnail-remove"),thmbMove=document.getElementById("b_thumbnail-position"),selected=document.querySelectorAll(".thumbnail.selected").length,domoptions=document.getElementById("background-position-options");selected===0?thmbRemove?.setAttribute("disabled",""):thmbRemove?.removeAttribute("disabled"),selected!==1?thmbMove?.setAttribute("disabled",""):thmbMove?.removeAttribute("disabled"),(selected===0||selected>1)&&handlePositionOption(!1),selected===1&&domoptions?.classList.contains("shown")&&domoptions?.classList.remove("shown")}function createThumbnail(id){let thb=document.createElement("button"),thbimg=document.createElement("img");return thb.id=id,thbimg.src="src/assets/interface/loading.svg",thb.className="thumbnail loading",thbimg.setAttribute("alt",""),thbimg.setAttribute("draggable","false"),thb.setAttribute("aria-label","Select this background"),thb.appendChild(thbimg),thb.addEventListener("click",handleThumbnailClick),thb}function addThumbnailImage(id,local,data){let btn=document.querySelector(`#${id}`),img=document.querySelector(`#${id} img`);if(!(img&&btn)){console.warn("?");return}img.addEventListener("load",()=>{btn.classList.replace("loading","loaded"),setTimeout(()=>btn.classList.remove("loaded"),2)}),imageFromLocalFiles(id,local,data).then(image=>{img.src=image.urls.small})}async function handleThumbnailClick(mouseEvent){let hasCtrl=mouseEvent.ctrlKey||mouseEvent.metaKey,isLeftClick=mouseEvent.button===0,id=this?.id??"";if(isLeftClick&&hasCtrl){this.classList.contains("selected")||document.getElementById("b_thumbnail-remove")?.removeAttribute("disabled"),document.getElementById(id)?.classList?.toggle("selected");return}if(this.classList.contains("selected")&&isLeftClick){unselectAll(),document.getElementById(id)?.classList?.toggle("selected");return}if(!this.classList.contains("selected")&&isLeftClick){let local=await storage.local.get(),metadata=local.backgroundFiles[id],image=await imageFromLocalFiles(id,local);if(!metadata||!image){console.warn("metadata: ",metadata),console.warn("image: ",image);return}unselectAll(),document.getElementById(id)?.classList?.add("selected"),local.backgroundFiles[id].lastUsed=userDate().toString(),storage.local.set({backgroundFiles:local.backgroundFiles}),handleFilesSettingsOptions(local),handleFilesMoveOptions(metadata),applyBackground(image)}}function lastUsedBackgroundFiles(metadatas){return Object.entries(metadatas).toSorted((a,b)=>new Date(b[1].lastUsed).getTime()-new Date(a[1].lastUsed).getTime()).map(([id,_])=>id)}async function imageFromLocalFiles(id,local,data){let isRaw=local.backgroundCompressFiles===!1,metadata=local.backgroundFiles[id];data=data??await getFileFromCache(id);let urls={raw:URL.createObjectURL(data.raw),full:URL.createObjectURL(data.full),medium:URL.createObjectURL(data.medium),small:URL.createObjectURL(data.small)};return{format:"image",size:metadata?.position.size??"cover",x:metadata?.position.x??"50%",y:metadata?.position.y??"50%",urls:{full:isRaw?urls.raw:urls.full,medium:urls.medium,small:urls.small}}}function unselectAll(){for(let node of document.querySelectorAll(".thumbnail.selected"))node?.classList?.remove("selected")}function getSelection(){let thmbs=document.querySelectorAll(".thumbnail.selected");return Object.values(thmbs).map(thmb=>thmb?.id??"")}async function saveFileToCache(id,filedata){let cache=await caches.open("local-files");for(let[size,blob]of Object.entries(filedata)){let request=new Request(`http://127.0.0.1:8888/${id}/${size}`),response=new Response(blob,{headers:{"content-type":blob.type,"Cache-Control":"max-age=604800"}});cache.put(request,response)}}async function getFileFromCache(id){let start=globalThis.performance.now(),cache=await caches.open("local-files"),raw=await(await cache?.match(`http://127.0.0.1:8888/${id}/raw`))?.blob(),full=await(await cache?.match(`http://127.0.0.1:8888/${id}/full`))?.blob(),medium=await(await cache?.match(`http://127.0.0.1:8888/${id}/medium`))?.blob(),small=await(await cache?.match(`http://127.0.0.1:8888/${id}/small`))?.blob();if(!full||!medium||!small||!raw)throw new Error(`${id} is undefined`);return{raw,full,medium,small}}async function removeFilesFromCache(ids2){let cache=await caches.open("local-files");for(let id of ids2)sessionStorage.removeItem(id),cache.delete(`http://127.0.0.1:8888/${id}/raw`),cache.delete(`http://127.0.0.1:8888/${id}/full`),cache.delete(`http://127.0.0.1:8888/${id}/medium`),cache.delete(`http://127.0.0.1:8888/${id}/small`);return!0}async function sanitizeMetadatas(local){let newMetadataList={},cacheKeys=await(await caches.open("local-files")).keys();for(let request of cacheKeys)try{let key=new URL(request.url).pathname.split("/")[1],metadata=local.backgroundFiles[key];metadata||(metadata={lastUsed:new Date("01/01/1971").toString(),position:{size:"cover",x:"50%",y:"50%"}}),newMetadataList[key]=metadata}catch(err){console.info(err)}let oldKeys=Object.keys(local.backgroundFiles),newKeys=Object.keys(newMetadataList);return oldKeys.length!==newKeys.length&&storage.local.set({backgroundFiles:newMetadataList}),local.backgroundFiles=newMetadataList,local}async function indexedDbToCacheStorage(local){if(localStorage.hasRemovedIndexedDB)return local;try{let entries2=await entries(),newFileData={};if(entries2.length===0)return local;for(let[key,value]of entries2){let isOldIdb="background"in value&&"thumbnail"in value,isNewIdb="raw"in value&&"full"in value&&"medium"in value&&"small"in value,id=key;!isOldIdb&&!isNewIdb||(isOldIdb&&(newFileData[id]={raw:value.background,full:value.background,medium:value.thumbnail,small:value.thumbnail}),isNewIdb&&(newFileData[id]={raw:value.raw,full:value.full,medium:value.medium,small:value.small}),local.backgroundFiles[id]={lastUsed:new Date("1971-01-01").toString(),position:{size:"cover",x:"50%",y:"50%"}})}let saveAllFiles=Object.entries(newFileData).map(([id,filedata])=>saveFileToCache(id,filedata));storage.local.set({backgroundFiles:local.backgroundFiles}),await Promise.all(saveAllFiles);try{clear(),localStorage.hasRemovedIndexedDB="true"}catch(err){console.warn("Failed to update indexedDB"),console.warn(err)}}catch(err){console.warn("Failed to import from indexedDB to CacheStorage"),console.warn(err)}return local}var propertiesUpdateDebounce=debounce(filtersUpdate,600),colorUpdateDebounce=debounce(solidUpdate,600),fadeinPreviewDebounce=debounce(previewFadein,200),fadeinTimeout=0,formBackgroundUserColl=networkForm("f_background-user-coll"),formBackgroundUserSearch=networkForm("f_background-user-search");function backgroundsInit(sync,local,init2){if(init2){let isColor=sync.backgrounds.type==="color",noFadeIn=sync.backgrounds.fadein===0,wrapper=document.getElementById("background-wrapper");(isColor||noFadeIn)&&wrapper?.classList.remove("hidden");let pauseButton=document.getElementById("b_interface-background-pause"),isPaused=sync.backgrounds.frequency==="pause";pauseButton?.classList.toggle("paused",isPaused),initCreditEvents(),document.addEventListener("visibilitychange",pauseVideoOnVisibilityChange)}switch(toggleCredits(sync.backgrounds),applyFilters(sync.backgrounds),applyTexture(sync.backgrounds.texture),handleBackgroundActions(sync.backgrounds),document.getElementById("background-wrapper")?.setAttribute("data-type",sync.backgrounds.type),sync.backgrounds.type){case"files":{localFilesCacheControl(sync.backgrounds,local);break}case"color":{applyBackground(sync.backgrounds.color);break}default:backgroundCacheControl(sync.backgrounds,local)}}async function backgroundUpdate(update){let data=await storage.sync.get("backgrounds"),local=await storage.local.get();if(update.blurenter){blurResolutionControl(data,local);return}if(update.blur!==void 0){applyFilters({blur:Number.parseFloat(update.blur)}),propertiesUpdateDebounce({blur:Number.parseFloat(update.blur)});return}if(update.bright!==void 0){applyFilters({bright:Number.parseFloat(update.bright)}),propertiesUpdateDebounce({bright:Number.parseFloat(update.bright)});return}if(update.fadein!==void 0){applyFilters({fadein:Number.parseInt(update.fadein)}),propertiesUpdateDebounce({fadein:Number.parseFloat(update.fadein)}),fadeinPreviewDebounce(Number.parseFloat(update.fadein));return}if(isBackgroundType(update.type)&&(data.backgrounds.type=update.type,storage.sync.set({backgrounds:data.backgrounds}),createProviderSelect(data.backgrounds),handleBackgroundOptions(data.backgrounds),backgroundsInit(data,local)),isFrequency(update.freq)){if(data.backgrounds.frequency=update.freq,update.freq==="pause"){let type=data.backgrounds.type;if(type==="images"){let collection=getCollection(data.backgrounds,local).images();data.backgrounds.pausedImage=collection[0]}if(type==="videos"){let collection=getCollection(data.backgrounds,local).videos();data.backgrounds.pausedVideo=collection[0]}if(type==="urls"){let[_,list]=getUrlsAsCollection(local);data.backgrounds.pausedUrl=list[0].urls.full}}storage.sync.set({backgrounds:data.backgrounds}),handleBackgroundOptions(data.backgrounds)}if(update.refresh&&(data.backgrounds.type==="files"?localFilesCacheControl(data.backgrounds,local,!0):backgroundCacheControl(data.backgrounds,local,!0),turnRefreshButton(update.refresh,!0)),update.color&&(colorInput("solid-background",update.color),applyBackground(update.color),colorUpdateDebounce(update.color)),update.urlsapply&&applyUrls(data.backgrounds),update.files&&addLocalBackgrounds(update.files,local),update.compress!==void 0){local.backgroundCompressFiles=update.compress,storage.local.set({backgroundCompressFiles:update.compress});let ids2=lastUsedBackgroundFiles(local.backgroundFiles),image=await imageFromLocalFiles(ids2[0],local,void 0);applyBackground(image)}switch(update.texturecolor!==void 0&&(data.backgrounds.texture.color=update.texturecolor,propertiesUpdateDebounce({texture:data.backgrounds.texture}),colorInput("texture-color",update.texturecolor),applyTexture(data.backgrounds.texture)),update.textureopacity!==void 0&&(data.backgrounds.texture.opacity=Number.parseFloat(update.textureopacity),propertiesUpdateDebounce({texture:data.backgrounds.texture}),applyTexture(data.backgrounds.texture)),update.texturesize!==void 0&&(data.backgrounds.texture.size=Number.parseInt(update.texturesize),propertiesUpdateDebounce({texture:data.backgrounds.texture}),applyTexture(data.backgrounds.texture)),isBackgroundTexture(update.texture)&&(data.backgrounds.texture={type:update.texture},storage.sync.set({backgrounds:data.backgrounds}),handleBackgroundOptions(data.backgrounds),applyTexture(data.backgrounds.texture)),data.backgrounds.type){case"files":case"urls":case"color":return;default:}if(update.provider){data.backgrounds[data.backgrounds.type]=update.provider,storage.sync.set({backgrounds:data.backgrounds}),handleBackgroundOptions(data.backgrounds);let isNotEmpty=local.backgroundCollections[update.provider]?.length>0,isDefault=update.provider.includes("bonjourr");(isNotEmpty||isDefault)&&backgroundCacheControl(data.backgrounds,local)}if(update.query!==void 0){let collectionName=data.backgrounds[data.backgrounds.type],query=update.query.target.querySelector("input")?.value??"",isCorrectCollection=collectionName==="unsplash-images-collections",startsWithUrl=query.startsWith("https://unsplash.com/collections/");if(isCorrectCollection&&startsWithUrl&&(query=query.replace("https://unsplash.com/collections/","").slice(0,query.indexOf("/"))),local.backgroundCollections[collectionName]=[],data.backgrounds.queries[collectionName]=query,storage.sync.set({backgrounds:data.backgrounds}),query===""){storage.local.set({backgroundCollections:local.backgroundCollections}),formBackgroundUserColl.accept(""),formBackgroundUserSearch.accept(""),removeBackgrounds();return}formBackgroundUserColl.load(),formBackgroundUserSearch.load(),handleBackgroundOptions(data.backgrounds),await backgroundCacheControl(data.backgrounds,local),formBackgroundUserColl.accept(collectionName),formBackgroundUserSearch.accept(collectionName)}}async function filtersUpdate({blur,bright,fadein,texture}){let data=await storage.sync.get("backgrounds");blur!==void 0&&(data.backgrounds.blur=blur),bright!==void 0&&(data.backgrounds.bright=bright),fadein!==void 0&&(data.backgrounds.fadein=fadein),texture!==void 0&&(data.backgrounds.texture=texture),storage.sync.set({backgrounds:data.backgrounds})}async function solidUpdate(value){let data=await storage.sync.get("backgrounds");data.backgrounds.color=value,storage.sync.set({backgrounds:data.backgrounds})}function previewFadein(ms){let wrapper=document.getElementById("background-wrapper"),setOpacity=val=>wrapper?.setAttribute("style",`opacity: ${val}`);clearTimeout(fadeinTimeout),fadeinTimeout=setTimeout(()=>setOpacity(1),ms),setOpacity(0)}async function backgroundCacheControl(backgrounds,local,needNew){if(backgrounds.type==="color")return;let list=[];switch(backgrounds.type){case"images":list=getCollection(backgrounds,local).images();break;case"videos":list=getCollection(backgrounds,local).videos();break;default:}let lastTime=new Date(local.backgroundLastChange??"01/01/1971").getTime(),isPaused=backgrounds.frequency==="pause",isPreloading=localStorage.backgroundPreloading==="true";if(needNew??=needsChange(backgrounds.frequency,lastTime),list.length===0){let json=await fetchNewBackgrounds(backgrounds);if(json){let newlocal=setCollection(backgrounds,local).fromApi(json),newcoll=getCollection(backgrounds,newlocal),isImage=backgrounds.type==="images";newlocal.backgroundLastChange=userDate().toString(),storage.local.set(newlocal),list=isImage?newcoll.images():newcoll.videos(),preloadBackground(list[1])}}if(isPreloading){applyBackground(list[0]),preloadBackground(list[1]);return}if(!needNew&&isPaused){if(backgrounds.pausedImage){applyBackground(backgrounds.pausedImage);return}if(backgrounds.pausedVideo){applyBackground(backgrounds.pausedVideo);return}}if(!needNew){applyBackground(list[0]);return}if(list.length>1&&list.shift(),backgrounds.frequency==="pause"&&(backgrounds.type==="images"&&(backgrounds.pausedImage=list[0]),backgrounds.type==="videos"&&(backgrounds.pausedVideo=list[0]),storage.sync.set({backgrounds})),list.length>1){let newlocal=local;preloadBackground(list[1]),newlocal=setCollection(backgrounds,local).fromList(list),newlocal.backgroundLastChange=userDate().toString(),storage.local.set(newlocal)}if(applyBackground(list[0]),list.length===1&&navigator.onLine){let json=await fetchNewBackgrounds(backgrounds);if(json){let newlocal=setCollection(backgrounds,local).fromApi(json),newcoll=getCollection(backgrounds,newlocal),newlist=backgrounds.type==="images"?newcoll.images():newcoll.videos();preloadBackground(newlist[0]),preloadBackground(newlist[1]),storage.local.set({backgroundCollections:newlocal.backgroundCollections})}}}async function fetchNewBackgrounds(backgrounds){switch(backgrounds.type){case"files":case"urls":case"color":throw new Error('Can only fetch with "images" or "videos" type');default:}let collectionName=backgrounds[backgrounds.type],[provider,type,category]=collectionName.split("-"),base="https://services.bonjourr.fr/backgrounds",path=`/${provider}/${type}/${category}`,density=Math.max(2,globalThis.devicePixelRatio),ratio=globalThis.screen.width/globalThis.screen.height,height=globalThis.screen.height*density,width=globalThis.screen.width*density;ratio>=2&&(width=height*2),ratio<=.5&&(height=width*2);let screen=`?h=${height}&w=${width}`,query=backgrounds.queries[collectionName]??"",search=query?`&query=${query}`:"",url=base+path+screen+search,json=await(await fetch(url)).json(),areImages=type==="images"&&Object.keys(json)?.every(key=>key.includes("images")),areVideos=type==="videos"&&Object.keys(json)?.every(key=>key.includes("videos"));if(areImages||areVideos)return json;throw new Error("Received JSON is bad")}function findCollectionName(backgrounds,local){switch(backgrounds.type){case"files":case"urls":case"color":throw new Error('Only collection names with "images" or "videos" type');default:}let{frequency,type,pausedImage,pausedVideo}=backgrounds,isPausedOnImage=type==="images"&&frequency==="pause"&&pausedImage,isPausedOnVideo=type==="videos"&&frequency==="pause"&&pausedVideo;if(isPausedOnImage)return getCollectionNameFromMedia(pausedImage,local);if(isPausedOnVideo)return getCollectionNameFromMedia(pausedVideo,local);let collectionName=backgrounds[type];if(collectionName.includes("daylight")){let period=daylightPeriod(userDate().getTime());return`${collectionName}-${period}`}return collectionName}function getCollectionNameFromMedia(media,local){let collMap=new Map;for(let[coll,medias]of Object.entries(local.backgroundCollections))for(let media2 of medias)collMap.set(media2.urls.full,coll);return collMap.get(media.urls.full)}function getCollection(backgrounds,local){switch(backgrounds.type){case"files":case"urls":case"color":throw new Error('Can only fetch with "images" or "videos" type');default:}let collectionName=findCollectionName(backgrounds,local),collection=local.backgroundCollections[collectionName]??[];return{images:()=>{if(areOnlyImages(collection))return collection;throw new Error("Wrong background format")},videos:()=>{if(areOnlyVideos(collection))return collection;throw new Error("Wrong background format")}}}function setCollection(backgrounds,local){switch(backgrounds.type){case"files":case"urls":case"color":throw new Error("Cannot update with this type");default:}function fromApi(json){for(let[key,list]of Object.entries(json))local.backgroundCollections[key]=list;return local}function fromList(list){let collectionName=findCollectionName(backgrounds,local);return local.backgroundCollections[collectionName]=list,local}return{fromList,fromApi}}function applyBackground(media,res,fast){if(typeof media=="string"){document.documentElement.style.setProperty("--solid-background",media);return}if(fast&&document.body.classList.add("init"),!media)return;let mediaWrapper=document.getElementById("background-media"),resolution=res||detectBackgroundSize(),item;if(media.format==="image"){let src=media.urls[resolution];item=createImageItem(src,media)}else{let duration=1e3*(media.duration-4),src=media.urls[resolution];item=createVideoItem(src,media,duration)}if(item.dataset.res=resolution,mediaWrapper.prepend(item),mediaWrapper?.childElementCount>1){let lastVisible=Object.values(mediaWrapper?.children).filter(child=>!child.className.includes("hiding")).at(-1);fast?(document.body.classList.remove("init"),setTimeout(()=>mediaWrapper?.lastElementChild?.remove(),200)):(lastVisible?.classList.add("hiding"),setTimeout(()=>mediaWrapper?.lastElementChild?.remove(),1200))}}function createImageItem(src,media,callback){let backgroundsWrapper=document.getElementById("background-wrapper"),div=document.createElement("div"),img=new Image;return img.addEventListener("load",()=>{backgroundsWrapper?.classList.remove("hidden"),applySafariThemeColor(media,img),updateCredits(media),callback&&callback()}),img.src=src,img.remove(),div.style.backgroundImage=`url(${src})`,media.size&&(div.style.backgroundSize=media.size),media.x&&(div.style.backgroundPositionX=media.x),media.y&&(div.style.backgroundPositionY=media.y),div}function createVideoItem(src,media,duration){let backgroundsWrapper=document.getElementById("background-wrapper"),div=document.createElement("div"),videoInterval=0,prependVideo=()=>new Promise(resolve2=>{let vid=document.createElement("video");vid.addEventListener("canplay",()=>{backgroundsWrapper?.classList.remove("hidden"),updateCredits(media),resolve2(!0)}),vid.src=src,vid.volume=0,vid.muted=!0,vid.autoplay=!0,vid.playbackRate=1,div.prepend(vid)}),removeVideo=()=>{div?.lastElementChild?.classList.add("hiding"),setTimeout(()=>div?.lastElementChild?.remove(),4e3)},loopVideo=async()=>{if(document.body.contains(div)){await prependVideo(),removeVideo();return}clearInterval(videoInterval)};return prependVideo().then(()=>{videoInterval=setInterval(loopVideo,duration)}),div}function preloadBackground(media,res){if(!media)return;localStorage.setItem("backgroundPreloading","true");let resolution=res||detectBackgroundSize(),src=media.urls[resolution];if(media.format==="image"){let img=document.createElement("img");return img.fetchPriority="low",new Promise(resolve2=>{img.addEventListener("load",()=>{localStorage.removeItem("backgroundPreloading"),img.remove(),resolve2(!0)}),img.src=src})}if(media.format==="video"){let video=document.createElement("video");return new Promise(resolve2=>{video.addEventListener("canplaythrough",()=>{localStorage.removeItem("backgroundPreloading"),video.remove(),resolve2(!0)}),setTimeout(()=>video.src=src,600)})}}function removeBackgrounds(){let mediaWrapper=document.getElementById("background-media");setTimeout(()=>document.querySelector("#background-media div")?.classList.add("hiding")),setTimeout(()=>mediaWrapper.firstChild?.remove(),2e3)}function applyFilters({blur,bright,fadein}){blur!==void 0&&(document.documentElement.style.setProperty("--blur",`${blur}px`),document.body.classList.toggle("blurred",blur>=15)),bright!==void 0&&document.documentElement.style.setProperty("--brightness",`${bright}`),fadein!==void 0&&document.documentElement.style.setProperty("--fade-in",`${fadein}ms`)}function applyTexture(texture){let wrapper=document.getElementById("background-wrapper");if(!(document.getElementById("background-texture")&&wrapper))return;let ranges=TEXTURE_RANGES[texture.type],color=texture.color??ranges.color,size=texture.size??ranges.size.value,opacity=texture.opacity??ranges.opacity.value;wrapper.dataset.texture=texture.type,document.documentElement.style.setProperty("--texture-color",`${color}`),document.documentElement.style.setProperty("--texture-color-transparent",`${color}77`),document.documentElement.style.setProperty("--texture-opacity",`${opacity}`),document.documentElement.style.setProperty("--texture-size",`${size}px`)}function initBackgroundOptions(sync,local){initFilesSettingsOptions(local),initUrlsEditor(sync.backgrounds,local),createProviderSelect(sync.backgrounds),handleBackgroundOptions(sync.backgrounds)}function handleBackgroundOptions(backgrounds){let type=backgrounds.type;document.getElementById("local_options")?.classList.toggle("shown",type==="files"),document.getElementById("solid_options")?.classList.toggle("shown",type==="color"),document.getElementById("unsplash_options")?.classList.toggle("shown",type==="images"),document.getElementById("background-urls-option")?.classList.toggle("shown",type==="urls"),document.getElementById("background-freq-option")?.classList.toggle("shown",type!=="color"),document.getElementById("background-filters-options")?.classList.toggle("shown",type!=="color"),handleTextureOptions(backgrounds),handleProviderOptions(backgrounds),handleBackgroundActions(backgrounds)}function handleTextureOptions(backgrounds){let hasTexture=backgrounds.texture.type!=="none";if(document.getElementById("background-texture-options")?.classList.toggle("shown",hasTexture),hasTexture){let iOpacity=document.querySelector("#i_texture-opacity"),iSize=document.querySelector("#i_texture-size"),colorOption=document.querySelector("#background-texture-color-option"),ranges=TEXTURE_RANGES[backgrounds.texture.type],{opacity,size}=backgrounds.texture;colorOption?.classList.toggle("shown",ranges.color!==void 0),iOpacity&&(iOpacity.min=ranges.opacity.min,iOpacity.max=ranges.opacity.max,iOpacity.step=ranges.opacity.step,iOpacity.value=opacity===void 0?ranges.opacity.value:opacity.toString()),iSize&&(iSize.min=ranges.size.min,iSize.max=ranges.size.max,iSize.step=ranges.size.step,iSize.value=size===void 0?ranges.size.value:size.toString())}}function handleProviderOptions(backgrounds){switch(backgrounds.type){case"files":case"urls":case"color":{document.getElementById("background-provider-option")?.classList.remove("shown");return}default:}document.getElementById("background-provider-option")?.classList.add("shown");let collectionName=backgrounds[backgrounds.type],hasCollections=collectionName.includes("coll"),hasSearch=collectionName.includes("search"),domusercoll=document.querySelector("#i_background-user-coll"),domusersearch=document.querySelector("#i_background-user-search"),domusercolloption=document.querySelector("#background-user-coll-option"),domusersearchoption=document.querySelector("#background-user-search-option");domusercoll&&domusersearch&&domusercolloption&&domusersearchoption&&(domusercolloption.classList.toggle("shown",hasCollections),domusersearchoption.classList.toggle("shown",hasSearch),domusercoll.value=backgrounds.queries[collectionName]??"",domusersearch.value=backgrounds.queries[collectionName]??"")}function createProviderSelect(backgrounds){let backgroundProvider=document.querySelector("#i_background-provider"),providersType=backgrounds.type==="images"?"IMAGES":"VIDEOS",providersList=PROVIDERS[providersType];if(!backgroundProvider)throw new Error("Cannot find #i_background-provider");for(let node of Object.values(backgroundProvider.children))node.remove();for(let provider of providersList){let optgroup=document.createElement("optgroup");optgroup.label=provider.optgroup,backgroundProvider?.appendChild(optgroup);for(let option of provider.options){let opt=document.createElement("option");opt.textContent=option.name,opt.value=option.value,optgroup.appendChild(opt)}}switch(backgrounds.type){case"images":case"videos":{let collectionName=backgrounds[backgrounds.type];backgroundProvider.value=collectionName;break}default:}}function handleBackgroundActions(backgrounds){let type=backgrounds.type,freq=backgrounds.frequency;document.getElementById("background-actions")?.classList.toggle("shown",type!=="color"),document.getElementById("b_interface-background-pause")?.classList.toggle("paused",freq==="pause"),document.getElementById("b_interface-background-download")?.classList.toggle("shown",type==="images")}async function blurResolutionControl(sync,local){if(sync.backgrounds.type==="files"){let ids2=lastUsedBackgroundFiles(local.backgroundFiles),image=await imageFromLocalFiles(ids2[0],local);applyBackground(image,"full");return}let[current,next]=await getCurrentBackgrounds(sync,local);preloadBackground(current,"small"),preloadBackground(current,"medium")?.then(()=>{applyBackground(current,"medium","fast"),preloadBackground(next)}),preloadBackground(current,"full")?.then(()=>{applyBackground(current,"full","fast")})}async function getCurrentBackgrounds(sync,local){if(sync.backgrounds.type==="files"){let ids2=lastUsedBackgroundFiles(local.backgroundFiles),current=await imageFromLocalFiles(ids2[0],local),next=await imageFromLocalFiles(ids2[1],local);return[current,next]}if(sync.backgrounds.type==="images"){let images=getCollection(sync.backgrounds,local).images();return[images[0],images[1]]}if(sync.backgrounds.type==="videos"){let videos=getCollection(sync.backgrounds,local).videos();return[videos[0],videos[1]]}return[]}function detectBackgroundSize(){return document.body.className.includes("blurred")?"small":"full"}function applySafariThemeColor(image,img){let color=image.color;if(BROWSER==="safari"&&!color&&(color=getAverageColor(img)),BROWSER==="safari"&&color){let fadein=Number.parseInt(document.documentElement.style.getPropertyValue("--fade-in"));document.querySelector('meta[name="theme-color"]')?.setAttribute("content",color),setTimeout(()=>{document.documentElement.style.setProperty("--average-color",color)},fadein)}}function pauseVideoOnVisibilityChange(){document.querySelectorAll("video")?.forEach(video=>{document.hidden?video.pause():video.play()})}function getAverageColor(img){try{let canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),maxDimension=100,scale=Math.min(maxDimension/img.width,maxDimension/img.height);canvas.width=img.width*scale,canvas.height=img.height*scale,ctx?.drawImage(img,0,0,canvas.width,canvas.height);let data=ctx?.getImageData(0,0,canvas.width,canvas.height)?.data,r=0,g=0,b=0,count=0;if(data)for(let i=0;i<data.length;i+=4)r+=data[i],g+=data[i+1],b+=data[i+2],count++;return r=Math.floor(r/count),g=Math.floor(g/count),b=Math.floor(b/count),rgbToHex(r,g,b)}catch{}}function isBackgroundType(str=""){return["files","urls","images","videos","color"].includes(str)}function isBackgroundTexture(str=""){return["none","grain","verticalDots","diagonalDots","topographic","checkerboard","isometric","grid","verticalLines","horizontalLines","diagonalStripes","verticalStripes","horizontalStripes","diagonalLines","aztec","circuitBoard","ticTacToe","endlessClouds","vectorGrain","waves","honeycomb"].includes(str)}function isFrequency(str=""){return["tabs","hour","day","period","pause"].includes(str)}function areOnlyImages(list){return list?.every(item=>item.format==="image")}function areOnlyVideos(list){return list?.every(item=>item.format==="video")}var ANNOUNCEMENT_URL="https://ko-fi.com/post/Bonjourr-21-the-background-update-R6R61FLG0Z",ANNOUNCEMENT_VERSION="21.1.0",ANNOUNCEMENT_TRNS={en:"<b>Bonjourr just got a major update! \u2728</b> Learn all about the new features: video backgrounds, texture overlays, background search and more.",fr:"<b>Bonjourr vient d'avoir une mise \xE0 jour majeure ! \u2728</b> D\xE9couvrez les nouvelles fonctionnalit\xE9s: arri\xE8re-plans vid\xE9o, superpositions de textures, recherche d'arri\xE8re-plan et bien plus encore.",de:"<b>Bonjourr hat gerade ein gro\xDFes Update erhalten! \u2728</b> Erfahren Sie alles \xFCber die neuen Funktionen: Videohintergr\xFCnde, Textur-Overlays, Hintergrundsuche und vieles mehr.",it:"<b>Bonjourr ha appena ricevuto un aggiornamento importante! \u2728</b> Scopri tutte le nuove funzionalit\xE0: sfondi video, sovrapposizioni di texture, ricerca di sfondi e altro ancora.",es:"<b>\xA1Bonjourr acaba de recibir una actualizaci\xF3n importante! \u2728</b> Mira todas las nuevas caracter\xEDsticas: fondos de video, superposici\xF3n de texturas, b\xFAsqueda de fondos y mucho m\xE1s.","pt-BR":"<b>Bonjourr acabou de receber uma grande atualiza\xE7\xE3o! \u2728</b> Saiba tudo sobre os novos recursos: planos de fundo em v\xEDdeo, sobreposi\xE7\xF5es de textura, pesquisa de plano de fundo e muito mais.","pt-PT":"<b>Bonjourr acaba de receber uma grande atualiza\xE7\xE3o! \u2728</b> Saiba tudo sobre as novas funcionalidades: fundos de v\xEDdeo, sobreposi\xE7\xF5es de textura, pesquisa de fundo e muito mais.",nl:"<b>Bonjourr heeft zojuist een grote update gekregen! \u2728</b> Leer alles over de nieuwe functies: video-achtergronden, textuur-overlays, achtergrond zoeken en meer.",da:"<b>Bonjourr har lige f\xE5et en st\xF8rre opdatering! \u2728</b> L\xE6r alt om de nye funktioner: videobaggrunde, teksturoverlays, baggrundss\xF8gning og meget mere.",sv:"<b>Bonjourr har precis f\xE5tt en stor uppdatering! \u2728</b> L\xE4s allt om de nya funktionerna: videobakgrunder, textur\xF6verl\xE4gg, bakgrundss\xF6kning och mycket mer.",nb:"<b>Bonjourr har nettopp f\xE5tt en stor oppdatering! \u2728</b> L\xE6r alt om de nye funksjonene: videobakgrunner, teksturoverlegg, bakgrunnss\xF8k og mer.",fi:"<b>Bonjourr sai juuri suuren p\xE4ivityksen! \u2728</b> Lue kaikki uusista ominaisuuksista: videotaustat, tekstuuripeittokuvat, taustahaku ja paljon muuta.",pl:"<b>Bonjourr w\u0142a\u015Bnie otrzyma\u0142 du\u017C\u0105 aktualizacj\u0119! \u2728</b> Dowiedz si\u0119 wszystkiego o nowych funkcjach: te\u0142 wideo, nak\u0142adkach tekstur, wyszukiwaniu t\u0142a i wielu innych.",cs:"<b>Bonjourr pr\xE1v\u011B obdr\u017Eel velkou aktualizaci! \u2728</b> Zjist\u011Bte v\u0161e o nov\xFDch funkc\xEDch: video pozad\xED, texturov\xE9 p\u0159ekryvy, vyhled\xE1v\xE1n\xED pozad\xED a dal\u0161\xED.",hr:"<b>Bonjourr je upravo dobio veliko a\u017Euriranje! \u2728</b> Saznajte sve o novim zna\u010Dajkama: video pozadinama, prekrivanjima tekstura, pretra\u017Eivanju pozadine i jo\u0161 mnogo toga.",sk:"<b>Bonjourr pr\xE1ve dostal ve\u013Ek\xFA aktualiz\xE1ciu! \u2728</b> Zistite v\u0161etko o nov\xFDch funkci\xE1ch: video pozadia, prekrytia text\xFAr, vyh\u013Ead\xE1vanie pozadia a ove\u013Ea viac.",hu:"<b>A Bonjourr most kapott egy nagy friss\xEDt\xE9st! \u2728</b> Tudjon meg mindent az \xFAj funkci\xF3kr\xF3l: vide\xF3 h\xE1tterek, text\xFAra fedv\xE9nyek, h\xE1tt\xE9rkeres\xE9s \xE9s m\xE9g sok m\xE1s.",ro:"<b>Bonjourr tocmai a primit o actualizare major\u0103! \u2728</b> Afla\u021Bi totul despre noile func\u021Bii: fundaluri video, suprapuneri de texturi, c\u0103utare de fundal \u0219i multe altele.",el:"<b>\u03A4\u03BF Bonjourr \u03BC\u03CC\u03BB\u03B9\u03C2 \u03AD\u03BB\u03B1\u03B2\u03B5 \u03BC\u03B9\u03B1 \u03BC\u03B5\u03B3\u03AC\u03BB\u03B7 \u03B5\u03BD\u03B7\u03BC\u03AD\u03C1\u03C9\u03C3\u03B7! \u2728</b> \u039C\u03AC\u03B8\u03B5\u03C4\u03B5 \u03C4\u03B1 \u03C0\u03AC\u03BD\u03C4\u03B1 \u03B3\u03B9\u03B1 \u03C4\u03B9\u03C2 \u03BD\u03AD\u03B5\u03C2 \u03BB\u03B5\u03B9\u03C4\u03BF\u03C5\u03C1\u03B3\u03AF\u03B5\u03C2: \u03C6\u03CC\u03BD\u03C4\u03B1 \u03B2\u03AF\u03BD\u03C4\u03B5\u03BF, \u03B5\u03C0\u03B9\u03BA\u03B1\u03BB\u03CD\u03C8\u03B5\u03B9\u03C2 \u03C5\u03C6\u03CE\u03BD, \u03B1\u03BD\u03B1\u03B6\u03AE\u03C4\u03B7\u03C3\u03B7 \u03C6\u03CC\u03BD\u03C4\u03BF\u03C5 \u03BA\u03B1\u03B9 \u03C0\u03BF\u03BB\u03BB\u03AC \u03AC\u03BB\u03BB\u03B1.",hy:"<b>Bonjourr-\u0568 \u0570\u0565\u0576\u0581 \u0576\u0578\u0580 \u057D\u057F\u0561\u0581\u0561\u057E \u0574\u0565\u056E \u0569\u0561\u0580\u0574\u0561\u0581\u0578\u0582\u0574: \u2728</b> \u053B\u0574\u0561\u0581\u0565\u0584 \u0561\u0574\u0565\u0576 \u056B\u0576\u0579 \u0576\u0578\u0580 \u0570\u0576\u0561\u0580\u0561\u057E\u0578\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0576\u0565\u0580\u056B \u0574\u0561\u057D\u056B\u0576\u055D \u057F\u0565\u057D\u0561\u0576\u0575\u0578\u0582\u0569\u0565\u0580\u056B \u0586\u0578\u0576\u0565\u0580, \u057F\u0565\u0584\u057D\u057F\u0578\u0582\u0580\u0561\u0575\u056B\u0576 \u056E\u0561\u056E\u056F\u0578\u0582\u0575\u0569\u0576\u0565\u0580, \u0586\u0578\u0576\u056B \u0578\u0580\u0578\u0576\u0578\u0582\u0574 \u0587 \u0561\u0575\u056C\u0576\u0589",sr:"<b>Bonjourr \u0458\u0435 \u0443\u043F\u0440\u0430\u0432\u043E \u0434\u043E\u0431\u0438\u043E \u0432\u0435\u043B\u0438\u043A\u043E \u0430\u0436\u0443\u0440\u0438\u0440\u0430\u045A\u0435! \u2728</b> \u0421\u0430\u0437\u043D\u0430\u0458\u0442\u0435 \u0441\u0432\u0435 \u043E \u043D\u043E\u0432\u0438\u043C \u0444\u0443\u043D\u043A\u0446\u0438\u0458\u0430\u043C\u0430: \u0432\u0438\u0434\u0435\u043E \u043F\u043E\u0437\u0430\u0434\u0438\u043D\u0430\u043C\u0430, \u0442\u0435\u043A\u0441\u0442\u0443\u0440\u043D\u0438\u043C \u043F\u0440\u0435\u043A\u043B\u0430\u043F\u0430\u045A\u0438\u043C\u0430, \u043F\u0440\u0435\u0442\u0440\u0430\u0437\u0438 \u043F\u043E\u0437\u0430\u0434\u0438\u043D\u0435 \u0438 \u0458\u043E\u0448 \u043C\u043D\u043E\u0433\u043E \u0442\u043E\u0433\u0430.","sr-YU":"<b>Bonjourr je upravo dobio veliko a\u017Euriranje! \u2728</b> Saznajte sve o novim funkcijama: video pozadinama, teksturnim preklapanjima, pretrazi pozadine i jo\u0161 mnogo toga.",uk:"<b>Bonjourr \u0449\u043E\u0439\u043D\u043E \u043E\u0442\u0440\u0438\u043C\u0430\u0432 \u0432\u0435\u043B\u0438\u043A\u0435 \u043E\u043D\u043E\u0432\u043B\u0435\u043D\u043D\u044F! \u2728</b> \u0414\u0456\u0437\u043D\u0430\u0439\u0442\u0435\u0441\u044F \u0432\u0441\u0435 \u043F\u0440\u043E \u043D\u043E\u0432\u0456 \u0444\u0443\u043D\u043A\u0446\u0456\u0457: \u0432\u0456\u0434\u0435\u043E\u0444\u043E\u043D\u0438, \u043D\u0430\u043A\u043B\u0430\u0434\u0430\u043D\u043D\u044F \u0442\u0435\u043A\u0441\u0442\u0443\u0440, \u043F\u043E\u0448\u0443\u043A \u0444\u043E\u043D\u0443 \u0442\u0430 \u0431\u0430\u0433\u0430\u0442\u043E \u0456\u043D\u0448\u043E\u0433\u043E.",ru:"<b>Bonjourr \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u043F\u043E\u043B\u0443\u0447\u0438\u043B \u043A\u0440\u0443\u043F\u043D\u043E\u0435 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435! \u2728</b> \u0423\u0437\u043D\u0430\u0439\u0442\u0435 \u0432\u0441\u0435 \u043E \u043D\u043E\u0432\u044B\u0445 \u0444\u0443\u043D\u043A\u0446\u0438\u044F\u0445: \u0432\u0438\u0434\u0435\u043E\u0444\u043E\u043D\u044B, \u043D\u0430\u043B\u043E\u0436\u0435\u043D\u0438\u044F \u0442\u0435\u043A\u0441\u0442\u0443\u0440, \u043F\u043E\u0438\u0441\u043A \u0444\u043E\u043D\u0430 \u0438 \u043C\u043D\u043E\u0433\u043E\u0435 \u0434\u0440\u0443\u0433\u043E\u0435.",tr:"<b>Bonjourr b\xFCy\xFCk bir g\xFCncelleme ald\u0131! \u2728</b> Yeni \xF6zellikler hakk\u0131nda her \u015Feyi \xF6\u011Frenin: video arka planlar\u0131, doku kaplamalar\u0131, arka plan aramas\u0131 ve daha fazlas\u0131n\u0131.",ar:"<b>\u062A\u0644\u0642\u0649 Bonjourr \u0644\u0644\u062A\u0648 \u062A\u062D\u062F\u064A\u062B\u064B\u0627 \u0643\u0628\u064A\u0631\u064B\u0627! \u2728</b> \u062A\u0639\u0631\u0641 \u0639\u0644\u0649 \u062C\u0645\u064A\u0639 \u0627\u0644\u0645\u064A\u0632\u0627\u062A \u0627\u0644\u062C\u062F\u064A\u062F\u0629: \u062E\u0644\u0641\u064A\u0627\u062A \u0627\u0644\u0641\u064A\u062F\u064A\u0648\u060C \u0648\u062A\u0631\u0627\u0643\u0628\u0627\u062A \u0627\u0644\u0646\u0633\u064A\u062C\u060C \u0648\u0627\u0644\u0628\u062D\u062B \u0639\u0646 \u0627\u0644\u062E\u0644\u0641\u064A\u0627\u062A \u0648\u0627\u0644\u0645\u0632\u064A\u062F.",fa:"<b>Bonjourr \u0628\u0647 \u062A\u0627\u0632\u06AF\u06CC \u06CC\u06A9 \u0628\u0631\u0648\u0632\u0631\u0633\u0627\u0646\u06CC \u0628\u0632\u0631\u06AF \u062F\u0631\u06CC\u0627\u0641\u062A \u06A9\u0631\u062F\u0647 \u0627\u0633\u062A! \u2728</b> \u0647\u0645\u0647 \u0686\u06CC\u0632 \u0631\u0627 \u062F\u0631 \u0645\u0648\u0631\u062F \u0648\u06CC\u0698\u06AF\u06CC\u200C\u0647\u0627\u06CC \u062C\u062F\u06CC\u062F \u0628\u06CC\u0627\u0645\u0648\u0632\u06CC\u062F: \u067E\u0633\u200C\u0632\u0645\u06CC\u0646\u0647\u200C\u0647\u0627\u06CC \u0648\u06CC\u062F\u06CC\u0648\u06CC\u06CC\u060C \u067E\u0648\u0634\u0634\u200C\u0647\u0627\u06CC \u0628\u0627\u0641\u062A\u060C \u062C\u0633\u062A\u062C\u0648\u06CC \u067E\u0633\u200C\u0632\u0645\u06CC\u0646\u0647 \u0648 \u0645\u0648\u0627\u0631\u062F \u062F\u06CC\u06AF\u0631.","zh-CN":"<b>Bonjourr \u521A\u521A\u83B7\u5F97\u4E86\u91CD\u5927\u66F4\u65B0\uFF01\u2728</b> \u4E86\u89E3\u6240\u6709\u65B0\u529F\u80FD\uFF1A\u89C6\u9891\u80CC\u666F\u3001\u7EB9\u7406\u53E0\u52A0\u3001\u80CC\u666F\u641C\u7D22\u7B49\u7B49\u3002","zh-HK":"<b>Bonjourr \u525B\u525B\u7372\u5F97\u4E86\u91CD\u5927\u66F4\u65B0\uFF01\u2728</b> \u4E86\u89E3\u6240\u6709\u65B0\u529F\u80FD\uFF1A\u5F71\u7247\u80CC\u666F\u3001\u7D0B\u7406\u758A\u52A0\u3001\u80CC\u666F\u641C\u5C0B\u7B49\u7B49\u3002","zh-TW":"<b>Bonjourr \u525B\u525B\u7372\u5F97\u4E86\u91CD\u5927\u66F4\u65B0\uFF01\u2728</b> \u77AD\u89E3\u6240\u6709\u65B0\u529F\u80FD\uFF1A\u5F71\u7247\u80CC\u666F\u3001\u7D0B\u7406\u758A\u52A0\u3001\u80CC\u666F\u641C\u5C0B\u7B49\u7B49\u3002",ja:"<b>Bonjourr \u304C\u5927\u5E45\u306A\u30A2\u30C3\u30D7\u30C7\u30FC\u30C8\u3092\u884C\u3044\u307E\u3057\u305F\uFF01\u2728</b> \u65B0\u6A5F\u80FD\u306B\u3064\u3044\u3066\u3059\u3079\u3066\u5B66\u3073\u307E\u3057\u3087\u3046\uFF1A\u52D5\u753B\u80CC\u666F\u3001\u30C6\u30AF\u30B9\u30C1\u30E3\u30AA\u30FC\u30D0\u30FC\u30EC\u30A4\u3001\u80CC\u666F\u691C\u7D22\u306A\u3069\u3002",id:"<b>Bonjourr baru saja mendapatkan pembaruan besar! \u2728</b> Pelajari semua tentang fitur baru: latar belakang video, overlay tekstur, pencarian latar belakang, dan lainnya.",ca:"<b>Bonjourr acaba de rebre una actualitzaci\xF3 important! \u2728</b> Descobreix totes les noves funcionalitats: fons de v\xEDdeo, superposicions de textures, cerca de fons i molt m\xE9s.",vi:"<b>Bonjourr v\u1EEBa nh\u1EADn \u0111\u01B0\u1EE3c m\u1ED9t b\u1EA3n c\u1EADp nh\u1EADt l\u1EDBn! \u2728</b> T\xECm hi\u1EC3u t\u1EA5t c\u1EA3 v\u1EC1 c\xE1c t\xEDnh n\u0103ng m\u1EDBi: h\xECnh n\u1EC1n video, l\u1EDBp ph\u1EE7 h\u1ECDa ti\u1EBFt, t\xECm ki\u1EBFm h\xECnh n\u1EC1n v\xE0 nhi\u1EC1u h\u01A1n n\u1EEFa."},REVIEW_TEXT="Love using Bonjourr? Consider giving us a review or donating, that would help a lot! \u{1F607}",REVIEW_URLS={chrome:"https://chrome.google.com/webstore/detail/bonjourr-%C2%B7-minimalist-lig/dlnejlppicbjfcfcedcflplfjajinajd/reviews",opera:"https://chrome.google.com/webstore/detail/bonjourr-%C2%B7-minimalist-lig/dlnejlppicbjfcfcedcflplfjajinajd/reviews",firefox:"https://addons.mozilla.org/en-US/firefox/addon/bonjourr-startpage/",safari:"https://apps.apple.com/fr/app/bonjourr-startpage/id1615431236",edge:"https://microsoftedge.microsoft.com/addons/detail/bonjourr/dehmmlejmefjphdeoagelkpaoolicmid",other:"https://bonjourr.fr/help#%EF%B8%8F-reviews"};function interfacePopup(init2,event){if(isAnnouncement(event?.announcements)){storage.sync.set({announcements:event?.announcements});return}if(!(!init2||init2?.announce==="off")){if(init2.old&&(init2.review===-1||init2.review>30)){let major=s=>Number.parseInt(s.split(".")[0]),isMajorUpdate=major(init2.new)>major(init2.old),isNewVersion=init2.new!==init2.old&&init2.new===ANNOUNCEMENT_VERSION,announceMajor=init2.announce==="major"&&isMajorUpdate,announceAny=init2.announce==="all"&&isNewVersion;if(localStorage.hasUpdated==="true"||announceAny||announceMajor){localStorage.hasUpdated="true",displayPopup("announce",!0);return}}init2.review!==-1&&(init2.review>30?displayPopup("review"):storage.sync.set({review:init2.review+1}))}}function displayPopup(type,showIcon=!1){let template=document.getElementById("popup-template"),doc=document.importNode(template.content,!0),popup=doc.getElementById("popup"),desc=doc.getElementById("popup_desc"),close=doc.getElementById("popup_close"),buttons=doc.getElementById("popup_buttons");if(popup){if(type==="review"&&(desc.textContent=tradThis(REVIEW_TEXT),buttons.appendChild(createPopupButton(REVIEW_URLS[BROWSER],tradThis("Review"))),buttons.appendChild(createPopupButton("https://ko-fi.com/bonjourr",tradThis("Donate")))),type==="announce"){let lang=getLang(),description=ANNOUNCEMENT_TRNS[lang]??ANNOUNCEMENT_TRNS.en,buttontext=`${tradThis("Read the blog post")} \u{1F4DD}`;desc.innerHTML=description,buttons.appendChild(createPopupButton(ANNOUNCEMENT_URL,buttontext))}close?.addEventListener("click",closePopup),document.body.appendChild(popup),popup.classList.add(type),popup.classList.toggle("withIcon",showIcon),openPopup()}}function createPopupButton(href,text){let anchor=document.createElement("a");return anchor.href=href,anchor.rel="noreferrer",anchor.textContent=text,anchor.addEventListener("pointerdown",removePopupTrigger),anchor}function removePopupTrigger(){storage.sync.set({review:-1}),localStorage.removeItem("hasUpdated")}function openPopup(){setTimeout(()=>document.getElementById("popup")?.classList.add("shown"),800),setTimeout(()=>document.getElementById("credit-container")?.setAttribute("style","opacity: 0"),400)}function closePopup(){setTimeout(()=>document.getElementById("popup")?.remove(),200),setTimeout(()=>document.getElementById("credit-container")?.removeAttribute("style"),600),document.getElementById("popup")?.classList.remove("shown"),removePopupTrigger()}function isAnnouncement(str=""){return["all","major","off"].includes(str)}var MOVE_WIDGETS=["time","main","quicklinks","notes","quotes","searchbar"],elements={time:globalThis.document.getElementById("time"),main:globalThis.document.getElementById("main"),quicklinks:globalThis.document.getElementById("linkblocks"),searchbar:globalThis.document.getElementById("sb_container"),notes:globalThis.document.getElementById("notes_container"),quotes:globalThis.document.getElementById("quotes_container")},defaultLayouts={single:{grid:[["time"],["main"],["quicklinks"]],items:{}},double:{grid:[["time","."],["main","."],["quicklinks","."]],items:{}},triple:{grid:[["time",".","."],["main",".","."],["quicklinks",".","."]],items:{}}};function isEditing(){return document.getElementById("interface")?.classList.contains("move-edit")??!1}function hasDuplicateInArray(arr,id){return arr.filter(a=>a===id).length>1}function getLayout(data,selection){if("move"in data){let layouts2=data.move.layouts,selec2=selection??data.move.selection;return layouts2[selec2]??defaultLayouts[selec2]}let layouts=data.layouts,selec=selection??data.selection;return layouts?.[selec]??defaultLayouts[selec]}function gridValidate(grid){return grid.flat().every(val=>val==="."||MOVE_WIDGETS.includes(val))}function gridParse(area=""){let stringToGrid=split=>area.split(split).filter(a=>a.length>1).map(r=>r.split(" ")),result=stringToGrid("'");return gridValidate(result)?result:stringToGrid('"')}function gridStringify(grid){let areas="",itemListToString=row=>row.reduce((a,b)=>`${a} ${b}`);return areas=grid.map(row=>`'${itemListToString(row)}'`).join(" "),areas.trimEnd()}function gridFind(grid,id){let positions=[];return grid.flat().forEach((a,i)=>{if(a!==id)return;let column=i%grid[0].length,row=Math.floor(i/grid[0].length);positions.push([column,row])}),positions}function getSpanDirection(grid,id){let poses=gridFind(grid,id),rows=Object.values(poses).map(([_,row])=>row);return poses.length<2?"none":rows[0]!==rows[1]?"columns":"rows"}function isRowEmpty(grid,index){if(grid[index]===void 0)return!1;let row=grid[index],empty=!0;return row.some(cell=>{cell!=="."&&getSpanDirection(grid,cell)!=="columns"&&(empty=!1)}),empty}function spansInGridArea(grid,id,{toggle,remove}){function addSpans(row2){let target=row2.indexOf(id),stopper=[!1,!1],arr=row2;function replaceWithId(a,i,lim){return!stopper[lim]&&a[i]&&(a[i]==="."?a[i]=id:a[i]!==id&&(stopper[lim]=!0)),a}for(let ii=1;ii<arr.length;ii++)arr=replaceWithId(arr,target+ii,0),arr=replaceWithId(arr,target-ii,1);return arr}function removeSpans(arr){let keepfirst=!0;return arr.map(a=>a===id?(keepfirst&&(keepfirst=!1),"."):a)}let[x,y]=gridFind(grid,id)[0],col=grid.map(g=>g[x]),row=[...grid[y]];return remove&&(col=removeSpans(col),row=removeSpans(row)),toggle&&(toggle==="col"&&(col=hasDuplicateInArray(col,id)?removeSpans(col):addSpans(col)),toggle==="row"&&(row=hasDuplicateInArray(row,id)?removeSpans(row):addSpans(row))),grid.forEach((_,i)=>{grid[i][x]=col[i]}),grid[y].forEach((_,i)=>{grid[y][i]=row[i]}),grid}function getWidgetsStorage(data){let displayed={time:data.time,main:data.main,notes:!!data.notes?.on,searchbar:!!data.searchbar?.on,quicklinks:data.quicklinks,quotes:!!data.quotes?.on};return Object.entries(displayed).filter(([_,val])=>val).map(([key,_])=>key)}function updateWidgetsStorage(states,data){for(let[id,on]of states)id==="time"&&(data.time=on),id==="main"&&(data.main=on),id==="quicklinks"&&(data.quicklinks=on),id==="quotes"&&(data.quotes={...data.quotes,on}),id==="searchbar"&&(data.searchbar={...data.searchbar,on}),id==="notes"&&data.notes&&(data.notes={...data.notes,on});return data}function getGridWidgets(area){let list=area.replaceAll("'","").replaceAll(".","").split(" ");return list.filter((str,i)=>str&&list.indexOf(str)===i)}function addGridWidget(grid,id,selection){let newrow=addGridRow(selection,id),rows=grid.split("'").filter(row=>!(row===" "||row==="")),position=0;if(grid==="")return`'${newrow}'`;let isFirstWidgetTime=rows[0].includes("time"),isLastWidgetQuotes=rows.at(-1)?.includes("quotes");return id==="time"&&(position=0),id==="main"&&(position=isFirstWidgetTime?1:0),id==="notes"&&(position=rows.length===1?1:2),id==="searchbar"&&(position=rows.length===1?1:2),id==="quicklinks"&&(position=rows.length-(isLastWidgetQuotes?1:0)),id==="quotes"&&(position=rows.length),rows.splice(position,0,newrow),rows=rows.map(row=>`'${row}'`),rows.join(" ")}function removeGridWidget(grid,id,_){let rows=grid.split("'").filter(row=>!(row===" "||row===""));return rows=rows.filter(row=>!row.includes(id)),rows=rows.map(row=>`'${row}'`),rows.join(" ")}function addGridRow(selection,id){return`${selection==="triple"?". ":""}${id}${selection==="triple"||selection==="double"?" .":""}`}var import_mod4=__toESM(require_dist()),dominterface=document.querySelector("#interface");function setGridAreas(grid){let property=typeof grid=="string"?grid:gridStringify(grid);document.documentElement.style.setProperty("--grid",property)}function setAlign(id,align){let{box,text}=align??{box:"",text:""},elem=elements[id];elem&&(elem.style.placeSelf=box,id==="quicklinks"?(document.getElementById("linkblocks")?.classList.remove("text-left","text-right"),text==="left"&&document.getElementById("linkblocks")?.classList.add("text-left"),text==="right"&&document.getElementById("linkblocks")?.classList.add("text-right")):elem.style.textAlign=text||"")}function setAllAligns(items){for(let[widget2,align]of Object.entries(items))setAlign(widget2,align)}function addOverlay(id){let button=document.createElement("button");button.id=`move-overlay-${id}`,button.className="move-overlay",dominterface?.appendChild(button),(0,import_mod4.onclickdown)(button,()=>{moveElements(void 0,{select:id})})}function removeOverlay(id){if(id)document.querySelector(`#move-overlay-${id}`)?.remove();else for(let overlay of document.querySelectorAll(".move-overlay"))overlay.remove()}function removeSelection(){let toolbox=document.getElementById("element-mover"),elements2=document.querySelectorAll(".move-overlay, #grid-mover button, .grid-spanner, #element-mover button");for(let elem of elements2)elem.classList.remove("selected"),elem.removeAttribute("disabled");toolbox?.classList.remove("active")}function interfaceFade(fade){if(fade==="in"){let dominterface3=document.getElementById("interface");dominterface3.style.removeProperty("opacity"),setTimeout(()=>{dominterface3.style.transition=""},200)}if(fade==="out"){let dominterface3=document.getElementById("interface");dominterface3.style.opacity="0",dominterface3.style.transition="opacity 200ms cubic-bezier(.215,.61,.355,1)"}}function transitioner(){let waitTimeout,steps={};return{first:cb=>{steps.first=cb},finally:cb=>{steps.finally=cb},after:cb=>{steps.after=cb},cancel:()=>clearTimeout(waitTimeout),transition:async(timeout,...rest2)=>{steps.first&&steps.first(rest2),await new Promise(r=>{waitTimeout=setTimeout(()=>r(!0),Math.min(timeout,2e3))}),steps.after&&steps.after(rest2),steps.finally&&steps.finally(rest2),steps.first=void 0,steps.after=void 0,steps.finally=void 0}}}var weatherFirstStart=!0;function displayWeather(data,lastWeather){let useSinograms=getLang().includes("zh")||getLang().includes("ja"),currentDesc=document.getElementById("current-desc"),currentTemp=document.getElementById("current-temp"),tempContainer=document.getElementById("tempContainer"),weatherdom=document.getElementById("weather"),dot=useSinograms?"\u3002":". ",date=userDate(),handleDescription=()=>{let feels=Math.floor(lastWeather.feels_like),actual=Math.floor(lastWeather.temp),maintemp=data.temperature==="feelslike"?feels:actual,tempReport="";data.temperature==="actual"&&(tempReport=tradThis("It is currently <temp1>\xB0")),data.temperature==="feelslike"&&(tempReport=tradThis("It currently feels like <temp2>\xB0")),data.temperature==="both"&&(tempReport=tradThis("It is currently <temp1>\xB0 and feels like <temp2>\xB0"));let iconText=tempContainer?.querySelector("p"),weatherReport=lastWeather.description[0].toUpperCase()+lastWeather.description.slice(1);tempReport=tempReport.replace("<temp1>",actual.toString()),tempReport=tempReport.replace("<temp2>",feels.toString()),currentDesc&&currentTemp&&iconText&&(currentDesc.textContent=weatherReport+dot,currentTemp.textContent=tempReport,iconText.textContent=`${maintemp}\xB0`)},handleWidget=()=>{let condition=lastWeather.icon_id;if(!tempContainer)return;let now=minutator(date),{sunrise:sunrise2,sunset:sunset2,dusk:dusk2}=suntime(),daytime=now<sunrise2||now>sunset2+dusk2?"night":"day",icon=document.getElementById("weather-icon");icon.dataset.daytime=daytime,icon.dataset.condition=condition},handleForecastData=()=>{let forecastdom=document.getElementById("forecast"),day=date.getHours()>getSunsetHour()?"tomorrow":"today",string2="";day==="today"&&(string2=tradThis("with a high of <temp1>\xB0 today")),day==="tomorrow"&&(string2=tradThis("with a high of <temp1>\xB0 tomorrow")),string2=string2.replace("<temp1>",lastWeather.forecasted_high.toString()),string2+=dot,forecastdom&&(forecastdom.textContent=string2)},handleMoreInfo=()=>{let noDetails=!data.moreinfo||data.moreinfo==="none",emptyCustom=data.moreinfo==="custom"&&!data.provider;if(noDetails||emptyCustom){weatherdom?.removeAttribute("href");return}let urLs={accu:lastWeather.link??"https://www.accuweather.com/",msnw:tradThis("https://www.msn.com/en-xl/weather/forecast/"),yhw:"https://www.yahoo.com/news/weather/",windy:"https://www.windy.com/",custom:data.provider??""};(data.moreinfo||"")in urLs&&weatherdom?.setAttribute("href",urLs[data.moreinfo])};handleForecastDisplay(data.forecast),handleWidget(),handleMoreInfo(),handleDescription(),handleForecastData(),weatherFirstStart&&(weatherFirstStart=!1,weatherdom?.classList.remove("wait"),setTimeout(()=>weatherdom?.classList.remove("init"),900))}function handleForecastDisplay(forecast){let date=userDate(),morningOrLateDay=date.getHours()<12||date.getHours()>getSunsetHour(),isTimeForForecast=forecast==="auto"?morningOrLateDay:forecast==="always";if(isTimeForForecast&&!document.getElementById("forecast")){let p=document.createElement("p");p.id="forecast",document.getElementById("description")?.appendChild(p)}isTimeForForecast||document.querySelector("#forecast")?.remove()}var locationForm=networkForm("f_location"),unitForm=networkForm("f_units"),geolForm=networkForm("f_geol"),suggestionsDebounce=debounce(fillLocationSuggestions,600);async function weatherUpdate(update){let{weather:weather2,hide}=await storage.sync.get(["weather","hide"]),lastWeather=(await storage.local.get("lastWeather")).lastWeather;if(weather2&&hide){if(isUnits(update.units)&&(unitForm.load(),weather2.unit=update.units,lastWeather=await requestNewWeather(weather2,lastWeather)??lastWeather,unitForm.accept()),isForecast(update.forecast)&&(weather2.forecast=update.forecast),isTemperature(update.temp)&&(weather2.temperature=update.temp),isMoreinfo(update.moreinfo)&&(document.getElementById("weather_provider")?.classList.toggle("shown",update.moreinfo==="custom"),weather2.moreinfo=update.moreinfo),update.provider&&(weather2.provider=update.provider),update.unhide){let{weatherdesc,weathericon}=hide||{};weatherdesc&&weathericon&&weatherCacheControl(weather2)}if(update.suggestions){updateSuggestions(update.suggestions);return}if(update.city){updateManualLocation(weather2,lastWeather);return}if(update.geol){updateGeolocation(update.geol,weather2,lastWeather);return}storage.sync.set({weather:weather2}),onSettingsLoad(()=>handleGeolOption(weather2)),lastWeather&&(storage.local.set({lastWeather}),displayWeather(weather2,lastWeather))}}async function updateManualLocation(weather2,lastWeather){let city=document.getElementById("i_city").value;if(removeLocationSuggestions(),!navigator.onLine){locationForm.warn(tradThis("No internet connection"));return}if(city===weather2.city)return;city=stringMaxSize(city,64),locationForm.load();let currentWeather={...weather2,city},newWeather;try{newWeather=await requestNewWeather(currentWeather,lastWeather)}catch(error){locationForm.warn(tradThis(error));return}if(!newWeather){locationForm.warn(tradThis("Cannot reach weather service"));return}newWeather&&(weather2.city=city??"Paris",locationForm.accept("i_city",weather2.city),storage.sync.set({weather:weather2}),storage.local.set({lastWeather:newWeather}),displayWeather(weather2,newWeather))}async function updateGeolocation(geol,weather2,lastWeather){if(geolForm.load(),geol==="precise"&&!await getGeolocation("precise")){geolForm.warn("Cannot get precise location");return}isGeolocation(geol)&&(weather2.geolocation=geol);let newWeather=await requestNewWeather(weather2,lastWeather)??lastWeather;geolForm.accept(),handleGeolOption(weather2),storage.sync.set({weather:weather2}),newWeather&&(storage.local.set({lastWeather}),displayWeather(weather2,newWeather))}function handleGeolOption(data){let iCity=document.querySelector("#i_city"),iGeol=document.querySelector("#i_geol");iCity&&iGeol&&(iGeol.value=data?.geolocation??!1,iCity.setAttribute("placeholder",data.city??"Paris"),document.getElementById("location_options")?.classList.toggle("shown",data.geolocation==="off"))}function updateSuggestions(updateEvent){let fLocation=document.querySelector("#f_location"),iCity=document.querySelector("#i_city"),event=updateEvent;fLocation&&iCity&&event.data!==void 0&&(fLocation?.classList.toggle("valid",iCity.value.length>2),removeLocationSuggestions(),suggestionsDebounce())}function removeLocationSuggestions(){let nodelist=document.querySelector("#dl_cityfound")?.children??[];for(let node of nodelist)node.remove()}async function fillLocationSuggestions(){let dlCityfound=document.querySelector("#dl_cityfound"),city=document.getElementById("i_city").value;if(city===""){removeLocationSuggestions();return}let url=new URL("https://weather.bonjourr.fr/");url.searchParams.set("provider","accuweather"),url.searchParams.set("data","simple"),url.searchParams.set("geo","true"),url.searchParams.set("query",encodeURIComponent(city));try{let resp=await fetch(url);if(removeLocationSuggestions(),resp.status!==200)return;for(let{detail}of await resp.json()){let option=document.createElement("option");option.value=detail,option.textContent=detail,dlCityfound?.appendChild(option)}}catch{}}function isUnits(str=""){return["metric","imperial"].includes(str)}function isForecast(str=""){return["auto","always","never"].includes(str)}function isMoreinfo(str=""){return["none","msnw","yhw","windy","accu","custom"].includes(str)}function isTemperature(str=""){return["actual","feelslike","both"].includes(str)}function isGeolocation(str=""){return["precise","approximate","off"].includes(str)}async function weatherCacheControl(data,lastWeather){if(handleForecastDisplay(data.forecast),!lastWeather){firstStartWeather(data);return}let now=Date.now(),last=lastWeather?.timestamp??0,isAnHourLater=now>last+36e5;if(navigator.onLine&&isAnHourLater){let newWeather=await requestNewWeather(data,lastWeather);if(newWeather){storage.local.set({lastWeather:newWeather}),displayWeather(data,newWeather);return}}displayWeather(data,lastWeather)}async function requestNewWeather(data,lastWeather){if(!navigator.onLine)return lastWeather;let coords2=await getGeolocation(data.geolocation),url=new URL("https://weather.bonjourr.fr/");if(url.searchParams.set("provider","auto"),url.searchParams.set("data","simple"),url.searchParams.set("lang",getLang()),url.searchParams.set("unit",data.unit==="metric"?"C":"F"),coords2?.lat&&coords2?.lon&&(url.searchParams.set("lat",coords2.lat.toString()),url.searchParams.set("lon",coords2.lon.toString())),data.geolocation==="off"&&!coords2){let city=data.city??"Paris",q=encodeURIComponent(city);url.searchParams.set("query",q)}let response=await fetch(url);if(response.status!==200)throw new Error("Cannot get weather");let json=await response?.json(),[sunset2,sunrise2]=[0,0],{temp,feels}=json.now,{description,icon}=json.now,forecastedHigh=lastWeather?.forecasted_high??-273.15,forecastedTimestamp=lastWeather?.forecasted_timestamp??0;if(json.daily){let[today,tomorrow]=json.daily;new Date().getHours()>getSunsetHour()?(forecastedHigh=tomorrow.high,forecastedTimestamp=new Date(tomorrow.time).getTime()):(forecastedHigh=today.high,forecastedTimestamp=new Date(today.time).getTime())}if(json.sun){let[rh,rm]=json.sun.rise,[sh,sm]=json.sun.set,date=new Date;date.setHours(rh,rm,0,0),sunrise2=date.getTime(),date.setHours(sh,sm,0,0),sunset2=date.getTime(),suntime(sunrise2,sunset2)}return{timestamp:Date.now(),forecasted_timestamp:forecastedTimestamp,forecasted_high:forecastedHigh,description,feels_like:feels,icon_id:icon,sunrise:sunrise2,sunset:sunset2,temp,link:json.meta.url??"",approximation:{ccode:json?.geo?.country,city:json?.geo?.city,lat:json?.geo?.lat,lon:json?.geo?.lon}}}async function firstStartWeather(data){let currentWeather=await requestNewWeather(data);currentWeather&&(data.city=currentWeather.approximation?.city??tradThis("City"),storage.sync.set({weather:data}),storage.local.set({lastWeather:currentWeather}),displayWeather(data,currentWeather),setTimeout(()=>handleGeolOption(data),400))}async function getGeolocation(type){let location2={lat:0,lon:0};return type==="precise"&&await new Promise(resolve2=>navigator.geolocation.getCurrentPosition(geo=>{location2.lat=geo.coords.latitude,location2.lon=geo.coords.longitude,resolve2(!0)},()=>{resolve2(!1)})),location2.lat!==0&&location2.lon!==0?location2:void 0}var pollingInterval=0;function weather(init2,update){if(update){weatherUpdate(update);return}if(!init2){console.warn(new Error("No weather data"));return}let mainHidden=!init2.sync.main;!(init2.sync.hide?.weatherdesc&&init2.sync.hide?.weathericon||mainHidden)&&weatherCacheControl(init2.sync.weather,init2.lastWeather),onSettingsLoad(()=>{handleGeolOption(init2.sync.weather)}),queueMicrotask(()=>{clearInterval(pollingInterval),pollingInterval=setInterval(async()=>{let sync=await storage.sync.get(["weather","hide","main"]),local=await storage.local.get("lastWeather");weatherCacheControl(sync.weather,local.lastWeather)},12e5)})}function getSunsetHour(){let d=new Date;return d.setHours(Math.round(suntime().sunset/60)),d.getHours()}function toggleWidget(data,widget2){if(!widget2)return;let[id,on]=widget2,gridToggle=on?addGridWidget:removeGridWidget,interfaceTransition=transitioner(),selection=data.move.selection,layout=getLayout(data),grid=gridParse(gridToggle(gridStringify(layout.grid),id,selection));data.move.layouts[selection]={items:layout.items,grid};let newdata=updateWidgetsStorage([widget2],data);storage.sync.set(newdata),interfaceTransition.first(()=>{toggleWidgetInSettings([[id,on]]),interfaceFade("out")}),interfaceTransition.after(()=>{let layout2=getLayout(newdata);setGridAreas(layout2.grid),setAllAligns(layout2.items),toggleWidgetOnInterface([[id,on]]),removeSelection(),isEditing()&&(on?addOverlay(id):removeOverlay(id)),id==="main"&&on===!0&&storage.local.get("lastWeather").then(local=>{weather({sync:newdata,lastWeather:local.lastWeather})})}),interfaceTransition.finally(()=>{interfaceFade("in")}),interfaceTransition.transition(200)}function toggleWidgetInSettings(states){let inputids={time:"i_time",main:"i_main",quicklinks:"i_quicklinks",notes:"i_notes",quotes:"i_quotes",searchbar:"i_sb"};for(let[widget2,on]of states){let input=document.getElementById(inputids[widget2]);document.getElementById(`${widget2}_options`)?.classList.toggle("shown",on),input.checked=on}}function toggleWidgetOnInterface(states){let domids={time:"time",main:"main",quicklinks:"linkblocks",notes:"notes_container",quotes:"quotes_container",searchbar:"sb_container"};for(let[widget2,on]of states)document.getElementById(domids[widget2])?.classList.toggle("hidden",!on)}var import_mod5=__toESM(require_dist()),moverdom=document.querySelector("#element-mover"),resetTimeout,firstPos={x:0,y:0},moverPos={x:0,y:0};function toolboxEvents(){let elementEntries=Object.entries(elements),moverBtns=document.querySelectorAll("#grid-mover button"),boxAlignBtns=document.querySelectorAll("#box-alignment-mover button"),textAlignBtns=document.querySelectorAll("#text-alignment-mover button"),spanColsBtn=document.querySelector("#grid-span-cols"),spanRowsBtn=document.querySelector("#grid-span-rows"),resetBtn=document.querySelector("#b_resetlayout"),closeBtn=document.querySelector("#close-mover");for(let[key,element]of elementEntries)(0,import_mod5.onclickdown)(element,()=>updateMoveElement({select:key}),{propagate:!1});for(let button of moverBtns)(0,import_mod5.onclickdown)(button,()=>{updateMoveElement({grid:{x:button.dataset.col,y:button.dataset.row}})});for(let button of boxAlignBtns)(0,import_mod5.onclickdown)(button,()=>{updateMoveElement({box:button.dataset.align})});for(let button of textAlignBtns)(0,import_mod5.onclickdown)(button,()=>{updateMoveElement({text:button.dataset.align})});(0,import_mod5.onclickdown)(spanColsBtn,()=>updateMoveElement({span:"col"})),(0,import_mod5.onclickdown)(spanRowsBtn,()=>updateMoveElement({span:"row"})),closeBtn?.addEventListener("click",()=>updateMoveElement({toggle:!1})),resetBtn?.addEventListener("click",()=>updateMoveElement({reset:!0})),moverdom?.addEventListener("mousedown",startDrag2),moverdom?.addEventListener("mouseup",removeDrag),moverdom?.addEventListener("mouseleave",removeDrag),moverdom?.addEventListener("touchstart",startDrag2,{passive:!1}),moverdom?.addEventListener("touchend",removeDrag);function startDrag2(event){let target=event.target,validTags=target?.tagName==="HR"||target?.tagName==="P",validIds=target?.id==="element-mover"||target?.id==="close-mover-wrapper";(validTags||validIds)&&moverdom?.addEventListener(event.type.includes("touch")?"touchmove":"mousemove",moverDrag)}function moverDrag(event){let pos=event.touches?event.touches[0]:event,x=pos.clientX,y=pos.clientY;if(firstPos.x===0&&firstPos.y===0){firstPos={x:x-moverPos.x,y:y-moverPos.y};return}moverPos={x:x-firstPos.x,y:y-firstPos.y},moverdom&&(document.documentElement.style.overscrollBehavior="none",moverdom.style.transform=`translate(${moverPos.x}px, ${moverPos.y}px)`)}function removeDrag(){firstPos={x:0,y:0},moverdom.style.removeProperty("cursor"),document.documentElement.style.removeProperty("overscroll-behavior"),moverdom?.removeEventListener("mousemove",moverDrag),moverdom?.removeEventListener("touchmove",moverDrag)}}function layoutButtons(selection){for(let button of document.querySelectorAll("#grid-layout button"))button.classList.toggle("selected",button.dataset.layout===selection)}function gridButtons(id){let property=document.documentElement?.style.getPropertyValue("--grid")||"",grid=gridParse(property);if(grid.length===0)return;let top=!1,bottom=!1,left=!1,right=!1,positions=gridFind(grid,id),widgetBottomLimit=getGridWidgets(gridStringify(grid)).length-1,rightLimit=grid[0].length-1;for(let[col,row]of positions)if(row===0&&(top=!0),col===0&&(left=!0),col===rightLimit&&(right=!0),row===widgetBottomLimit&&(bottom=!0),row===grid.length-1){let idOnlyRow=grid.at(row)?.filter(id2=>id2!==".");new Set(idOnlyRow).size===1&&(bottom=!0)}for(let button of document.querySelectorAll("#grid-mover button")){let c=Number.parseInt(button.dataset.col||"0"),r=Number.parseInt(button.dataset.row||"0"),limit=!1;r===-1&&(limit=top),r===1&&(limit=bottom),c===-1&&(limit=left),c===1&&(limit=right),toggleDisabled(button,limit)}}function spanButtons(id){let gridstring=document.documentElement?.style.getPropertyValue("--grid")||"",grid=gridParse(gridstring);if(grid.length===0)return;let applyStates=(dir,state)=>{let dirButton=document.querySelector(`#grid-span-${dir}s`),otherButton=document.querySelector(`#grid-span-${dir==="col"?"rows":"cols"}`);toggleDisabled(otherButton,state),dirButton?.classList.toggle("selected",state)},[posCol,posRow]=gridFind(grid,id)[0],col=grid.map(g=>g[posCol]),row=[...grid[posRow]],hasColumnDuplicates=hasDuplicateInArray(col,id),hasRowDuplicates=hasDuplicateInArray(row,id);applyStates("col",hasColumnDuplicates),applyStates("row",hasRowDuplicates)}function alignButtons(align){let{box,text}=align??{box:"",text:""},boxBtns=document.querySelectorAll("#box-alignment-mover button"),textBtns=document.querySelectorAll("#text-alignment-mover button");for(let b of boxBtns)b.classList.toggle("selected",b.dataset.align===(box||"center"));for(let b of textBtns)b.classList.toggle("selected",b.dataset.align===(text||"center"))}function resetButton(){let bResetlayout=document.getElementById("b_resetlayout"),confirm=!!bResetlayout.dataset.confirm;return clearTimeout(resetTimeout),confirm===!1?(bResetlayout.textContent=tradThis("Are you sure?"),bResetlayout.dataset.confirm="true",resetTimeout=setTimeout(()=>{bResetlayout.textContent=tradThis("Reset layout"),bResetlayout.dataset.confirm=""},1e3)):(bResetlayout.textContent=tradThis("Reset layout"),bResetlayout.dataset.confirm=""),confirm}function showSpanButtons(column){column!=="single"?document.getElementById("grid-spanner-container")?.classList.add("active"):document.getElementById("grid-spanner-container")?.classList.remove("active")}var dominterface2=document.querySelector("#interface"),widget;function moveElements(init2,events){if(!(init2||events)){updateMoveElement({reset:!0});return}if(events){updateMoveElement(events);return}if(init2){let{grid,items}=getLayout(init2);setAllAligns(items),setGridAreas(gridStringify(grid)),onSettingsLoad(()=>{toolboxEvents(),showSpanButtons(init2.selection)})}}async function updateMoveElement(event){let data=await storage.sync.get();data.move||(data.move=structuredClone(SYNC_DEFAULT.move)),event.grid&&gridChange(data.move,event.grid),event.span&&toggleGridSpans(data.move,event.span),event.layout&&layoutChange(data,event.layout),event.reset&&layoutReset(data),event.widget&&toggleWidget(data,event.widget),event.select&&elementSelection(data.move,event.select),event.box!==void 0&&alignChange(data.move,event.box,"box"),event.text!==void 0&&alignChange(data.move,event.text,"text"),event.toggle!==void 0&&toggleMoveStatus(data,event.toggle),event.overlay!==void 0&&pageWidthOverlay(data.move,event.overlay)}function gridChange(move,gridpos){if(!widget)return;let y=Number.parseInt(gridpos?.y||"0"),x=Number.parseInt(gridpos?.x||"0"),layout=getLayout(move),positions=gridFind(layout.grid,widget),affectedIds=[],grid=layout.grid;positions.some(([col])=>grid[col+y]===void 0)&&(move.selection==="single"&&grid.push(["."]),move.selection==="double"&&grid.push([".","."]),move.selection==="triple"&&grid.push([".",".","."]));for(let[col,row]of positions){let newposition=grid[row+y][col+x];newposition!=="."&&affectedIds.push(newposition)}for(let id of affectedIds)gridFind(grid,id).length>1&&(grid=spansInGridArea(grid,id,{remove:!0}));for(let[col,row]of positions){let newRow=Math.min(Math.max(row+y,0),grid.length-1),newCol=Math.min(Math.max(col+x,0),grid[0].length-1),tempItem=grid[row][col];grid[row][col]=grid[newRow][newCol],grid[newRow][newCol]=tempItem}for(let i=0;i<grid.length;i++)isRowEmpty(grid,i)&&grid.splice(i,1);layout.grid=grid,move.layouts[move.selection]=layout,storage.sync.set({move}),setGridAreas(grid),gridButtons(widget)}function alignChange(move,value,type){if(!widget)return;let layout=getLayout(move),align=layout.items[widget]??{box:"",text:""};type==="box"&&(align.box=value),type==="text"&&(align.text=value),layout.items[widget]=align,move.layouts[move.selection]=layout,storage.sync.set({move}),alignButtons(align),setAlign(widget,align)}function layoutChange(data,column){if(column===data.move.selection)return;(column==="single"||column==="double"||column==="triple")&&(data.move.selection=column);let layout=getLayout(data),widgetsInGrid=getGridWidgets(gridStringify(layout.grid)),list=[["time",widgetsInGrid.includes("time")],["main",widgetsInGrid.includes("main")],["notes",widgetsInGrid.includes("notes")],["quotes",widgetsInGrid.includes("quotes")],["searchbar",widgetsInGrid.includes("searchbar")],["quicklinks",widgetsInGrid.includes("quicklinks")]],newdata=updateWidgetsStorage(list,data);storage.sync.set(newdata);let interfaceTransition=transitioner();interfaceTransition.first(()=>{interfaceFade("out")}),interfaceTransition.after(()=>{let layout2=getLayout(newdata);setAllAligns(layout2.items),setGridAreas(layout2.grid),layoutButtons(newdata.move.selection),showSpanButtons(newdata.move.selection),removeSelection(),toggleWidgetInSettings(list),toggleWidgetOnInterface(list),widget&&(gridButtons(widget),alignButtons(layout2.items[widget]))}),interfaceTransition.finally(()=>{interfaceFade("in")}),interfaceTransition.transition(200)}function layoutReset(data){let enabledWidgets=getWidgetsStorage(data),grid="";if(resetButton()!==!1){for(let id of enabledWidgets)grid=addGridWidget(grid,id,data.move.selection);data.move.layouts[data.move.selection]={grid:gridParse(grid),items:{}},storage.sync.set(data),removeSelection(),setGridAreas(grid),setAllAligns({quicklinks:void 0,main:void 0,time:void 0,notes:void 0,searchbar:void 0,quotes:void 0})}}function elementSelection(move,select){removeSelection(),isEditing()&&select&&(widget=select,alignButtons(getLayout(move).items[widget]),spanButtons(widget),gridButtons(widget),document.getElementById(`ove-overlay-${widget}`)?.classList.add("selected"),document.getElementById("element-mover")?.classList.add("active"))}function toggleMoveStatus(data,force){let mover=document.getElementById("element-mover"),bEditmove=document.getElementById("b_editmove"),isEditing2=dominterface2?.classList.contains("move-edit"),hasOverlay=document.querySelector(".move-overlay")===null;if(!(force??!isEditing2))bEditmove.textContent=tradThis("Open"),dominterface2?.classList.remove("move-edit"),mover.classList.add("hidden"),removeOverlay();else if(hasOverlay){bEditmove.textContent=tradThis("Close"),dominterface2?.classList.add("move-edit"),mover.classList.remove("hidden");for(let id of getWidgetsStorage(data))addOverlay(id)}mover?.classList.remove("active"),removeSelection()}function toggleGridSpans(move,dir){if(!widget)return;let layout=getLayout(move),gridWithSpan=spansInGridArea(layout.grid,widget,{toggle:dir});move.layouts[move.selection]={items:layout.items,grid:gridWithSpan},storage.sync.set({move}),setGridAreas(gridWithSpan),gridButtons(widget),spanButtons(widget)}function pageWidthOverlay(move,overlay){let isEditing2=document.getElementById("interface")?.classList?.contains("move-edit"),hasOverlays=document.querySelector(".move-overlay");if(!isEditing2&&overlay===!1){removeOverlay();return}if(!hasOverlays){let layout=getLayout(move),grid=gridStringify(layout.grid),ids2=getGridWidgets(grid);for(let id of ids2)addOverlay(id)}}async function hideElements(hide,options){if(hide??={},options?.isEvent){let newhide={...(await storage.sync.get("hide")).hide,...hide};storage.sync.set({hide:newhide})}for(let[key,val]of Object.entries(hide))for(let element of document.querySelectorAll(`[data-hide="${key}"]`))element?.classList.toggle("he_hidden",val)}var features=["clock","links"],interfaceDisplayCallback=()=>{},loadtime=performance.now();function onInterfaceDisplay(callback){callback&&(interfaceDisplayCallback=callback)}function displayInterface(ready,data){if(data){data?.font?.family&&features.push("fonts"),data?.quotes?.on&&features.push("quotes");return}if(!ready)return;let index=features.indexOf(ready);if(index!==-1)features.splice(index,1);else return;if(features.length>0)return;loadtime=Math.min(performance.now()-loadtime,333),loadtime=loadtime>33?loadtime:0,document.documentElement.style.setProperty("--load-time-transition",`${loadtime}ms`),document.body.classList.remove("loading");let delay=Math.max(333,loadtime);setTimeout(()=>interfaceDisplayCallback(),delay)}async function apiWebSocket(path){try{let socket2=new WebSocket(`wss://services.bonjourr.fr/${path}`);if(await new Promise(resolve2=>{socket2.onopen=()=>resolve2(!0),socket2.onerror=()=>resolve2(!1),socket2.onclose=()=>resolve2(!1)}))return socket2}catch{}}async function apiFetch(path){try{return await fetch(`https://services.bonjourr.fr${path}`)}catch{}}function INT(d){return Math.floor(d)}function jdFromDate(dd,mm,yy){let a=INT((14-mm)/12),y=yy+4800-a,m=mm+12*a-3,jd=dd+INT((153*m+2)/5)+365*y+INT(y/4)-INT(y/100)+INT(y/400)-32045;return jd<2299161&&(jd=dd+INT((153*m+2)/5)+365*y+INT(y/4)-32083),jd}function NewMoon(k){let deltat,T=k/1236.85,T2=T*T,T3=T2*T,dr=Math.PI/180,Jd1=241502075933e-5+29.53058868*k+1178e-7*T2-155e-9*T3;Jd1+=33e-5*Math.sin((166.56+132.87*T-.009173*T2)*dr);let M=359.2242+29.10535608*k-333e-7*T2-347e-8*T3,Mpr=306.0253+385.81691806*k+.0107306*T2+1236e-8*T3,F=21.2964+390.67050646*k-.0016528*T2-239e-8*T3,C1=(.1734-393e-6*T)*Math.sin(M*dr)+.0021*Math.sin(2*dr*M);return C1=C1-.4068*Math.sin(Mpr*dr)+.0161*Math.sin(dr*2*Mpr),C1-=4e-4*Math.sin(dr*3*Mpr),C1=C1+.0104*Math.sin(dr*2*F)-.0051*Math.sin(dr*(M+Mpr)),C1=C1-.0074*Math.sin(dr*(M-Mpr))+4e-4*Math.sin(dr*(2*F+M)),C1=C1-4e-4*Math.sin(dr*(2*F-M))-6e-4*Math.sin(dr*(2*F+Mpr)),C1=C1+.001*Math.sin(dr*(2*F-Mpr))+5e-4*Math.sin(dr*(2*Mpr+M)),T<-11?deltat=.001+839e-6*T+2261e-7*T2-845e-8*T3-81e-9*T*T3:deltat=-278e-6+265e-6*T+262e-6*T2,Jd1+C1-deltat}function SunLongitude(jdn){let T=(jdn-2451545)/36525,T2=T*T,dr=Math.PI/180,M=357.5291+35999.0503*T-1559e-7*T2-48e-8*T*T2,L0=280.46645+36000.76983*T+3032e-7*T2,dl=(1.9146-.004817*T-14e-6*T2)*Math.sin(dr*M);dl=dl+(.019993-101e-6*T)*Math.sin(dr*2*M)+29e-5*Math.sin(dr*3*M);let L=L0+dl;return L*=dr,L-=Math.PI*2*INT(L/(Math.PI*2)),L}function getSunLongitude(dayNumber,timeZone){return INT(SunLongitude(dayNumber-.5-timeZone/24)/Math.PI*6)}function getNewMoonDay(k,timeZone){return INT(NewMoon(k)+.5+timeZone/24)}function getLunarMonth11(yy,timeZone){let off=jdFromDate(31,12,yy)-2415021,k=INT(off/29.530588853),nm=getNewMoonDay(k,timeZone);return getSunLongitude(nm,timeZone)>=9&&(nm=getNewMoonDay(k-1,timeZone)),nm}function getLeapMonthOffset(a11,timeZone){let k=INT((a11-2415021076998695e-9)/29.530588853+.5),last=0,i=1,arc=getSunLongitude(getNewMoonDay(k+i,timeZone),timeZone);do last=arc,i++,arc=getSunLongitude(getNewMoonDay(k+i,timeZone),timeZone);while(arc!==last&&i<14);return i-1}function convertSolar2Lunar(dd,mm,yy,timeZone){let dayNumber=jdFromDate(dd,mm,yy),k=INT((dayNumber-2415021076998695e-9)/29.530588853),monthStart=getNewMoonDay(k+1,timeZone);monthStart>dayNumber&&(monthStart=getNewMoonDay(k,timeZone));let a11=getLunarMonth11(yy,timeZone),b11=a11,lunarYear;a11>=monthStart?(lunarYear=yy,a11=getLunarMonth11(yy-1,timeZone)):(lunarYear=yy+1,b11=getLunarMonth11(yy+1,timeZone));let lunarDay=dayNumber-monthStart+1,diff=INT((monthStart-a11)/29),lunarLeap=0,lunarMonth=diff+11;if(b11-a11>365){let leapMonthDiff=getLeapMonthOffset(a11,timeZone);diff>=leapMonthDiff&&(lunarMonth=diff+10,diff===leapMonthDiff&&(lunarLeap=1))}return lunarMonth>12&&(lunarMonth-=12),lunarMonth>=11&&diff<4&&(lunarYear-=1),[lunarDay,lunarMonth,lunarYear,lunarLeap]}function getVnCalendar(date){let can=["Gi\xE1p","\u1EA4t","B\xEDnh","\u0110inh","M\u1EADu","K\u1EF7","Canh","T\xE2n","Nh\xE2m","Qu\xFD"],chi=["T\xFD","S\u1EEDu","D\u1EA7n","M\xE3o","Th\xECn","T\u1EF5","Ng\u1ECD","M\xF9i","Th\xE2n","D\u1EADu","Tu\u1EA5t","H\u1EE3i"],ld=convertSolar2Lunar(date.getDate(),date.getMonth()+1,date.getFullYear(),7),yearCanChi=`${can[(ld[2]+6)%10]} ${chi[(ld[2]+8)%12]}`,leapText=ld[3]?" (nhu\u1EADn)":"";return`\xC2m l\u1ECBch: ${ld[0]} th\xE1ng ${ld[1]}${leapText} n\u0103m ${yearCanChi}`}var defaultAnalogStyle={face:"none",hands:"modern",shape:"round",border:"#ffff",background:"#fff2"},sinogramRegex=/zh-CN|zh-HK|ja/,defaultTimezones=["Europe/Paris","America/Sao_Paulo","America/Los_Angeles","Asia/Tokyo","Asia/Kolkata"],defaultRegions=["Paris","New York","Tokyo","Lisbon","Los Angeles"],oneInFive=Math.random()>.8?1:0,numberWidths=[1],clockInterval;function clock(init2,event){if(event){clockUpdate(event);return}let clock2=init2?.clock??{...SYNC_DEFAULT.clock},world=init2?.worldclocks??{...SYNC_DEFAULT.worldclocks};try{startClock(clock2,world,init2?.greeting||"",init2?.dateformat||"eu"),analogStyle(init2?.analogstyle),clockSize(clock2.size),displayInterface("clock"),onSettingsLoad(toggleWorldClocksOptions)}catch(err){console.info(err)}}async function clockUpdate(update){let data=await storage.sync.get(),analogstyle=data.analogstyle??structuredClone(defaultAnalogStyle);if(update.analog!==void 0&&(document.getElementById("analog_options")?.classList.toggle("shown",update.analog),document.getElementById("digital_options")?.classList.toggle("shown",!update.analog)),isDateFormat(update.dateformat)&&(data.dateformat=update.dateformat,storage.sync.set({dateformat:update.dateformat})),update.greeting!==void 0&&(data.greeting=stringMaxSize(update.greeting,64),greetings(data.greeting),storage.sync.set({greeting:data.greeting})),update.greetingsize!==void 0&&greetingSize(update.greetingsize),update.timezone!==void 0&&(userDate(update.timezone),greetings(data.greeting)),isHands(update.hands)&&(analogstyle.hands=update.hands),isShape(update.shape)&&(analogstyle.shape=update.shape),isFace(update.face)&&(analogstyle.face=update.face),update.background||update.border){let option=update.background?"background":"border";analogstyle[option]=hexColorFromSplitRange(`#analog-${option}-range`),analogStyle(analogstyle),update?.[option]==="opacity"&&eventDebounce({analogstyle}),update?.[option]==="shade"&&storage.sync.set({analogstyle});return}if(update.world!==void 0){let index=update.world.index,baseclock={region:defaultRegions[index],timezone:defaultTimezones[index]},worldclock=data.worldclocks?.[index]??baseclock,{region,timezone}=update.world;region!==void 0&&(worldclock.region=region),timezone!==void 0&&(worldclock.timezone=timezone),data.worldclocks[index]=worldclock,toggleWorldClocksOptions()}data.clock={ampm:update.ampm??data.clock.ampm,size:update.size??data.clock.size,analog:update.analog??data.clock.analog,seconds:update.seconds??data.clock.seconds,timezone:update.timezone??data.clock.timezone,ampmlabel:update.ampmlabel??data.clock.ampmlabel,worldclocks:update.worldclocks??data.clock.worldclocks},storage.sync.set({clock:data.clock,worldclocks:data.worldclocks,analogstyle,dateformat:data.dateformat}),startClock(data.clock,data.worldclocks,data.greeting,data.dateformat),analogStyle(data.analogstyle),clockSize(data.clock.size)}function analogStyle(style=structuredClone(defaultAnalogStyle)){let{face,shape,hands}=style,time=document.getElementById("time"),spans=document.querySelectorAll(".analog .analog-face span"),backgroundAlpha=Number.parseInt(style.background.slice(4),16),isWhiteOpaque=style.background?.includes("fff")&&backgroundAlpha>7,isTransparent=backgroundAlpha===0,faceNumbers=["12","3","6","9"],lang=getLang();lang==="am"?faceNumbers=["\u0533","\u0536","\u0539","\u053A\u0532"]:lang==="ar"?faceNumbers=["\u0663","\u0666","\u0669","\u0661\u0662"]:lang==="fa"?faceNumbers=["\u06F3","\u06F6","\u06F9","\u06F1\u06F2"]:lang.match(sinogramRegex)&&(faceNumbers=["\u4E09","\u516D","\u4E5D","\u5341\u4E8C"]),spans.forEach((span,i)=>{face==="roman"?span.textContent=["XII","III","VI","IX"][i%4]:face==="marks"?span.textContent=["\u2502","\u2015","\u2502","\u2015"][i%4]:face==="number"?span.textContent=faceNumbers[i%4]:span.textContent=""}),time.dataset.face=face==="swiss"||face==="braun"?face:"",time.dataset.shape=shape||"",time.dataset.hands=hands||"",time.classList.toggle("transparent",isTransparent),time.classList.toggle("white-opaque",isWhiteOpaque),time.style.setProperty("--analog-border",style.border),time.style.setProperty("--analog-background",style.background)}function clockSize(size=5){document.documentElement.style.setProperty("--clock-size",`${size.toString()}em`)}function greetingSize(size="3"){document.documentElement.style.setProperty("--greeting-size",`${size}em`)}function startClock(clock2,world,greeting,dateformat){document.getElementById("time")?.classList.toggle("is-analog",clock2.analog),document.getElementById("time")?.classList.toggle("seconds",clock2.seconds),document.querySelectorAll(".clock-wrapper").forEach((node,index)=>{index>0&&node.remove()});let clocks=[];clock2.seconds&&!clock2.analog&&setSecondsWidthInCh(),clock2.worldclocks&&clocks.push(...world.filter(({region})=>region)),clocks.length===0&&clocks.push({region:"",timezone:clock2.timezone}),clearInterval(clockInterval),start(!0),clockInterval=setInterval(start,1e3);function start(firstStart){for(let index=0;index<clocks.length;index++){let{region,timezone}=clocks[index],domclock=getClock(index),domregion=domclock.querySelector(".clock-region"),date=userDate(timezone),isNextHour=date.getMinutes()===0;clock2.analog?analog(domclock,clock2,timezone):digital(domclock,clock2,timezone),(isNextHour||firstStart)&&clockDate(domclock,date,dateformat,timezone),domregion&&(domregion.textContent=region)}greetings(greeting)}}function getClock(index){let container2=document.getElementById("time-container"),wrapper=document.querySelector(`.clock-wrapper[data-index="${index}"]`);if(wrapper)return wrapper;let clone=document.getElementById("clock-wrapper")?.cloneNode(!0);return clone.removeAttribute("id"),clone.dataset.index=index.toString(),container2?.appendChild(clone),clone}function digital(wrapper,clock2,timezone){let date=userDate(timezone),domclock=wrapper.querySelector(".digital"),hh=wrapper.querySelector(".digital-hh"),mm=wrapper.querySelector(".digital-mm"),ss=wrapper.querySelector(".digital-ss"),m=fixunits(date.getMinutes()),s=fixunits(date.getSeconds()),h=clock2.ampm?date.getHours()%12:date.getHours();if(domclock){if(clock2.ampmlabel?domclock.dataset.ampmLabel="":delete domclock.dataset.ampmLabel,clock2.ampm?domclock.dataset.ampm=date.getHours()<12?"am":"pm":delete domclock.dataset.ampm,clock2.ampm&&h===0&&(h=12),clock2.seconds){let second=date.getSeconds()<10?0:Math.floor(date.getSeconds()/10),width=getSecondsWidthInCh(second).toFixed(1);domclock.style.setProperty("--seconds-width",`${width}ch`)}domclock.classList.toggle("zero",!clock2.ampm&&h<10),hh.textContent=h.toString(),mm.textContent=m.toString(),ss.textContent=s.toString()}}function analog(wrapper,clock2,timezone){let date=userDate(timezone),m=((date.getMinutes()+date.getSeconds()/60)*6).toFixed(1),h=((date.getHours()%12+date.getMinutes()/60)*30).toFixed(1),s=(date.getSeconds()*6).toFixed(1);wrapper.querySelector(".analog-hours")?.style.setProperty("--deg",`${h}deg`),wrapper.querySelector(".analog-minutes")?.style.setProperty("--deg",`${m}deg`),clock2.seconds&&wrapper.querySelector(".analog-seconds")?.style.setProperty("--deg",`${s}deg`)}function clockDate(wrapper,date,dateformat,timezone){let datedom=wrapper.querySelector(".clock-date"),aa=wrapper.querySelector(".clock-date-aa"),bb=wrapper.querySelector(".clock-date-bb"),cc=wrapper.querySelector(".clock-date-cc"),secondary=wrapper.querySelector(".clock-date-secondary"),lang=getLang().replaceAll("_","-"),day=new Intl.DateTimeFormat(lang,{day:"numeric"}).format(date),month=new Intl.DateTimeFormat(lang,{month:"long"}).format(date),weekday=new Intl.DateTimeFormat(lang,{weekday:"long"}).format(date);if(datedom.classList.remove("eu","us","cn"),datedom.classList.add(dateformat),dateformat==="auto"){let intl=new Intl.DateTimeFormat(lang,{weekday:"long",month:"long",day:"numeric"});aa.textContent=intl.format(date),bb.textContent="",cc.textContent=""}dateformat==="eu"&&(aa.textContent=weekday,bb.textContent=day,cc.textContent=month),dateformat==="us"&&(aa.textContent=weekday,bb.textContent=month,cc.textContent=day),dateformat==="cn"&&(aa.textContent=month,bb.textContent=day,cc.textContent=weekday),lang==="vi"&&(timezone==="auto"||timezone==="Asia/Ho_Chi_Minh")?secondary.textContent=getVnCalendar(date):secondary.textContent=""}function greetings(name){let date=userDate(),domgreetings=document.getElementById("greetings"),domgreeting=document.getElementById("greeting"),domname=document.getElementById("greeting-name"),rare=oneInFive,hour=date.getHours(),period;hour<3?period="evening":hour<5?period="night":hour<12?period="morning":hour<18?period="afternoon":period="evening";let greet={morning:"Good morning",afternoon:"Good afternoon",evening:"Good evening",night:["Good night","Sweet dreams"][rare]}[period];domgreetings.style.textTransform=name||rare&&period==="night"?"none":"capitalize",domgreeting.textContent=tradThis(greet)+(name?", ":""),domname.textContent=name??""}function toggleWorldClocksOptions(){let parents=document.querySelectorAll(".worldclocks-item"),inputs=document.querySelectorAll(".worldclocks-item input");parents.forEach((parent,i)=>{let currHasText=!!inputs[i]?.value,nextHasText=!!inputs[i-1]?.value;parent?.classList.toggle("shown",i===0||currHasText||nextHasText)})}function setSecondsWidthInCh(){let span=document.querySelector(".digital-number-width");if(!span)return;let zero=span.offsetWidth;numberWidths=[1];for(let i=1;i<6;i++)span.textContent=i.toString(),numberWidths.push(Math.round(span.offsetWidth/zero*10)/10)}function getSecondsWidthInCh(second){return Math.min(...numberWidths)+numberWidths[second]}function fixunits(val){return(val<10?"0":"")+val.toString()}function isFace(str){return["none","number","roman","marks","swiss","braun"].includes(str??"")}function isHands(str){return["modern","swiss","classic","braun","apple"].includes(str??"")}function isShape(str){return["round","square","rectangle"].includes(str??"")}function isDateFormat(str=""){return["auto","eu","us","cn"].includes(str)}var familyForm=networkForm("f_customfont"),systemfont=(()=>{let fonts={fallback:{placeholder:"Arial",weights:["500","600","800"]},windows:{placeholder:"Segoe UI",weights:["300","400","600","700","800"]},android:{placeholder:"Roboto",weights:["100","300","400","500","700","900"]},linux:{placeholder:"Fira Sans",weights:["100","200","300","400","500","600","700","800","900"]},apple:{placeholder:"SF Pro Display",weights:["100","200","300","400","500","600","700","800","900"]}};return SYSTEM_OS==="windows"?fonts.windows:SYSTEM_OS==="android"?fonts.android:SYSTEM_OS==="mac"||SYSTEM_OS==="ios"?fonts.apple:fonts.linux})();function customFont(init2,event){if(event){updateCustomFont(event);return}if(init2)try{let font=migrateToNewFormat(init2);displayFont(font),displayInterface("fonts"),onSettingsLoad(()=>{initFontSettings(font)})}catch{}}async function updateCustomFont({family,weight,size,lang,autocomplete}){if(autocomplete){setAutocompleteSettings();return}let data=await storage.sync.get("font");if(family!==void 0&&(data.font=await updateFontFamily(data,family)),weight&&(data.font.weight=weight||"400",displayFont(data.font)),size&&(data.font.size=size,setFontSize(size)),lang){handleLangSwitch(data.font);return}eventDebounce({font:data.font})}async function updateFontFamily(data,family){let iWeight=document.getElementById("i_weight"),familyType=family.length===0?"none":systemFontChecker(family)?"system":"fontsource",font={family:"",system:!0,size:data.font.size,weight:SYSTEM_OS==="windows"?"400":"300",weightlist:systemfont.weights};switch(familyType){case"fontsource":{familyForm.load();let newfont=await getNewFont(font,family);if(newfont&&navigator.onLine&&(font={...font,...newfont},displayFont(font),await waitForFontLoad(family),familyForm.accept("i_customfont",family),clock(void 0,{})),font.family==="")return familyForm.warn(tradThis("Cannot load this font")),data.font;break}case"system":{font.family=family,displayFont(font),familyForm.accept("i_customfont",family);break}default:displayFont(font),familyForm.accept("i_customfont",systemfont.placeholder)}return clock(void 0,{}),setWeightSettings(font.weightlist),iWeight.value=font.weight,font}async function handleLangSwitch(font){if(!font.family||font?.system)return;let newfont=await getNewFont(font,font.family);if(newfont===void 0){updateCustomFont({family:""});return}font.family=newfont.family,font.weight=newfont.weight,font.weightlist=newfont.weightlist,displayFont(font),setAutocompleteSettings(!0)}async function getNewFont(font,newfamily){let fontlist=await(await apiFetch("/fonts"))?.json()??[],newfont;for(let item of fontlist){let hasCorrectSubset=item.subsets.includes(getRequiredSubset()),isFamily=item.family.toLowerCase()===newfamily.toLowerCase();hasCorrectSubset&&isFamily&&(newfont=item)}if(newfont)return font.weight="400",font.system=!1,font.family=newfamily,font.weightlist=newfont.weights.map(w=>w.toString()),font}function displayFont({family,size,weight,system}){let clockWeight=Number.parseInt(weight)>100?systemfont.weights[systemfont.weights.indexOf(weight)-1]:weight,subset=getRequiredSubset(),id=family.toLocaleLowerCase().replaceAll(" ","-"),fontfacedom=document.getElementById("fontface");if(!system){let fontface=`
			@font-face {font-family: "${family}";
				src: url(https://cdn.jsdelivr.net/fontsource/fonts/${id}@latest/latin-${weight}-normal.woff2) format('woff2');
			}
		`;subset!=="latin"&&(fontface+=fontface.replace("latin",subset)),fontfacedom&&(fontfacedom.textContent+=fontface)}document.documentElement.style.setProperty("--font-family",family?`"${family}"`:null),document.documentElement.style.setProperty("--font-weight",weight),document.documentElement.style.setProperty("--font-weight-clock",family?weight:clockWeight),setFontSize(size)}function setFontSize(size){document.documentElement.style.setProperty("--font-size",`${Number.parseInt(size)/16}em`)}function initFontSettings(font){let weights=font&&font.weightlist.length>0?font.weightlist:systemfont.weights;setWeightSettings(weights)}async function setAutocompleteSettings(isLangSwitch){let dlFontfamily=document.querySelector("#dl_fontfamily");if(isLangSwitch&&dlFontfamily?.childNodes)for(let node of dlFontfamily.childNodes)node.remove();if(dlFontfamily?.childElementCount===0){let fontlist=await(await apiFetch("/fonts"))?.json()??[],fragment=new DocumentFragment,requiredSubset=getRequiredSubset();for(let item of fontlist)if(item.subsets.includes(requiredSubset)){let option=document.createElement("option");option.textContent=item.family,option.value=item.family,fragment.appendChild(option)}dlFontfamily?.appendChild(fragment)}}function setWeightSettings(weights){let options=document.querySelectorAll("#i_weight option");for(let option of options)option.classList.toggle("hidden",weights.includes(option.value)===!1)}async function fontIsAvailableInSubset(lang,family){let font=(await(await apiFetch("/fonts"))?.json())?.find(item=>item.family===family),subset=getRequiredSubset(lang);return font?.subsets.includes(subset)}function systemFontChecker(family){let p=document.createElement("p");p.setAttribute("style","position: absolute; opacity: 0; font-family: invalid font;"),p.textContent=`mqlskdjfhgpaozieurytwnxbcv?./,;:1234567890${tradThis("New tab")}`,document.getElementById("interface")?.prepend(p);let firstW=p.getBoundingClientRect().width;p.style.fontFamily=`'${family}'`;let secondW=p.getBoundingClientRect().width,hasLoadedFont=firstW!==secondW;return p.remove(),hasLoadedFont}function waitForFontLoad(family){return new Promise(resolve2=>{let limitcounter=0,hasLoadedFont=systemFontChecker(family),interval=setInterval(()=>{if(hasLoadedFont||limitcounter===100)return clearInterval(interval),resolve2(!0);hasLoadedFont=systemFontChecker(family),limitcounter++},100)})}function getRequiredSubset(lang=getLang()){let subset="latin";return lang in subsets&&(subset=subsets[lang]),subset}function migrateToNewFormat(font){return font?.weightlist||(font.availWeights&&(font.weightlist=font.availWeights),font.system=systemFontChecker(font.family),font.availWeights=void 0,font.url=void 0,storage.local.remove("fontface"),storage.local.remove("fonts"),storage.sync.remove("font"),setTimeout(()=>storage.sync.set({font}))),font}function getDefaultIcon(url,refresh){return refresh?`${API_DOMAIN}/favicon/blob/${url}?r=${refresh}`:`${API_DOMAIN}/favicon/blob/${url}`}function getSelectedIds(){let selected=document.querySelectorAll("li.selected");return Object.values(selected).map(li=>li.id)}function getLiFromEvent(event){let li=event.composedPath().find(el=>el.tagName==="LI"&&el.className?.includes("link"));if(li)return li}function getTitleFromEvent(event){let title=event.composedPath().find(el=>el.className?.includes("link-title"));if(title)return title}function createTitle(link){let isInline=document.getElementById("linkblocks")?.className.includes("inline"),isText=document.getElementById("linkblocks")?.className.includes("text");if(!(isInline||isText)||link.title!=="")return stringMaxSize(link.title,64);try{isElem(link)?link.title=new URL(link.url)?.hostname.replace("www.",""):link.title=tradThis("folder")}catch{}return link.title}function getLink(data,id){let val=data[id];if(isLink(val))return val}function getLinksInGroup(data,group){let groupName=group??data.linkgroups.selected,links=[];for(let value of Object.values(data))isLink(value)&&(value?.parent??0)===groupName&&links.push(value);return links.sort((a,b)=>a.order-b.order),links}function getLinksInFolder(data,id){let links=[];for(let value of Object.values(data))isElem(value)&&value?.parent===id&&links.push(value);return links.sort((a,b)=>a.order-b.order),links}function isLink(link){return(link?._id??"").startsWith("links")}function isElem(link){return link?.folder!==!0}var domlinkblocks=document.getElementById("linkblocks"),domeditlink=document.getElementById("editlink"),domtitle=document.getElementById("e-title"),domurl=document.getElementById("e-url"),domicon=document.getElementById("e-icon"),editStates;async function openEditDialog(event){let path=getComposedPath(event.target),classNames=path.map(element=>element.className??""),linkelem=path.find(el=>el?.className?.includes("link")&&el?.tagName==="LI"),linkgroup=path.find(el=>el?.className?.includes("link-group")),linktitle=path.find(el=>el?.className?.includes("link-title")),pointer=event,ctrlRightClick=pointer.button===2&&!!pointer.ctrlKey&&event.type==="contextmenu",pressingE=event.type==="keyup"&&event.code!=="KeyE";if(ctrlRightClick||pressingE)return;let container2={mini:path.some(element=>element?.id?.includes("link-mini")),group:classNames.some(cl=>cl.includes("link-group")&&!cl.includes("in-folder")),folder:classNames.some(cl=>cl.includes("link-group")&&cl.includes("in-folder"))},target={link:classNames.some(cl=>cl.includes("link-elem")),folder:classNames.some(cl=>cl.includes("link-folder")),title:classNames.some(cl=>cl.includes("link-title")),synced:classNames.some(cl=>cl.includes("synced")),addgroup:classNames.some(cl=>cl.includes("add-group"))},selectall=classNames.some(cl=>cl.includes("select-all")),dragging=classNames.some(cl=>cl.includes("dragging")||cl.includes("dropping")),group=(container2.mini?linktitle:linkgroup)?.dataset.group??"",folder=document.querySelector(".link-group.in-folder")?.dataset?.folder??"";editStates={group,folder,selectall,container:container2,dragging,target,selected:getSelectedIds()};let inputs=toggleEditInputs(),folderTitle=container2.folder&&target.title,noSelection=selectall&&editStates.selected.length===0;if(inputs.length===0||folderTitle||noSelection||dragging){closeEditDialog();return}document.dispatchEvent(new Event("stop-select-all")),event.preventDefault();let data=await storage.sync.get();if(target.title){let{groups:groups2,pinned}=data.linkgroups,title=editStates.target.addgroup?"":editStates.group;domeditlink.dataset.group=title,domtitle.value=title;let onlyOneTitleUnpinned=groups2.length-pinned.length<2,onlyOneTitleLeft=groups2.length<2;onlyOneTitleUnpinned&&document.getElementById("edit-pin")?.setAttribute("disabled",""),onlyOneTitleLeft&&document.getElementById("edit-delete")?.setAttribute("disabled","")}if(target.folder||target.link){let id=path.filter(el=>el.tagName==="LI")[0]?.id,link=getLink(data,id);if(domtitle.value=link?.title??"",link&&!link.folder){let icon=link.icon??"";domurl.value=link.url??"",domicon.value=Number.isNaN(Number.parseInt(icon))?icon:""}}if(!selectall){for(let node of document.querySelectorAll(".link-title.selected, .link.selected")??[])node.classList.remove("selected");(target.title?linktitle:linkelem)?.classList.add("selected")}editStates.selected=getSelectedIds();let contextmenuTransition=transitioner();contextmenuTransition.first(()=>domeditlink?.show()),contextmenuTransition.after(()=>domeditlink?.classList?.add("shown")),contextmenuTransition.transition(10);let{x,y}=newEditDialogPosition(event);domeditlink.style.transform=`translate(${Math.floor(x)}px, ${Math.floor(y)}px)`,domtitle?.focus()}function toggleEditInputs(){let deleteButtonTxt=document.querySelector("#edit-delete span"),addButtonTxt=document.querySelector("#edit-add span"),{container:container2,target,selectall}=editStates,inputs=[];for(let node of domeditlink.querySelectorAll("label, button, hr"))node.classList.remove("on");document.querySelector("#edit-delete")?.removeAttribute("disabled"),document.querySelector("#edit-pin")?.removeAttribute("disabled"),domurl.value="",domicon.value="",domtitle.value="",container2.mini&&(target.synced?inputs=["pin","delete"]:target.addgroup?inputs=["title","add"]:target.title&&(inputs=["title","delete","pin","apply"])),container2.group&&(target.synced&&!target.title?inputs=["synced"]:target.synced&&target.title?inputs=["unpin","delete"]:selectall?inputs=["delete","refresh","add"]:target.title?inputs=["title","delete","unpin","apply"]:target.folder?inputs=["title","delete","apply"]:target.link?inputs=["title","url","icon","delete","refresh","apply"]:inputs=["title","url","add"]),container2.folder&&(target.title?inputs=[]:selectall?inputs=["delete","unfolder"]:target.link?inputs=["title","url","icon","delete","apply","unfolder"]:inputs=["title","url","add"]);for(let id of inputs)domeditlink.querySelector(`#edit-${id}`)?.classList.add("on");let hasLabels=inputs.includes("title")||inputs.includes("url")||inputs.includes("icon");return domeditlink.querySelector("hr")?.classList.toggle("on",hasLabels),deleteButtonTxt&&(selectall?deleteButtonTxt.textContent=tradThis("Delete selected"):target.folder?deleteButtonTxt.textContent=tradThis("Delete folder"):target.link?deleteButtonTxt.textContent=tradThis("Delete link"):target.title&&(deleteButtonTxt.textContent=tradThis("Delete group"))),addButtonTxt&&(selectall?addButtonTxt.textContent=tradThis("Create new folder"):target.title?addButtonTxt.textContent=tradThis("Add new group"):addButtonTxt.textContent=tradThis("Add new link")),inputs}function newEditDialogPosition(event){let editRects=domeditlink.getBoundingClientRect(),withPointer=event.type==="contextmenu"||event.type==="click"||event.type==="touchstart",withKeyboard=event.type==="keyup"&&event?.key==="e",{innerHeight,innerWidth}=window,isMobileSized=innerWidth<600,docLang=document.documentElement.lang,rightToLeft=docLang==="ar"||docLang==="fa"||docLang==="he",x=0,y=0;withPointer&&isMobileSized?(x=(innerWidth-editRects.width)/2,y=(event.type==="touchstart"?event.touches[0].clientY:event.y)-60-editRects.height):withPointer?(x=(event.type==="touchstart"?event.touches[0].clientX:event.x)+20,y=(event.type==="touchstart"?event.touches[0].clientY:event.y)+20):withKeyboard&&(x=event.target.offsetLeft,y=event.target.offsetTop);let w=editRects.width+30,h=editRects.height+30;return x+w>innerWidth&&(x-=x+w-innerWidth),y+h>innerHeight&&(y-=h),rightToLeft&&(x*=-1),{x,y}}queueMicrotask(()=>{if(document.addEventListener("close-edit",closeEditDialog),document.getElementById("editlink-form")?.addEventListener("submit",submitChanges),domlinkblocks?.addEventListener("contextmenu",openEditDialog),SYSTEM_OS==="ios"||!IS_MOBILE){let handleLongPress=debounce(event=>{openEditDialog(event)},500);domlinkblocks?.addEventListener("touchstart",event=>{handleLongPress(event)}),domlinkblocks?.addEventListener("touchend",()=>{handleLongPress.cancel()}),globalThis.addEventListener("resize",closeEditDialog)}});function submitChanges(event){let change=event.submitter?.id,{container:container2,target,group,folder,selected,selectall}=editStates;if(change==="edit-apply"&&applyLinkChanges("button"),change==="edit-refresh"&&quickLinks(void 0,{refreshIcons:selected}),change==="edit-inputs"){applyLinkChanges("inputs"),event.preventDefault();return}change==="edit-delete"&&(target.title?quickLinks(void 0,{deleteGroup:group}):quickLinks(void 0,{deleteLinks:selected})),change==="edit-add"&&(container2.folder?quickLinks(void 0,{addLinks:[{group:folder,title:domtitle.value,url:domurl.value}]}):target.title?quickLinks(void 0,{addGroups:[{title:domtitle.value}]}):selectall?(document.dispatchEvent(new Event("remove-select-all")),quickLinks(void 0,{addFolder:{ids:selected,group}})):container2.group&&quickLinks(void 0,{addLinks:[{group,title:domtitle.value,url:domurl.value}]})),change==="edit-unfolder"&&(document.dispatchEvent(new Event("remove-select-all")),quickLinks(void 0,{moveOutFolder:{ids:editStates.selected,group:editStates.group}})),change==="edit-pin"&&togglePinGroup(group,"pin"),change==="edit-unpin"&&togglePinGroup(group,"unpin"),event.preventDefault(),setTimeout(closeEditDialog)}function applyLinkChanges(origin){let id=editStates.selected[0],li=document.querySelector(`#${id}`),inputs=document.querySelectorAll("#editlink input");if(editStates.target.addgroup){quickLinks(void 0,{addGroups:[{title:domtitle.value}]}),closeEditDialog();return}if(editStates.target.title){quickLinks(void 0,{groupTitle:{old:domeditlink.dataset.group??"",new:domtitle.value}}),closeEditDialog();return}if(editStates.container.folder&&editStates.selected.length===0&&domurl.value){quickLinks(void 0,{addLinks:[{group:editStates.folder,title:domtitle.value,url:domurl.value}]}),closeEditDialog();return}if(editStates.container.group&&!editStates.target.link&&!editStates.target.folder){quickLinks(void 0,{addLinks:[{group:editStates.group,title:domtitle.value,url:domurl.value}]}),closeEditDialog();return}if(id&&li){if(origin==="inputs")for(let node of inputs)node.blur();quickLinks(void 0,{updateLink:{id,title:document.querySelector("#e-title")?.value??"",icon:document.querySelector("#e-icon")?.value,url:document.querySelector("#e-url")?.value}}),closeEditDialog()}}function closeEditDialog(){if(domeditlink.open){let selected=document.querySelectorAll(".link-title.selected, .link.selected");for(let node of selected)node?.classList.remove("selected");domeditlink.removeAttribute("data-tab"),domeditlink.classList.remove("shown"),domeditlink.close()}}var blocks=new Map,groups=new Map,dropzones={group:new Map,link:new Map,mini:new Map},[dx,dy,cox,coy,lastIndex]=[0,0,0,0,0,0],lastdropAreas=[""],draggedGroup="",draggedId="",targetId="",targetGroup="",ids=[],initids=[],coords=[],dragContainers,dragChangeParentTimeout=0,dragAnimationFrame=0,domlinkblocks2=document.getElementById("linkblocks"),domlinklinks,domlinktitles,domlinkgroups,domlinkgroup;function startDrag(event){let path=event.composedPath(),type=path.some(element=>element?.className?.includes("link-title"))?"mini":"link",isMini=type==="mini";if(event.button>0)return;if(event.type==="pointerdown"){beforeStartDrag(event,type);return}ids=[],coords=[],initids=[],lastdropAreas=[],blocks.clear(),dropzones.group.clear(),dropzones.link.clear(),dropzones.mini.clear(),domlinkgroup=path.find(node=>node?.classList?.contains("link-group")),domlinkgroups=document.querySelectorAll("#linkblocks .link-group"),domlinklinks=document.querySelectorAll("#linkblocks li"),domlinktitles=document.querySelectorAll("#link-mini button"),dragContainers=document.querySelectorAll(isMini?"#link-mini":".link-group");let tagName=isMini?"BUTTON":"LI",target=path.find(node=>node.tagName===tagName),pos=getPosFromEvent(event);draggedId=findIdFromElement(target),draggedGroup=findIdFromElement(isMini?target:domlinkgroup),targetGroup=draggedGroup;let groupSizeOffsets=new Map;if(isMini){let beforeMap=new Map;for(let group of domlinktitles)beforeMap.set(group.dataset.group??"",group.getBoundingClientRect().x),group.style.width="12ch";for(let group of domlinktitles){let id=group.dataset.group??"",before=beforeMap.get(id)??0,after=group.getBoundingClientRect().x;groupSizeOffsets.set(id,after-before)}}for(let element of[...domlinkgroups,...domlinktitles,...domlinklinks]){let type2=findTypeFromElement(element),rect=element.getBoundingClientRect(),id=findIdFromElement(element);type2!=="group"?blocks.set(id,element):groups.set(id,element),dropzones[type2].set(id,{x:rect.x,y:rect.y,h:rect.height,w:rect.width})}for(let container2 of Object.values(dragContainers)){let elements2=container2.querySelectorAll(tagName),rect=(isMini?container2:container2.querySelector(".link-list"))?.getBoundingClientRect();if(rect){for(let element of elements2){let type2=findTypeFromElement(element),id=findIdFromElement(element,type2),{x,y,w,h}=dropzones[type2].get(id)??{x:0,y:0,w:0,h:0};x-=rect?.x,y-=rect?.y,ids.push(id),initids.push(id),coords.push({x,y,w,h}),element.style.transition="none",setTimeout(()=>element.style.removeProperty("transition"),10),deplaceElem(element,x,y),id===draggedId&&(cox=pos.x-x+(groupSizeOffsets.get(id)??0),coy=pos.y-y,dx=pos.x,dy=pos.y,element.classList.add("on"))}container2.style.setProperty("--drag-width",`${Math.floor(rect?.width??0)}px`),container2.style.setProperty("--drag-height",`${Math.floor(rect?.height??0)}px`),container2.classList.add("in-drag","dragging")}}document.dispatchEvent(new Event("remove-select-all")),dragAnimationFrame=globalThis.requestAnimationFrame(deplaceDraggedElem),event.pointerType==="touch"?(document.documentElement.addEventListener("touchmove",moveDrag,{passive:!1}),document.documentElement.addEventListener("touchend",endDrag,{passive:!1})):(document.documentElement.addEventListener("pointermove",moveDrag),document.documentElement.addEventListener("pointerup",endDrag),document.documentElement.addEventListener("pointerleave",endDrag))}function beforeStartDrag(event,type){let target=type==="mini"?getTitleFromEvent(event):getLiFromEvent(event);if(cox=event.offsetX,coy=event.offsetY,!target)return;target?.addEventListener("pointermove",pointerDeadzone),target?.addEventListener("pointerup",pointerDeadzone);function pointerDeadzone(event2){let precision=event2.pointerType==="touch"?7:14,ox=Math.abs(cox-event2.offsetX),oy=Math.abs(coy-event2.offsetY),isEndEvents=event2.type.includes("pointerup")||event2.type.includes("touchend"),isHalfOutside=ox>precision/2||oy>precision/2,isOutside=ox>precision||oy>precision;isHalfOutside&&document.dispatchEvent(new Event("stop-select-all")),isOutside&&startDrag(event2),(isOutside||isEndEvents)&&(target?.removeEventListener("pointermove",pointerDeadzone),target?.removeEventListener("pointerup",pointerDeadzone))}}function moveDrag(event){let{x,y}=getPosFromEvent(event);dx=x-cox,dy=y-coy;let[curr,id,type]=isDraggingOver({x,y})??["",""],last=lastdropAreas[lastdropAreas.length-1],secondlast=lastdropAreas[lastdropAreas.length-2],staysOutsideCenter=curr===last&&curr!=="center",isDifferentGroup=targetGroup!==draggedGroup;if(type==="group"){if(targetGroup=id,isDifferentGroup&&applyDragChangeParent(id,"group"),targetGroup===draggedGroup){for(let block of blocks.values())block.classList.remove("drop-target","drop-source");for(let block of groups.values())block.classList.remove("drop-target","drop-source")}return}if(staysOutsideCenter||isDifferentGroup)return;if(curr===""){lastdropAreas.push(""),clearTimeout(dragChangeParentTimeout);for(let block of blocks.values())block.classList.remove("drop-target","drop-source");for(let block of groups.values())block.classList.remove("drop-target","drop-source");return}let movesFromCenter=last==="center"&&(curr==="left"||curr==="right"),movesAcrossArea=curr!==secondlast,staysInCenter=last===curr&&curr==="center",idAtCurrentArea=ids[initids.indexOf(id)];staysInCenter&&applyDragChangeParent(type==="mini"?id:idAtCurrentArea,type),movesFromCenter&&movesAcrossArea&&applyDragMoveBlocks(id),last!==curr&&lastdropAreas.push(curr)}function applyDragMoveBlocks(id){let targetIndex=initids.indexOf(id);if(lastIndex!==targetIndex){clearTimeout(dragChangeParentTimeout),lastIndex=targetIndex,ids.splice(ids.indexOf(draggedId),1),ids.splice(targetIndex,0,draggedId);for(let i=0;i<ids.length;i++)ids[i]!==draggedId&&deplaceElem(blocks.get(ids[i]),coords[i].x,coords[i].y)}}function applyDragChangeParent(id,type){let propertyValue=getComputedStyle(domlinkblocks2).getPropertyValue("--drop-delay"),dropDelay=type==="group"?0:Number.parseInt(propertyValue||"120");clearTimeout(dragChangeParentTimeout),dragChangeParentTimeout=setTimeout(()=>{let isDraggedId=id===draggedId,inFolder=domlinkgroup?.classList.contains("in-folder");if(!(isDraggedId||inFolder)&&!(type==="mini"&&(document.querySelector("#link-mini .link-title.selected-group")?.dataset.group??id)===id)){targetId=id;for(let block of blocks.values())block.classList.remove("drop-target","drop-source");for(let block of groups.values())block.classList.remove("drop-target","drop-source");blocks.get(draggedId)?.classList.toggle("drop-source",!0),type==="group"?groups.get(id)?.classList.toggle("drop-target",!0):blocks.get(id)?.classList.toggle("drop-target",!0)}},dropDelay)}function endDrag(event){event.preventDefault(),document.documentElement.removeEventListener("pointermove",moveDrag),document.documentElement.removeEventListener("pointerup",endDrag),document.documentElement.removeEventListener("pointerleave",endDrag),document.documentElement.removeEventListener("touchmove",moveDrag),document.documentElement.removeEventListener("touchend",endDrag);let path=event.composedPath(),type=findTypeFromElement(blocks.get(draggedId)),group=domlinkgroup?.dataset.group??"",newIndex=ids.indexOf(draggedId),block=blocks.get(draggedId),coord=coords[newIndex],isDroppable=!!document.querySelector(".drop-source"),outOfFolder=!path[0]?.classList.contains("link-list")&&domlinkgroup?.classList.contains("in-folder"),targetIdIsLink=targetId.startsWith("links")&&targetId.length===11,toFolder=isDroppable&&targetIdIsLink,toTab=isDroppable&&!targetIdIsLink;globalThis.cancelAnimationFrame(dragAnimationFrame),blocks.get(draggedId)?.classList.remove("on");for(let container2 of dragContainers)container2?.classList.replace("dragging","dropping");outOfFolder||toFolder||toTab?blocks.get(draggedId)?.classList.add("removed"):deplaceElem(block,coord.x,coord.y);for(let block2 of groups.values())block2.classList.remove("drop-target","drop-source");setTimeout(()=>{let targetIsFolder=blocks.get(targetId)?.classList.contains("link-folder"),draggedIsFolder=blocks.get(draggedId)?.classList.contains("link-folder");type==="mini"?linksUpdate({moveGroups:ids}):toFolder&&!targetIsFolder&&!draggedIsFolder?linksUpdate({addFolder:{ids:[targetId,draggedId],group}}):toFolder&&targetIsFolder&&!draggedIsFolder?linksUpdate({moveToFolder:{source:draggedId,target:targetId}}):toFolder&&targetIsFolder&&draggedIsFolder?linksUpdate({concatFolders:{source:draggedId,target:targetId}}):toTab?linksUpdate({moveToGroup:{ids:[draggedId],target:targetId}}):outOfFolder?linksUpdate({moveOutFolder:{ids:[draggedId],group}}):linksUpdate({moveLinks:ids}),setTimeout(()=>{for(let container2 of dragContainers){let elements2=container2.querySelectorAll("li, button");for(let element of elements2)element.removeAttribute("style");container2?.removeAttribute("style"),container2?.classList.remove("in-drag","dropping")}},1)},200)}function deplaceElem(dom,x=0,y=0){dom&&(dom.style.transform=`translate(${Math.floor(x)}px, ${Math.floor(y)}px)`)}function deplaceDraggedElem(){let block=blocks.get(draggedId);block&&(block.style.transform=`translate(${dx}px, ${dy}px)`,dragAnimationFrame=globalThis.requestAnimationFrame(deplaceDraggedElem))}function isDraggingOver({x,y}){let findArea=zones=>{for(let[id,zone]of zones){let ll=zone.x,lr=zone.x+zone.w*.2,lt=zone.y,lb=zone.y+zone.h,isInLeftEdge=x>ll&&x<lr&&y>lt&&y<lb,rl=zone.x+zone.w*.8,rr=zone.x+zone.w,rt=zone.y+0,rb=zone.y+zone.h,isInRightEdge=x>rl&&x<rr&&y>rt&&y<rb,cl=zone.x+zone.w*.2,cr=zone.x+zone.w*.8,ct=zone.y,cb=zone.y+zone.h,isInCenter=x>cl&&x<cr&&y>ct&&y<cb,area="";if(isInLeftEdge&&(area="left"),isInRightEdge&&(area="right"),isInCenter&&(area="center"),area)return{area,id}}},linkarea=findArea(dropzones.link);if(linkarea)return[linkarea.area,linkarea.id,"link"];let miniarea=findArea(dropzones.mini);if(miniarea)return[miniarea.area,miniarea.id,"mini"];let grouparea=findArea(dropzones.group);if(grouparea)return[grouparea.area,grouparea.id,"group"]}function getPosFromEvent(event){switch(event.type){case"touchmove":{let touch=event.touches[0];return{x:touch.clientX,y:touch.clientY}}case"pointermove":{let{x,y}=event;return{x,y}}default:return{x:0,y:0}}}function findTypeFromElement(element){if(element?.classList.contains("link"))return"link";if(element?.classList.contains("link-title"))return"mini";if(element?.classList.contains("link-group"))return"group";throw new Error("No valid type found for specified element")}function findIdFromElement(element,type){let elementType=type??findTypeFromElement(element);if(elementType==="link")return element?.id??"";if(elementType==="mini"||elementType==="group")return element?.dataset.group??"";throw new Error("No valid type found for specified element")}var domlinkblocks3=document.getElementById("linkblocks");function initGroups(data,init2){if(!init2)for(let node of document.querySelectorAll("#link-mini button")??[])node.remove();createGroups(data.linkgroups)}function createGroups(linkgroups){let{groups:groups2,pinned,synced,selected}=linkgroups;for(let group of[...groups2,"+"]){let button=document.createElement("button"),isTopSite=group==="topsites",isDefault=group==="default",isAddMore=group==="+";pinned.includes(group)||(button.textContent=group,button.dataset.group=group,button.classList.add("link-title"),button.classList.toggle("selected-group",group===selected),button.classList.toggle("synced",synced.includes(group)),isTopSite&&(button.textContent=tradThis("Most visited"),button.classList.add("topsites-title")),isDefault&&(button.textContent=tradThis("Default group")),isAddMore?(button.classList.add("add-group"),button.addEventListener("click",openEditDialog)):(button.addEventListener("click",changeGroup),button.addEventListener("pointerdown",startDrag)),document.querySelector("#link-mini div")?.appendChild(button))}domlinkblocks3?.classList.toggle("with-groups",linkgroups.on)}function changeGroup(event){let button=event.currentTarget,transition=transitioner();if(domlinkblocks3.dataset.folderid||button.classList.contains("selected-group"))return;transition.first(hideCurrentGroup),transition.after(recreateLinksFromNewGroup),transition.finally(showNewGroup),transition.transition(100);async function recreateLinksFromNewGroup(){let buttons=document.querySelectorAll("#link-mini button"),data=await storage.sync.get(),group=button.dataset.group??data.linkgroups.groups[0];for(let div of buttons??[])div.classList.remove("selected-group");button.classList.add("selected-group"),data.linkgroups.selected=group,storage.sync.set(data),initblocks(data)}function hideCurrentGroup(){domlinkblocks3.classList.remove("in-folder"),domlinkblocks3.classList.add("hiding")}function showNewGroup(){domlinkblocks3.classList.remove("hiding")}}function toggleGroups(on,data){return domlinkblocks3?.classList.toggle("with-groups",on),data.linkgroups.on=on,data}function changeGroupTitle(title,data){let index=data.linkgroups.groups.indexOf(title.old);for(let link of getLinksInGroup(data,title.old))data[link._id]={...link,parent:title.new};return data.linkgroups.groups[index]=title.new,data.linkgroups.selected=title.new,initGroups(data),data}function addGroup(groups2,data){for(let{title,sync}of groups2){let isReserved=title==="default"||title==="+",isAlreadyUsed=data.linkgroups.groups.includes(title);if(isReserved||isAlreadyUsed)return data;for(let link of getLinksInGroup(data,"+"))data[link._id]={...link,parent:title};data.linkgroups.selected=title,data.linkgroups.groups.push(title),sync&&data.linkgroups.synced.push(title)}return initGroups(data),initblocks(data),data}function deleteGroup(group,data){let{groups:groups2,pinned,synced,selected}=data.linkgroups,isBroken=groups2.indexOf(group)===-1;if(groups2.length===1||isBroken)return data;for(let link of getLinksInGroup(data,group))delete data[link._id];return data.linkgroups.selected=group===selected||pinned.includes(group)?groups2[0]:selected,data.linkgroups.pinned=pinned.filter(p=>p!==group),data.linkgroups.synced=synced.filter(g=>g!==group),data.linkgroups.groups=groups2.filter(g=>g!==group),groups2.length===2&&(data.linkgroups.pinned=[]),storage.sync.clear(),initblocks(data),initGroups(data),data}function moveGroups(mini,data){let userMini=mini.filter(name=>name!=="+");return data.linkgroups.groups=data.linkgroups.pinned.concat(userMini),initGroups(data),data}async function togglePinGroup(group,action){let data=await storage.sync.get(),{groups:groups2,pinned}=data.linkgroups;if(action==="pin"&&data.linkgroups.pinned.push(group),action==="unpin"&&(data.linkgroups.pinned=pinned.filter(pinned2=>pinned2!==group)),group===data.linkgroups.selected){let unpinned=groups2.filter(id=>pinned.includes(id)===!1);data.linkgroups.selected=unpinned[0]}storage.sync.set(data),initblocks(data),initGroups(data)}function settingsNotifications(notifs){onSettingsLoad(()=>{for(let[id,state]of Object.entries(notifs))document.getElementById(id)?.classList?.toggle("shown",state);let wrapper=document.getElementById("settings-notifications"),hasNotifs=document.querySelectorAll("#settings-notifications .param.shown").length>0;wrapper?.classList?.toggle("shown",hasNotifs)})}async function getPermissions(...args){switch(PLATFORM){case"online":return!0;case"firefox":return await browser.permissions.request({permissions:[...args]});default:return chrome.permissions.request({permissions:[...args]})??!1}}function bundleLinks(data){let res=[];return Object.entries(data).map(([key,val])=>{key.length===11&&key.startsWith("links")&&res.push(val)}),res}var import_mod6=__toESM(require_dist());var browserBookmarkFolders=[];async function linksImport(){let data=await storage.sync.get();for(let node of document.querySelectorAll("#bookmarks-container > *")??[])node.remove();await initBookmarkSync(data),createBookmarksDialog()}async function initBookmarkSync(data){let treenode=await getBookmarkTree(),permission=!!treenode;if(!permission)try{permission=await getPermissions("topSites","bookmarks")}catch{settingsNotifications({"accept-permissions":!0})}permission&&(treenode=await getBookmarkTree(),treenode&&(browserBookmarkFolders=bookmarkTreeToFolderList(treenode[0],data)))}function syncBookmarks(group){let folder=browserBookmarkFolders.find(folder2=>folder2.title===group),syncedLinks=[];if(folder)for(let bookmark of folder.bookmarks)syncedLinks.push(validateLink(bookmark.title,bookmark.url,folder.title));return syncedLinks}function createBookmarksDialog(){let bookmarkFolders=browserBookmarkFolders,bookmarksdom=document.querySelector("#bookmarks"),container2=document.querySelector("#bookmarks-container");if(!bookmarksdom){bookmarksdom=getHTMLTemplate("bookmarks-dialog-template","dialog"),container2=bookmarksdom.querySelector("#bookmarks-container");let closebutton=bookmarksdom.querySelector("#bmk_close"),applybutton=bookmarksdom.querySelector("#bmk_apply");bookmarksdom?.addEventListener("click",closeDialog),(0,import_mod6.onclickdown)(applybutton,importSelectedBookmarks),(0,import_mod6.onclickdown)(closebutton,closeDialog),document.body.appendChild(bookmarksdom)}for(let list of bookmarkFolders){let folder=getHTMLTemplate("bookmarks-folder-template","div"),selectButton=folder.querySelector(".b_bookmarks-folder-select"),syncButton=folder.querySelector(".b_bookmarks-folder-sync"),ol=folder.querySelector("ol"),h2=folder.querySelector(".bookmarks-folder-title-content");if(ol&&h2){h2.textContent=list.title,(0,import_mod6.onclickdown)(selectButton,()=>toggleFolderSelect(folder)),(0,import_mod6.onclickdown)(syncButton,()=>toggleFolderSync(folder)),folder.classList.toggle("used",list.used),folder.dataset.title=list.title,container2?.appendChild(folder),list.title==="topsites"&&syncButton&&(h2.textContent=tradThis("Most visited"),folder.classList.add("synced"),syncButton.setAttribute("disabled",""),syncButton.remove());for(let bookmark of list.bookmarks){let li=getHTMLTemplate("bookmarks-item-template","li"),liButton=li.querySelector("button"),liTitle=li.querySelector(".bookmark-title"),liUrl=li.querySelector(".bookmark-url"),liImg=li.querySelector("img");if(!(liTitle&&liButton&&liUrl&&liImg&&bookmark.url.startsWith("http")))continue;let url=new URL(bookmark.url);liImg.src=`${API_DOMAIN}/favicon/blob/${url.origin}`,liTitle.textContent=bookmark.title,liUrl.textContent=url.href.replace(url.protocol,"").replace("//","").replace("www.","").slice(0,-1).replace("/",""),(0,import_mod6.onclickdown)(liButton,()=>li.classList.toggle("selected")),(0,import_mod6.onclickdown)(liButton,handleApplyButtonText),bookmark.used&&liButton.setAttribute("disabled",""),li.id=bookmark.id,ol?.appendChild(li)}}}document.getElementById("bmk_apply")?.setAttribute("disabled",""),document.dispatchEvent(new Event("toggle-settings")),traduction(bookmarksdom,getLang()),bookmarksdom.showModal(),setTimeout(()=>bookmarksdom.classList.add("shown"))}function importSelectedBookmarks(){let folders=browserBookmarkFolders,bookmarksdom=document.getElementById("bookmarks"),selectedLinks=bookmarksdom.querySelectorAll(".bookmarks-folder li.selected"),selectedFolders=bookmarksdom.querySelectorAll(".bookmarks-folder.selected"),syncedFolders=bookmarksdom.querySelectorAll(".bookmarks-folder.synced"),linksIds=Object.values(selectedLinks).map(element=>element.id),folderIds=Object.values(selectedFolders).map(element=>element.dataset.title),syncedIds=Object.values(syncedFolders).map(element=>element.dataset.title),links=[],groups2=[];for(let folder of folders){let isFolderSelected=folderIds.includes(folder.title),isFolderSynced=syncedIds.includes(folder.title);if(isFolderSelected&&groups2.push({title:folder.title,sync:isFolderSynced}),!(isFolderSynced&&folder.title!=="topsites"))for(let bookmark of folder.bookmarks){let isBookmarkSelected=linksIds.includes(bookmark.id),group=isFolderSelected?folder.title:void 0,title=bookmark.title,url=bookmark.url;(isFolderSelected||isBookmarkSelected)&&links.push({title,url,group})}}storage.sync.get("linkgroups").then(({linkgroups})=>{let iLinkgroups=document.querySelector("#i_linkgroups"),toggleGroups2=[...groups2,...linkgroups.groups].length>1;quickLinks(void 0,{groups:toggleGroups2,addLinks:links,addGroups:groups2}),iLinkgroups&&(iLinkgroups.checked=toggleGroups2),bookmarksdom?.classList.remove("shown"),bookmarksdom?.close(),closeDialog()})}function handleApplyButtonText(){let applybutton=document.getElementById("bmk_apply"),links=document.querySelectorAll("#bookmarks li.selected"),folders=document.querySelectorAll("#bookmarks .bookmarks-folder.selected"),emptySelection=links.length===0&&folders.length===0;toggleDisabled(applybutton,emptySelection)}function closeDialog(event){let id=(event?.composedPath()??[])[0]?.id??"";if(!event||id==="bookmarks"||id==="bmk_close"){let bookmarksdom=document.querySelector("#bookmarks");bookmarksdom?.close(),bookmarksdom?.classList.remove("shown");for(let node of bookmarksdom?.querySelectorAll(".selected")??[])node.classList.remove("selected")}}function toggleFolderSelect(folder){let selectButton=folder.querySelector(".b_bookmarks-folder-select"),syncButton=folder.querySelector(".b_bookmarks-folder-sync");if(selectButton){if(folder.classList.contains("selected"))folder.classList.remove("selected"),syncButton?.classList.remove("selected"),syncButton?.setAttribute("disabled","");else{folder.classList.add("selected");for(let li of folder.querySelectorAll("li"))li?.classList.remove("selected");syncButton?.removeAttribute("disabled")}handleApplyButtonText()}}function toggleFolderSync(folder){folder.classList.contains("synced")?folder.classList.remove("synced"):folder.classList.add("synced")}async function getBookmarkTree(){let treenode=globalThis.startupBookmarks,topsites=globalThis.startupTopsites;if(treenode||(treenode=await EXTENSION?.bookmarks?.getTree()),topsites||(topsites=await EXTENSION?.topSites?.get()),!!(treenode&&topsites))return PLATFORM==="chrome"&&treenode[0].children?.push({id:"",title:"Google Apps",children:[{id:"",title:"Youtube",url:"https://youtube.com"},{id:"",title:"Account",url:"https://myaccount.google.com"},{id:"",title:"Gmail",url:"https://mail.google.com"},{id:"",title:"Meet",url:"https://meet.google.com"},{id:"",title:"Maps",url:"https://maps.google.com"},{id:"",title:"Drive",url:"https://drive.google.com"},{id:"",title:"Photos",url:"https://photos.google.com"},{id:"",title:"Calendar",url:"https://calendar.google.com"},{id:"",title:"Translate",url:"https://translate.google.com"},{id:"",title:"News",url:"https://news.google.com"}]}),treenode[0].children?.unshift({id:"",title:"topsites",children:topsites.map(site=>({id:"",title:site.title??"",url:site.url,syncing:!1}))}),treenode}function bookmarkTreeToFolderList(treenode,data){function createMapFromTree(treenode2){if(treenode2.children)for(let child of treenode2.children)child.children&&createMapFromTree(child),!(!child.url||(folders[treenode2.title]||(folders[treenode2.title]={title:treenode2.title,used:!1,bookmarks:[]}),folders[treenode2.title].bookmarks.map(b=>b.url).includes(child.url)))&&folders[treenode2.title].bookmarks.push({id:randomString(6),title:child.title,url:child.url,used:linksUrLs.includes(child.url),dateAdded:child.dateAdded??0})}let linksUrLs=bundleLinks(data).map(link=>isLink(link)&&link.url),folders={};createMapFromTree(treenode);for(let[folder,{bookmarks}]of Object.entries(folders)){let allUsed=bookmarks.every(b=>b.used),isGroup=data.linkgroups.groups.includes(folder);(data.linkgroups.synced.includes(folder)||isGroup&&allUsed)&&(folders[folder].used=!0)}return Object.values(folders)}var domlinkblocks4=document.getElementById("linkblocks");queueMicrotask(()=>{document.addEventListener("close-folder",closeFolder)});async function folderClick(event){let li=getLiFromEvent(event),rightClick=event.button===2,inFolder=li?.classList.contains("link-folder"),isSelectAll=domlinkblocks4.className.includes("select-all");if(!(li&&inFolder)||rightClick||isSelectAll)return;document.dispatchEvent(new Event("stop-select-all"));let data=await storage.sync.get(),ctrlClick=event.button===0&&(event.ctrlKey||event.metaKey),middleClick=event.button===1;ctrlClick||middleClick?openAllLinks(data,li):openFolder(data,li)}function openFolder(data,li){if(!li.parentNode)return;let linkgroup=li.parentNode.parentNode,linktitle=linkgroup.querySelector(".link-title"),folder=data[li.id],transition=transitioner();transition.first(hide),transition.after(changeToFolder),transition.finally(show),transition.transition(40);function hide(){linkgroup.dataset.folder=li?.id,linkgroup.classList.add("hiding"),linkgroup.classList.remove("in-folder")}function changeToFolder(){initblocks(data),linktitle&&(linktitle.textContent=folder?.title||tradThis("Folder"))}function show(){linkgroup.classList.replace("hiding","in-folder")}}async function closeFolder(){if(document.querySelector(".link-group.dropping"))return;let data=await storage.sync.get(),transition=transitioner();transition.first(hide),transition.after(changeToTab),transition.finally(show),transition.transition(40);function hide(){let folders=document.querySelectorAll(".link-group.in-folder");for(let group of folders)group.classList.add("hiding"),group.dataset.folder=""}function changeToTab(){domlinkblocks4.classList.toggle("with-groups",data.linkgroups.on),initblocks(data)}function show(){let groups2=document.querySelectorAll(".link-group");for(let group of groups2)group.classList.remove("in-folder"),group.classList.remove("hiding")}}function openAllLinks(data,li){let linksInFolder=getLinksInFolder(data,li.id);for(let link of linksInFolder)globalThis.open(link.url,"_blank")?.focus();globalThis.open(globalThis.location.href,"_blank")?.focus(),globalThis.close()}var domlinkblocks5=document.getElementById("linkblocks"),initIconList=[],selectallTimer=0;async function quickLinks(init2,event){if(event){linksUpdate(event);return}init2&&(domlinkblocks5.classList.add(init2.linkstyle??"large"),domlinkblocks5.classList.toggle("titles",init2.linktitles),domlinkblocks5.classList.toggle("backgrounds",init2.linkbackgrounds),domlinkblocks5.classList.toggle("hidden",!init2.quicklinks),init2.linkgroups.synced.length>0&&await initBookmarkSync(init2),initGroups(init2,!!init2),initRows(init2.linksrow,init2.linkstyle),initblocks(init2,!0))}function initblocks(data,isInit){let allLinks=Object.values(data).filter(val=>isLink(val)),{pinned,synced,selected}=data.linkgroups,activeGroups=[];for(let group of[...pinned,selected]){let div=document.querySelector(`.link-group[data-group="${group}"]`),folder=div?.dataset.folder,lis=[],links=folder?getLinksInFolder(data,folder):getLinksInGroup(data,group);activeGroups.push({lis,div,links,title:group,pinned:group!==selected,synced:synced?.includes(group)})}activeGroups.reverse();let divs=activeGroups.map(g=>g.div),usedLis=activeGroups.flatMap(group=>group.lis);for(let div of document.querySelectorAll("#linkblocks .link-group")){for(let li of div.querySelectorAll("li"))usedLis.includes(li)===!1&&li.remove();divs.includes(div)===!1&&div.remove()}for(let group of activeGroups){let linkgroup=group.div??getHTMLTemplate("link-group-template",".link-group"),linksInFolders=allLinks.filter(link=>!link.folder&&typeof link.parent=="string"),linklist=linkgroup.querySelector("ul"),linktitle=linkgroup.querySelector("button"),fragment=document.createDocumentFragment(),folderid=linkgroup.dataset.folder;if(!(linklist&&linktitle))throw new Error("Template not found");group.synced&&(group.links=syncBookmarks(group.title));for(let link of group.links){let li=group.lis.find(li2=>li2.id===link._id);if(li){li.removeAttribute("style"),linklist?.appendChild(li);continue}li=isElem(link)?createElem(link,data.linknewtab,data.linkstyle):createFolder(link,linksInFolders,data.linkstyle),fragment.appendChild(li),li.addEventListener("keyup",openEditDialog),group.synced||(li.addEventListener("click",selectAll),li.addEventListener("pointerdown",selectAll),li.addEventListener("pointerdown",startDrag))}folderid?linktitle.textContent=data[folderid].title:linktitle.textContent=group.title,linkgroup.dataset.group=group.title,linkgroup.classList.toggle("pinned",group.pinned),linkgroup.classList.toggle("synced",group.synced),linklist.appendChild(fragment),domlinkblocks5.prepend(linkgroup),group.title==="topsites"&&(linktitle.textContent=tradThis("Most visited"),linktitle.classList.add("topsites-title"),linkgroup.classList.add("topsites-group")),group.title==="default"&&(linktitle.textContent=tradThis("Default group"))}return createIcons(isInit),displayInterface("links"),!0}function createFolder(link,folderChildren,style){let li=getHTMLTemplate("link-folder-template","li"),imgs=li.querySelectorAll("img"),span=li.querySelector("span");if(!(li&&imgs&&span))throw new Error("Template not found");let linksInThisFolder=folderChildren.filter(l=>!l.folder&&l.parent===link._id).toSorted((a,b)=>a.order-b.order);li.id=link._id,span.textContent=createTitle(link),li.addEventListener("mouseup",folderClick);for(let i=0;i<linksInThisFolder.length;i++){let img=imgs[i],elem=linksInThisFolder[i];img&&isElem(elem)&&style!=="text"&&initIconList.push([img,elem.icon??getDefaultIcon(elem.url)])}return li}function createElem(link,openInNewtab,style){let li=getHTMLTemplate("link-elem-template","li"),span=li.querySelector("span"),anchor=li.querySelector("a"),img=li.querySelector("img");if(!(li&&span&&anchor&&img))throw new Error("Template not found");if(li.id=link._id,anchor.href=stringMaxSize(link.url,512),span.textContent=createTitle(link),style!=="text"){let iconurl=link.icon??"",refresh=new Date(Number.parseInt(iconurl))?.getTime(),icon=!Number.isInteger(refresh)&&link.icon?link.icon:getDefaultIcon(link.url,refresh);initIconList.push([img,icon])}return openInNewtab&&(anchor.target="_blank"),li}function createIcons(isInit){let loadingTimeout=isInit?400:0;for(let[img,url]of initIconList)img.src=url;setTimeout(()=>{let incomplete=initIconList.filter(([img])=>!img.complete);for(let[img,url]of incomplete){img.src="src/assets/interface/loading.svg";let newimg=document.createElement("img");newimg.addEventListener("load",()=>{img.src=url}),newimg.src=url}initIconList=[]},loadingTimeout)}function initRows(row,style){let sizes={large:{width:4.8,gap:2.3},medium:{width:3.5,gap:2},small:{width:2.5,gap:2},inline:{width:11,gap:2},text:{width:5,gap:2}};if(style in sizes){let{width,gap}=sizes[style];document.documentElement.style.setProperty("--links-width",`${Math.ceil((width+gap)*row)}em`)}}queueMicrotask(()=>{document.addEventListener("stop-select-all",()=>clearTimeout(selectallTimer)),document.addEventListener("remove-select-all",removeSelectAll)});function selectAll(event){clearTimeout(selectallTimer);let selectAllActive=domlinkblocks5.className.includes("select-all"),primaryButton=!event.button||event.button===0,pointerUpOrClick=event.type.includes("pointerup")||event.type.includes("click"),li=getLiFromEvent(event);if(selectAllActive&&pointerUpOrClick){primaryButton&&li?.classList.toggle("selected"),event.preventDefault();return}if(!selectAllActive&&primaryButton&&event.type==="pointerdown"){if(event?.pointerType==="touch")return;selectallTimer=setTimeout(()=>{domlinkblocks5.classList.add("select-all")},600)}}function removeSelectAll(){clearTimeout(selectallTimer),domlinkblocks5.classList.remove("select-all");for(let li of domlinkblocks5.querySelectorAll(".link"))li.classList.remove("selected")}async function linksUpdate(update){let data=await storage.sync.get();update.addLinks&&(data=linkSubmission({type:"link",links:update.addLinks},data)),update.addFolder&&(data=linkSubmission({type:"folder",...update.addFolder},data)),update.addGroups&&(data=addGroup(update.addGroups,data)),update.moveLinks&&(data=moveLinks(update.moveLinks,data)),update.moveGroups&&(data=moveGroups(update.moveGroups,data)),update.moveToGroup&&(data=moveToGroup(update.moveToGroup,data)),update.moveToFolder&&(data=moveToFolder(update.moveToFolder,data)),update.concatFolders&&(data=concatFolders(update.concatFolders,data)),update.moveOutFolder&&(data=moveOutFolder(update.moveOutFolder,data)),update.updateLink&&(data=updateLink(update.updateLink,data)),update.deleteLinks&&(data=deleteLinks(update.deleteLinks,data)),update.groupTitle&&(data=changeGroupTitle(update.groupTitle,data)),update.deleteGroup!==void 0&&(data=deleteGroup(update.deleteGroup,data)),update.groups!==void 0&&(data=toggleGroups(update.groups,data)),update.newtab!==void 0&&(data=setOpenInNewTab(update.newtab,data)),update.refreshIcons&&(data=refreshIcons(update.refreshIcons,data)),update.styles&&setLinkStyle(update.styles),update.row&&setRows(update.row),!(update.styles||update.row)&&storage.sync.set(data)}function linkSubmission(args,data){let type=args.type,newlinks=[];if(type==="link")for(let link of args.links)newlinks.push(validateLink(link.title,link.url,link.group));if(type==="folder"){let{ids:ids2,title,group}=args;newlinks=addLinkFolder(ids2,title,group);for(let id of ids2){let elem=data[id];elem&&!elem.folder&&(elem.parent=newlinks[0]._id)}}for(let link of newlinks){let noParents=link.parent===void 0,{selected,synced}=data.linkgroups;noParents&&synced.includes(selected)?(link.parent="",data.linkgroups.selected="",initGroups(data)):noParents&&(link.parent=selected),data[link._id]=link}let correctdata=correctLinksOrder(data);return initblocks(correctdata),correctdata}function addLinkFolder(ids2,title,group){let titledom=document.getElementById("e-title"),linktitle=title??titledom.value;titledom.value="";let order=[...document.querySelectorAll(".link")].map(block=>block.id).indexOf(ids2[0]);for(let i=0;i<ids2.length;i++)document.getElementById(ids2[i])?.classList.contains("link-folder")&&ids2.splice(i,1);return[{_id:`links${randomString(6)}`,folder:!0,order,parent:group??"",title:linktitle}]}function updateLink({id,title,icon,url},data){let titledom=document.querySelector(`#${id} span`),icondom=document.querySelector(`#${id} img`),urldom=document.querySelector(`#${id} a`),link=data[id];if(titledom&&title!==void 0&&(link.title=stringMaxSize(title,64),titledom.textContent=link.title),!link.folder){if(icondom){let url2=(icon?stringMaxSize(icon,7500):void 0)??getDefaultIcon(link.url),img=document.createElement("img");link.icon=url2||void 0,icondom.src="src/assets/interface/loading.svg",img.onload=()=>{icondom&&(icondom.src=url2)},img.src=url2}titledom&&urldom&&url!==void 0&&(link.url=stringMaxSize(url,512),urldom.href=link.url,titledom.textContent=createTitle(link))}return data[id]=link,data}function concatFolders({target,source},data){let linktarget=data[target],linksource=data[source];if(!(linktarget.folder&&linksource.folder))return data;let sourceIds=getLinksInFolder(data,source).map(({_id})=>_id),ids2=[...getLinksInFolder(data,target).map(({_id})=>_id),...sourceIds];for(let[key,val]of Object.entries(data))isLink(val)!==!1&&ids2.includes(val._id)&&!val.folder&&(data[key].parent=target,data[key].order=Date.now());return delete data[source],initblocks(data),setTimeout(()=>storage.sync.remove(source)),data}function moveToFolder({target,source},data){let isSourceElem=typeof data[source]?.url=="string",isTargetFolder=data[target]?.folder===!0;return isSourceElem&&isTargetFolder&&(data[source].parent=target,data[source].order=Date.now(),initblocks(data)),data}function moveOutFolder({ids:ids2,group},data){let linksInGroup=getLinksInGroup(data,group),maxOrder=linksInGroup.length>0?Math.max(...linksInGroup.map(link=>link.order)):-1;ids2.forEach((id,index)=>{data[id].parent=group,data[id].order=maxOrder+index+1});let correctdata=correctLinksOrder(data);return initblocks(correctdata),correctdata}function deleteLinks(ids2,data){for(let id of ids2){let link=data[id];if(link.folder)for(let child of getLinksInFolder(data,link._id))delete data[child._id];delete data[id]}storage.sync.clear();let correctdata=correctLinksOrder(data);return animateLinksRemove(ids2),correctdata}function moveLinks(ids2,data){return ids2.forEach((id,i)=>{data[id].order=i}),initblocks(data),data}function moveToGroup({ids:ids2,target},data){for(let id of ids2)data[id].parent=target,data[id].order=Date.now();let correctdata=correctLinksOrder(data);return initblocks(correctdata),correctdata}function refreshIcons(ids2,data){for(let id of ids2){let link=data[id];link._id&&(link.icon=Date.now().toString(),data[id]=link)}return initblocks(data),data}function setOpenInNewTab(newtab,data){let anchors=document.querySelectorAll(".link a");for(let anchor of anchors)newtab?anchor.setAttribute("target","_blank"):anchor.removeAttribute("target");return data.linknewtab=newtab,data}async function setLinkStyle(styles){let data=await storage.sync.get(),style=styles.style??"large",{titles}=styles,{backgrounds}=styles;if(styles.style&&isLinkStyle(style)){let wasText=domlinkblocks5?.className.includes("text");if(domlinkblocks5.classList.remove("large","medium","small","inline","text"),domlinkblocks5.classList.add(style),data.linkstyle=style,storage.sync.set({linkstyle:style}),wasText)for(let el of document.querySelectorAll("#link-list li")??[])el.remove();initRows(data.linksrow,style),initblocks(data)}typeof titles=="boolean"&&(data.linktitles=titles,storage.sync.set({linktitles:titles}),document.getElementById("b_showtitles")?.classList?.toggle("on",titles),domlinkblocks5.classList.toggle("titles",titles)),typeof backgrounds=="boolean"&&(data.linkbackgrounds=backgrounds,storage.sync.set({linkbackgrounds:backgrounds}),document.getElementById("b_showbackgrounds")?.classList?.toggle("on",backgrounds),domlinkblocks5.classList.toggle("backgrounds",backgrounds))}function setRows(row){let style=[...domlinkblocks5.classList].filter(isLinkStyle)[0]??"large",val=Number.parseInt(row??"6");initRows(val,style),eventDebounce({linksrow:row})}function validateLink(title,url,parent){let startsWithEither=strs=>strs.some(str=>url.startsWith(str)),sanitizedUrl=stringMaxSize(url,512),isConfig=startsWithEither(["about:","chrome://","edge://"]),noProtocol=!startsWithEither(["https://","http://"]),isLocalhost=url.startsWith("localhost")||url.startsWith("127.0.0.1"),prefix=isConfig?"#":isLocalhost?"http://":noProtocol?"https://":"";return{_id:`links${randomString(6)}`,parent,order:Date.now(),title:stringMaxSize(title,64),url:prefix+sanitizedUrl}}function animateLinksRemove(ids2){for(let id of ids2)document.getElementById(id)?.classList.add("removed"),setTimeout(()=>document.getElementById(id)?.remove(),600)}function correctLinksOrder(data){let folderIds=Object.values(data).filter(val=>isLink(val)).filter(link=>link.folder).map(({_id})=>_id);for(let folderId of folderIds){let linksInFolder=getLinksInFolder(data,folderId);for(let[i,link]of linksInFolder.entries())link.order=i,data[link._id]}for(let group of data.linkgroups.groups){let linksInGroup=getLinksInGroup(data,group);for(let[i,link]of linksInGroup.entries())link.order=i,data[link._id]}return data}function isLinkStyle(s){return["large","medium","small","inline","text"].includes(s)}var socket,domainPattern=/^(?!.*\s)(?:https?:\/\/)?([a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9-]{2,})/i,domsuggestions=document.getElementById("sb-suggestions"),domcontainer=document.getElementById("sb_container"),domsearchbar=document.getElementById("searchbar"),dombuttons=document.getElementById("sb-buttons"),emptyButton=document.getElementById("sb_empty"),display=(shown=!1)=>domcontainer?.classList.toggle("hidden",!shown),setEngine=(value="google")=>domcontainer?.setAttribute("data-engine",value),setRequest=(value="")=>domcontainer?.setAttribute("data-request",stringMaxSize(value,512)),setNewtab=(value=!1)=>domcontainer?.setAttribute("data-newtab",value.toString()),setSuggestions=(value=!0)=>domcontainer?.setAttribute("data-suggestions",value.toString()),setPlaceholder=(value="")=>domsearchbar?.setAttribute("placeholder",value),setWidth=(value=30)=>document.documentElement.style.setProperty("--searchbar-width",`${value.toString()}em`),setBackground=(value="#fff2")=>{document.documentElement.style.setProperty("--searchbar-background",value),document.getElementById("sb_container")?.classList.toggle("opaque",value.includes("#fff")&&opacityFromHex(value)>7)};function searchbar(init2,update){if(update){updateSearchbar(update);return}try{display(init2?.on),setWidth(init2?.width),setEngine(init2?.engine),setRequest(init2?.request),setNewtab(init2?.newtab),setPlaceholder(init2?.placeholder),setSuggestions(init2?.suggestions),setBackground(init2?.background),dombuttons?.addEventListener("click",focusSearchbar),emptyButton?.addEventListener("click",removeInputText),domcontainer?.addEventListener("submit",submitSearch),domsearchbar?.addEventListener("input",handleUserInput),document.addEventListener("keydown",searchbarShortcut)}catch{}}async function updateSearchbar({engine,newtab,background,placeholder,request,suggestions:suggestions2,width}){let{searchbar:searchbar2}=await storage.sync.get("searchbar");if(searchbar2){if(isValidEngine(engine)&&(document.getElementById("searchbar_request")?.classList.toggle("shown",engine==="custom"),searchbar2.engine=engine,setEngine(engine)),suggestions2!==void 0&&(searchbar2.suggestions=suggestions2,setSuggestions(suggestions2)),newtab!==void 0&&(searchbar2.newtab=newtab,setNewtab(newtab)),width!==void 0&&(searchbar2.width=Number.parseInt(width),setWidth(searchbar2.width)),placeholder!==void 0&&(searchbar2.placeholder=placeholder,setPlaceholder(placeholder)),background&&(searchbar2.background=hexColorFromSplitRange("sb-background-range"),setBackground(searchbar2.background)),request){if(!request.value.includes("%s"))return;searchbar2.request=stringMaxSize(request.value,512),setRequest(searchbar2.request),request.blur()}eventDebounce({searchbar:searchbar2})}}function isValidUrl(string2){try{let basicURL=!!new URL(string2),regexMatch=domainPattern.test(string2);return basicURL&&regexMatch}catch{return!1}}function createSearchUrl(val,engine){let urLs={default:"",google:"https://www.google.com/search?q=%s",ddg:"https://duckduckgo.com/?q=%s",startpage:"https://www.startpage.com/do/search?query=%s",qwant:"https://www.qwant.com/?q=%s",yahoo:"https://search.yahoo.com/search?q=%s",bing:"https://www.bing.com/search?q=%s",brave:"https://search.brave.com/search?q=%s",ecosia:"https://www.ecosia.org/search?q=%s",lilo:"https://search.lilo.org/?q=%s",baidu:"https://www.baidu.com/s?wd=%s",custom:domcontainer?.dataset.request||""},searchUrl="";if(isValidEngine(engine)){let trad=tradThis(engine);searchUrl=trad.includes("%s")?trad:urLs[engine]}return searchUrl.replace("%s",encodeURIComponent(val??""))}function submitSearch(e){e.preventDefault();let canUseDefault=!IS_MOBILE&&(PLATFORM==="chrome"||PLATFORM==="firefox"),newtab=domcontainer?.dataset.newtab==="true",val=domsearchbar?.value,engine=domcontainer?.dataset.engine??"default";if(!val)return;if(socket&&socket.close(),canUseDefault&&engine==="default"){EXTENSION?.search.query({disposition:newtab?"NEW_TAB":"CURRENT_TAB",text:val});return}engine=engine.replace("default","google");let domainUrl=val.startsWith("http://")||val.startsWith("https://")?val:`https://${val}`,searchUrl=createSearchUrl(val,engine),url=isValidUrl(domainUrl)?domainUrl:searchUrl,target=newtab?"_blank":"_self";globalThis.open(url,target)}function initSuggestions(){function selectShownResult(next){return next?.classList.contains("shown")?next:null}function applyResultContentToInput(elem){elem&&domsearchbar&&(domsearchbar.value=elem?.querySelector(".suggest-result")?.textContent??"")}for(let ii=0;ii<10;ii++){let li=document.createElement("li"),image=document.createElement("img"),wrapper=document.createElement("div"),result=document.createElement("p"),description=document.createElement("p");li.setAttribute("tabindex","0"),image.setAttribute("draggable","false"),image.setAttribute("width","16"),image.setAttribute("height","16"),result.classList.add("suggest-result"),description.classList.add("suggest-desc"),wrapper.appendChild(result),wrapper.appendChild(description),li.appendChild(image),li.appendChild(wrapper),li.addEventListener("mouseenter",()=>{domcontainer?.querySelector('li[aria-selected="true"]')?.removeAttribute("aria-selected"),li?.setAttribute("aria-selected","true")}),li.addEventListener("mouseleave",()=>{li?.removeAttribute("aria-selected")}),li.addEventListener("click",e=>{applyResultContentToInput(li),submitSearch(e)}),domsuggestions?.appendChild(li)}function toggleSuggestions(e){let targetIsResult=e?.relatedTarget?.parentElement?.id==="sb-suggestions",hasResults=document.querySelectorAll("#sb-suggestions li.shown")?.length>0,isFocus=e.type==="focus";targetIsResult||domsuggestions?.classList.toggle("shown",isFocus&&hasResults)}function navigateSuggestions(e){let isArrowDown=e.code==="ArrowDown",isArrowUp=e.code==="ArrowUp",isEnter=e.code==="Enter",isEscape=e.code==="Escape",lastSelected=domsuggestions?.querySelector('li[aria-selected="true"]');lastSelected?.removeAttribute("aria-selected"),!isEscape&&(isArrowDown&&(lastSelected=selectShownResult(lastSelected?.nextElementSibling)??domsuggestions?.querySelector("li.shown"),applyResultContentToInput(lastSelected)),isArrowUp&&(lastSelected=selectShownResult(lastSelected?.previousElementSibling),applyResultContentToInput(lastSelected),e.preventDefault()),isEnter&&lastSelected&&(applyResultContentToInput(lastSelected),submitSearch(e)),lastSelected?.setAttribute("aria-selected","true"))}function hideResultsAndSuggestions(){let children=Object.values(domsuggestions?.children??[]);for(let child of children)child.classList.remove("shown");domsuggestions?.classList.remove("shown")}async function createSuggestionSocket(){socket=await apiWebSocket("suggestions"),socket?.addEventListener("message",event=>{let data=parse(event.data);Array.isArray(data)?suggestions(data):data?.error&&createSuggestionSocket()})}domcontainer?.addEventListener("keydown",navigateSuggestions),domsearchbar?.addEventListener("focus",toggleSuggestions),domsearchbar?.addEventListener("blur",toggleSuggestions),emptyButton?.addEventListener("click",hideResultsAndSuggestions),createSuggestionSocket()}function suggestions(results){let input=domsearchbar,liList=domsuggestions?.querySelectorAll("li")??[];domsuggestions?.classList.toggle("shown",results.length>0),domsuggestions?.querySelector('li[aria-selected="true"]')?.removeAttribute("aria-selected"),liList.forEach((li,i)=>{let result=results[i],resultdom=li.querySelector(".suggest-result"),descdom=li.querySelector(".suggest-desc");if(!(result&&resultdom&&descdom))return;let searchIcon="src/assets/interface/magnifying-glass.svg",image=result.image??searchIcon,desc=result.desc??"";if(resultdom&&(resultdom.textContent=result.text),result.text.includes(input.value)){let queryIndex=result.text.indexOf(input.value),startdom=document.createElement("span"),querydom=document.createElement("b"),enddom=document.createElement("span");startdom.textContent=result.text.slice(0,queryIndex),querydom.textContent=result.text.slice(queryIndex,input.value.length),enddom.textContent=result.text.slice(input.value.length),resultdom.textContent="",resultdom.appendChild(startdom),resultdom.appendChild(querydom),resultdom.appendChild(enddom)}let imgdom=li.querySelector("img");imgdom.classList.toggle("default-search-icon",image===searchIcon),imgdom.src=image,descdom.textContent=desc,li.classList.toggle("shown",!!result);let rect=li.getBoundingClientRect();rect.y+rect.height+40>document.body.offsetHeight&&li.classList.remove("shown")}),domsuggestions?.querySelectorAll("li.shown")?.length===0&&domsuggestions?.classList.remove("shown")}function handleUserInput(e){let value=e.target.value??"",withProtocol=value.startsWith("http://")||value.startsWith("https://")?value:`https://${value}`,startsTypingProtocol="https://".startsWith(value)||"http://".startsWith(value);if(domsearchbar&&toggleInputButton(value.length>0),value===""){for(let li of document.querySelectorAll("#sb-suggestions li.shown")??[])li.classList.remove("shown");domsuggestions?.classList.remove("shown");return}if(startsTypingProtocol||isValidUrl(withProtocol)){domsuggestions?.classList.remove("shown");return}if(domcontainer?.dataset.suggestions==="true"&&domsuggestions?.childElementCount===0&&initSuggestions(),domcontainer?.dataset.suggestions==="true"&&socket&&socket.readyState===socket.OPEN){let engine=(domcontainer?.dataset.engine??"ddg").replace("custom","ddg").replace("default","google"),query=encodeURIComponent(value??"");socket.send(JSON.stringify({q:query,with:engine,lang:getLang()}))}}function toggleInputButton(enabled){document.getElementById("sb-buttons")?.classList.toggle("shown",enabled),document.getElementById("sb_empty")?.toggleAttribute("disabled",!enabled),document.getElementById("sb_submit")?.toggleAttribute("disabled",!enabled)}function removeInputText(){domsearchbar&&(domsearchbar.focus(),domsearchbar.value="",toggleInputButton(!1))}function focusSearchbar(){dombuttons?.classList.contains("shown")===!1&&domsearchbar?.focus()}function searchbarShortcut(event){event.target.tagName==="BODY"&&event.key==="/"&&(domsearchbar?.focus(),domsearchbar?.select(),event.preventDefault())}function isValidEngine(str=""){return SEARCHBAR_ENGINES.includes(str)}function customCss(init2,event){let stylelink=document.getElementById("styles");if(event){if(event?.styling!==void 0){let val=stringMaxSize(event.styling,8080);stylelink.textContent=val,eventDebounce({css:val})}return}init2&&(stylelink.textContent=init2),onSettingsLoad(async()=>{let{createCssEditor:createCssEditor2}=await Promise.resolve().then(()=>(init_csseditor(),csseditor_exports)),editor=createCssEditor2({language:"css",lineNumbers:!1,wordWrap:!0,insertSpaces:!1,value:init2||""}),tabCommand=editor.keyCommandMap.Tab;editor.textarea.id="css-editor-textarea",editor.textarea.maxLength=8080,editor.textarea.setAttribute("aria-labelledby","lbl-css"),editor.textarea.placeholder=tradThis("Type in your custom CSS"),editor.addListener("update",value=>{eventDebounce({css:stringMaxSize(value,8080)}),stylelink.textContent=stringMaxSize(value,8080)}),editor.keyCommandMap.Tab=(e,selection,value)=>document.body.matches(".tabbing")?!1:tabCommand?.(e,selection,value)})}function isEvery(freq=""){return["tabs","hour","day","period","pause"].includes(freq)}var quotesTypeForm=networkForm("f_qttype"),quotesUrlForm=networkForm("f_qturl");async function quotes(init2,update){if(update){updateQuotes(update);return}if(!init2)return;let{lang,quotes:quotes2}=init2.sync,needsNewQuote=needsChange(quotes2.frequency,quotes2.last??0),selection=init2.local?.userQuoteSelection??0,list=init2.local?.quotesCache??[],quote=list[0];quotes2.type==="user"?(list=csvUserInputToQuotes(quotes2.userlist),quote=list[selection]):(!list||list?.length===0)&&(list=await tryFetchQuotes(lang,quotes2.type,quotes2.url),quote=list[0],storage.local.set({quotesCache:list})),needsNewQuote&&(quotes2.last=userDate().getTime(),quote=controlCacheList(list,lang,quotes2.type,quotes2.url),storage.sync.set({quotes:quotes2})),insertToDom(quote),toggleAuthorAlwaysOn(quotes2.author),document.getElementById("quotes_container")?.classList.toggle("hidden",!quotes2.on),displayInterface("quotes")}async function updateQuotes({author,frequency,type,userlist,url,refresh}){let data=await storage.sync.get(["lang","quotes"]),local=await storage.local.get("quotesCache");author!==void 0&&(data.quotes.author=author,toggleAuthorAlwaysOn(author)),userlist&&(data.quotes.userlist=handleUserListChange(userlist));let updateData=!1;canStoreUrl(url)&&(data.quotes.url=url,updateData=!0),refresh&&(data.quotes.last=userDate().getTime(),refreshQuotes(data,local?.quotesCache)),isEvery(frequency)&&(data.quotes.frequency=frequency),isQuotesType(type)&&(data.quotes.type=type,updateData=!0),updateData&&updateQuotesData(data),storage.sync.set({quotes:data.quotes})}async function updateQuotesData(data){let isUser=data.quotes.type==="user",list=[],selection=0;if(isUser&&data.quotes.userlist&&(selection=(await storage.local.get("userQuoteSelection"))?.userQuoteSelection??0,list=csvUserInputToQuotes(data.quotes.userlist)),!isUser){let form=data.quotes.type==="url"?quotesUrlForm:quotesTypeForm;try{form.load(),list=await fetchQuotes(data.lang,data.quotes.type,data.quotes.url),form.accept()}catch{form.warn(tradThis("Fetch failed, please check console for more information"))}storage.local.set({quotesCache:list})}list.length>0&&insertToDom(list[selection]),document.getElementById("quotes_userlist")?.classList.toggle("shown",isUser),document.getElementById("quotes_url")?.classList.toggle("shown",data.quotes.type==="url")}function handleUserListChange(input){let array=[];return input.length===0?"":(input.startsWith("[[")?array=csvUserInputToQuotes(oldJSONToCSV(parse(input)??[])):array=csvUserInputToQuotes(input),array.length>0&&(insertToDom({author:array[0].author,content:array[0].content}),document.getElementById("i_qtlist")?.blur(),storage.local.set({userQuoteSelection:0})),input)}function refreshQuotes(sync,quoteslist=[]){let{lang,quotes:quotes2}=sync,{type,url,userlist}=quotes2,list=type==="user"&&userlist?csvUserInputToQuotes(userlist):quoteslist;insertToDom(controlCacheList(list,lang,type,url))}async function fetchQuotes(lang,type,url){if(!navigator.onLine||type==="user")return[];let response;if(type==="url"){if(!url)return[];response=await fetch(url),validateResponse(response);let responseType=determineUrlApiResponseType(response);return responseType==="json"?await response.json():responseType==="csv"?csvToQuotes(await response.text()):[]}let endpoint=type==="classic"?`${lang}`:"",query=`/quotes/${type}/${endpoint}`;return response=await apiFetch(query),validateResponse(response),await response.json()}function validateResponse(response){if(!response)throw new Error("No response");if(!response.ok)throw new Error(`Response not ok: ${response.status} ${response.statusText}`)}async function tryFetchQuotes(lang,type,url){try{return await fetchQuotes(lang,type,url)}catch(_error){console.info(_error)}return[]}function controlCacheList(list,lang,type,url){if(type==="user"){let randIndex=Math.round(Math.random()*(list.length-1));return storage.local.set({userQuoteSelection:randIndex}),list[randIndex]}return list.length>1&&(list.shift(),storage.local.set({quotesCache:list})),list.length<2&&tryFetchQuotes(lang,type,url).then(list2=>{storage.local.set({quotesCache:list2})}),list[0]}function toggleAuthorAlwaysOn(state){document.getElementById("author")?.classList.toggle("always-on",state)}function insertToDom(quote){let quoteDom=document.getElementById("quote"),authorDom=document.getElementById("author");quote&&quoteDom&&authorDom&&(quoteDom.textContent=quote.content,authorDom.textContent=quote.author)}function csvUserInputToQuotes(csv){return csv?Array.isArray(csv)?csvToQuotes(oldJSONToCSV(csv)):csvToQuotes(csv):[]}function oldJSONToCSV(input){return input.map(val=>val.join(",")).join(`
`)}function csvToQuotes(csv){let rows=csv.split(`
`),quotes2=[];for(let row of rows){let[author,...rest2]=row.split(","),content=rest2.join(",").trimStart();quotes2.push({author,content})}return quotes2}function isQuotesType(type=""){return["classic","kaamelott","inspirobot","stoic","hitokoto","office","user","url"].includes(type)}var urlRegEx=/^https?:\/\//i;function canStoreUrl(url){return url===void 0?!1:url===""||urlRegEx.test(url)}function determineUrlApiResponseType(response){let contentType=response.headers.get("content-type")?.split(";",2)[0];if(contentType==="application/json")return"json";if(contentType==="text/csv")return"csv";let parts=new URL(response.url).pathname.split("."),extension=parts[parts.length-1];return equalsCaseInsensitive(extension,"json")?"json":"csv"}function checkModifs(text,mods){for(let[name,str]of Object.entries(mods))if(text.startsWith(`${str} `))return name;return""}function toHTML(self,markdown){let fragment=document.createDocumentFragment();markdown=markdown.replaceAll("	","");for(let line of markdown.split(`

`)){if(line.indexOf(`
`)===-1){fragment.appendChild(self.createLine({text:line,modif:checkModifs(line,self.mods)}));continue}for(let subline of line.split(`
`))fragment.appendChild(self.createLine({text:subline,modif:checkModifs(subline,self.mods)}))}return fragment}function toMarkdown(lines){function addModif(line){return line.dataset.list===""?"- ":line.dataset.h1===""?"# ":line.dataset.h2===""?"## ":line.dataset.h3===""?"### ":line.dataset.todoChecked===""?"[x] ":line.dataset.todo===""?"[ ] ":""}let plaintext="",modif="",isList=line=>line?.dataset.list||line?.dataset.todo;return lines.forEach((line,i)=>{modif=addModif(line),plaintext+=modif+line.textContent;let isWithinList=isList(lines[i+1])&&isList(line),isLastLine=lines.length-1===i;plaintext+=isLastLine?"":isWithinList?`
`:`

`}),plaintext}function lastTextNode(line){let lastNode=line;for(;lastNode?.childNodes.length>0;){let childNodes=Object.values(lastNode.childNodes).reverse(),textNodes=childNodes.filter(child=>child.nodeName==="#text");if(textNodes.length>0)return textNodes[0];lastNode=childNodes[0]}return lastNode}function setCaret(elem,atStart){let node=lastTextNode(elem),sel=window.getSelection(),range=document.createRange(),textlen=node.nodeValue?.length||0;range.setStart(node,atStart?0:textlen),range.setEnd(node,atStart?0:textlen),sel?.removeAllRanges(),sel?.addRange(range),sel?.collapseToEnd()}var history=[];function addUndoHistory(self,lastline){let lines=self.lines,markdown=toMarkdown(lines),index=lastline?lines.indexOf(lastline):0;markdown!==history[0]?.markdown&&(history.unshift({markdown,index}),history.length>50&&history.pop())}function initUndo(self){let timeout;new MutationObserver(()=>{timeout&&clearTimeout(timeout)}).observe(self.container,{characterData:!0,subtree:!0}),self.container.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="z"&&(timeout=window.setTimeout(()=>{applyUndo(self)},1))})}function applyUndo(self){let{markdown,index}=history[0]??{};if(markdown){for(let node of Object.values(self.container.children))node.remove();self.container.appendChild(toHTML(self,markdown)),setTimeout(()=>{let editable=self.container.querySelectorAll("[contenteditable]")[index];editable&&(editable.focus(),setCaret(editable,!1))},0),history.shift(),self.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}}function copyEvent(self,ev){let selected=self.getSelectedLines();selected.length>0&&(ev.clipboardData?.setData("text/plain",toMarkdown(selected)),ev.preventDefault())}function cutEvent(self,ev){let selected=self.getSelectedLines();selected.length>0&&(ev.clipboardData?.setData("text/plain",toMarkdown(selected)),ev.preventDefault(),self.removeLines(selected),addUndoHistory(self,selected[selected.length-1]))}function pasteEvent(self,ev){ev.preventDefault();let selection=window.getSelection(),range=selection?.getRangeAt(0),text=ev.clipboardData?.getData("text")||"";if(checkModifs(text,self.mods)!==""){let editable=ev.target,newHtml=toHTML(self,text),linesInNew=newHtml.childElementCount-1,line=self.getLineFromEditable(editable),selected=self.getSelectedLines();if(selected.length>0&&(line=selected[selected.length-1]),!line?.parentElement?.dataset.pocketEditor)return;self.container.insertBefore(newHtml,self.getNextLine(line));let lastline=line.nextSibling;for(let ii=0;ii<linesInNew;ii++)lastline&&(lastline=lastline.nextSibling);if(lastline&&setCaret(lastline),line&&line.textContent===""){let areSameMods=mod2=>{let currIsMod=line?.dataset[mod2]===mod2,nextIsMod=self.getNextLine(line)?.dataset[mod2]===mod2;return currIsMod===nextIsMod};(line||areSameMods("list")||areSameMods("todo")||areSameMods("todo-checked"))&&line.remove()}self.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(selection?.rangeCount&&range){let offset=selection?.anchorOffset??0,value=selection.focusNode?.nodeValue??"";value&&selection.focusNode?(selection.focusNode.nodeValue=value.slice(0,offset)+text+value.slice(offset),selection.collapse(selection.focusNode,offset+text.length)):(range.insertNode(document.createTextNode(text)),setCaret(range.endContainer))}self.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}function removeModifier(editable){let content=document.createElement("div"),parent=editable.parentElement;if(parent){delete parent.dataset.list,delete parent.dataset.todo,delete parent.dataset.h1,delete parent.dataset.h2,delete parent.dataset.h3,delete parent.dataset.todoChecked,content.textContent=parent.textContent,content.setAttribute("contenteditable","true");for(let node of Object.values(parent.childNodes))node.remove();return parent.appendChild(content),content.focus(),content}}function lineTransform(self,editable,mod2,focus=!0){if(!mod2)return;let line=self.getLineFromEditable(editable);if(!line||line?.dataset[mod2])return;switch(line.querySelector("span[data-list-marker]")?.remove(),line.querySelector("span[data-todo-marker]")?.remove(),delete line.dataset.h1,delete line.dataset.h2,delete line.dataset.h3,delete line.dataset.list,delete line.dataset.todo,delete line.dataset.todoChecked,mod2){case"h1":case"h2":case"h3":toHeading(mod2);break;case"list":toList();break;case"todo":toTodolist(!1);break;case"todo-checked":toTodolist(!0);break;default:}function toHeading(tag){let heading=document.createElement(tag),mod22=tag==="h1"?"#":tag==="h2"?"##":"###";heading.textContent=editable.textContent?.replace(mod22,"").trimStart()||"",heading.setAttribute("contenteditable","true"),line&&(line.dataset[tag]="",editable.replaceWith(heading)),focus&&setCaret(heading)}function toTodolist(checked){let input=document.createElement("input"),span=document.createElement("span"),p=document.createElement("p"),line2=self.getLineFromEditable(editable),content=(editable.textContent??"").replace(self.ZERO_WIDTH_WHITESPACE,"");!line2||line2.dataset.todo||((content.startsWith("[ ]")||content.startsWith("[x]"))&&(content=content.slice(4,content.length)),input.type="checkbox",input.name="checkbox",input.setAttribute("aria-label","todo list checkbox"),input.addEventListener("input",()=>{input.checked?(line2.setAttribute("data-todo-checked",""),input.setAttribute("checked","")):(line2.removeAttribute("data-todo-checked"),line2.setAttribute("data-todo",""),input.removeAttribute("checked"))}),checked&&(input.setAttribute("checked",""),line2.dataset.todoChecked=""),line2.dataset.todo="",span.dataset.todoMarker="",p.textContent=content,p.setAttribute("contenteditable","true"),editable.replaceWith(p),span.appendChild(input),line2.prepend(span),focus&&setCaret(p))}function toList(){let span=document.createElement("span"),p=document.createElement("p"),content=(editable.textContent??"").replace(self.ZERO_WIDTH_WHITESPACE,"");!line||line.dataset.list===""||(content.startsWith("-")&&(content=content?.replace("-","").trimStart()),line.dataset.list="",span.dataset.content="\u2022",span.dataset.listMarker="",p.textContent=content,p.setAttribute("contenteditable","true"),editable.replaceWith(p),line.prepend(span),focus&&setCaret(p))}}function paragraphControl(self,e){let container2=self.container,editable=e.target,range;try{let isContenteditable=editable?.hasAttribute("contenteditable"),isInput=editable?.tagName==="INPUT";if(range=window.getSelection()?.getRangeAt(0),!(range&&isContenteditable)||isInput)throw new Error("?")}catch{return}let line=self.getLineFromEditable(editable),datasets=Object.keys(line?.dataset??{}),insertParagraph=e?.inputType==="insertParagraph",insertText2=e?.inputType==="insertText",modif;if(e.type==="beforeinput"&&insertParagraph&&line){e.preventDefault(),addUndoHistory(self,line);let textContent=(editable.textContent??"").replace(self.ZERO_WIDTH_WHITESPACE,""),cuttext=textContent.slice(0,range.startOffset),nexttext=textContent.slice(range.startOffset);if((range.startOffset===0||textContent===""&&range.startOffset===1)&&datasets.length>0){removeModifier(editable);return}line.dataset.todo===""&&(modif="todo"),line.dataset.list===""&&(modif="list"),line.dataset.todoChecked===""&&(modif="todo");let nextline=self.getNextLine(line),newline=self.createLine({text:nexttext,modif});nextline?container2.insertBefore(newline,nextline):container2?.appendChild(newline),newline.querySelector("[contenteditable]")?.focus(),editable.textContent=cuttext,container2.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(e.type==="input"&&insertText2){let content=(editable?.textContent??"").replace("\u200B","");for(let[mod2,val]of Object.entries(self.mods))(content.startsWith(val+" ")||content.startsWith(val+"\xA0"))&&(modif=mod2,lineTransform(self,editable,modif))}}function detectLineJump(self,ev){let notArrowKey=!ev.key.includes("Arrow"),notSelection=!window.getSelection()?.anchorNode;if(notArrowKey||notSelection)return;let editable=ev.target,line=self.getLineFromEditable(editable),range=window?.getSelection()?.getRangeAt(0),txtLen=range?.startContainer?.nodeValue?.length??0;if(!(range&&line))return;let prevSibling=self.getPrevLine(line),nextSibling=self.getNextLine(line),isCaretAtZero=Math.min(range?.endOffset,range?.startOffset)===0,isCaretAtEnd=Math.max(range?.endOffset,range?.startOffset)===txtLen,goingLeftToPrevious=ev.key==="ArrowLeft"&&isCaretAtZero&&prevSibling,goingRightToNext=ev.key==="ArrowRight"&&isCaretAtEnd&&nextSibling;if(goingLeftToPrevious)return{line,dir:"up"};if(goingRightToNext)return{line,dir:"down"};let top=!1,bottom=!1,rr=range?.getBoundingClientRect(),lr=line?.getBoundingClientRect();!(lr&&rr)||rr.y===0?(top=!0,bottom=!0):(top=lr.top-rr.top+rr.height>0,bottom=rr.bottom+rr.height-lr.bottom>0);let goingUpToPrevious=ev.key==="ArrowUp"&&prevSibling&&top,goingDownToNext=ev.key==="ArrowDown"&&nextSibling&&bottom;if(goingUpToPrevious)return{line,dir:"up"};if(goingDownToNext)return{line,dir:"down"}}function lineSelection(self){let lines=self.lines,caretSelTimeout,lineInterval=[-1,-1],currentLine=-1,firstLine=-1;function caretSelectionDebounce(callback){clearTimeout(caretSelTimeout),caretSelTimeout=window.setTimeout(()=>{callback()},200)}function createRange(selected){if(selected||(selected=self.getSelectedLines()),selected.length===0)return;document.querySelector("#pocket-editor-mock-sel")?.remove();let mockSelection=document.createElement("pre");mockSelection.id="pocket-editor-mock-sel",mockSelection.textContent="mock-selection",mockSelection.setAttribute("contenteditable","true"),self.container.appendChild(mockSelection);let sel=window.getSelection(),range=document.createRange(),textlen=mockSelection.childNodes[0].nodeValue?.length||0;range.setStart(mockSelection.childNodes[0],0),range.setEnd(mockSelection.childNodes[0],textlen),sel?.removeAllRanges(),sel?.addRange(range)}function getLineIndex(editable){let line=self.getLineFromEditable(editable);return line?lines.indexOf(line):-1}function resetLineSelection(){let line=lines[currentLine];line?.querySelector("[contenteditable]")&&setCaret(line),currentLine=-1,firstLine=-1,lineInterval=[-1,-1],document.querySelector("#pocket-editor-mock-sel")?.remove(),self.container.removeEventListener("mousemove",mouseMoveEvent)}function addToLineSelection(index){index>firstLine&&(lineInterval[1]=index),index<firstLine&&(lineInterval[0]=index),index===firstLine&&(lineInterval=[index,index])}function changeLineSelection(index){firstLine=index,lineInterval=[index,index]}function applyLineSelection(interval){lines.forEach((line,i)=>{i>=interval[0]&&i<=interval[1]?line.setAttribute("data-selected",""):line.removeAttribute("data-selected")}),caretSelectionDebounce(()=>createRange())}function initLineSelection(index){currentLine=firstLine=index,lineInterval=[index,index]}function keyboardEvent(e){lines=self.lines;let selected=self.getSelectedLines(),isClipboardKey=e.key.match(/([x|c|v])/g),isCtrlKey=e.key==="Control"||e.key==="Meta",noSelection=selected.length>0,ctrl=e.ctrlKey||e.metaKey;if(isCtrlKey||ctrl&&isClipboardKey&&noSelection)return;if(ctrl&&e.key==="a"){window.getSelection()?.removeAllRanges(),currentLine=firstLine=0,lineInterval=[0,lines.length-1],applyLineSelection(lineInterval),e.preventDefault();return}if(noSelection){if(window.getSelection()?.removeAllRanges(),e.key==="Escape"||e.key==="Tab"){resetLineSelection(),applyLineSelection(lineInterval),e.preventDefault();return}if(e.key.includes("Arrow")){e.key.includes("Down")&&(currentLine=Math.min(currentLine+1,lines.length-1)),e.key.includes("Up")&&(currentLine=Math.max(0,currentLine-1)),e.shiftKey&&addToLineSelection(currentLine),e.shiftKey||changeLineSelection(currentLine),applyLineSelection(lineInterval),e.preventDefault();return}includesAny(e.code,"Shift","Alt","Control","Caps")||(resetLineSelection(),addUndoHistory(self,selected[selected.length- -1]),self.removeLines(selected),e.code==="Enter"&&e.preventDefault())}if(!e.shiftKey)return;let{line}=detectLineJump(self,e)??{};if(line){let index=lines.indexOf(line);initLineSelection(index),applyLineSelection(lineInterval),window.getSelection()?.removeAllRanges()}}function mouseMoveEvent(e){let target=e.target,selected=self.getSelectedLines();selected.length>0&&window.getSelection()?.removeAllRanges();let isCheckbox=target.getAttribute("aria-label")==="todo list checkbox",isListMarker=target.dataset.listMarker,isEditable=!!target.getAttribute("contenteditable");if(isCheckbox||isListMarker||isEditable){if(currentLine=getLineIndex(target),currentLine===firstLine&&selected.length===0)return;addToLineSelection(currentLine),applyLineSelection(lineInterval)}}function mouseDownEvent(event){let target=event.target,rightclick=event.button===2,leftclick=event.button===0,hasSelection=self.getSelectedLines().length>0;lines=self.lines,rightclick&&event.preventDefault(),leftclick&&(hasSelection&&(resetLineSelection(),applyLineSelection(lineInterval)),target.getAttribute("contenteditable")&&(initLineSelection(getLineIndex(target)),self.container.addEventListener("mousemove",mouseMoveEvent)))}function mouseClickEvent(event){let path=event.composedPath(),hasSelection=self.getSelectedLines().length>0;!path.includes(self.container)&&hasSelection&&(lines=self.lines,resetLineSelection(),applyLineSelection(lineInterval)),self.container.removeEventListener("mousemove",mouseMoveEvent)}window.addEventListener("touchend",mouseClickEvent),window.addEventListener("click",mouseClickEvent),self.container.addEventListener("keydown",keyboardEvent),self.container.addEventListener("mousedown",mouseDownEvent)}function includesAny(str,...matches){for(let match of matches)if(str.includes(match))return!0;return!1}function removeLineNoText(editable,prevline){setCaret(prevline),editable.parentElement?.remove()}function removeLineWithText(editable,prevLine){let node=lastTextNode(prevLine),isTextNode=node.nodeType===3,charAmount=node.nodeValue?.length||0,targetText=editable?.textContent||"";node[isTextNode?"nodeValue":"textContent"]+=targetText;let selection=window.getSelection(),range=document.createRange();range.setStart(node,isTextNode?charAmount:0),range.setEnd(node,isTextNode?charAmount:0),selection?.removeAllRanges(),selection?.addRange(range),editable.parentElement.remove()}function lineDeletion(self){let isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0,userAgent2=navigator.userAgent.toLowerCase(),sel=window.getSelection();function applyLineRemove(ev){let editable=ev.target,line=self.getLineFromEditable(editable),isTouch="ontouchstart"in window||navigator.maxTouchPoints>0,isEditable=!!editable.getAttribute("contenteditable"),isAtStart=sel?.getRangeAt(0)?.endOffset===0,isDelEvent=ev.inputType==="deleteContentBackward";if(ev.type==="beforeinput"&&!isDelEvent||!isAtStart||!isEditable)return;if(ev.preventDefault(),line&&addUndoHistory(self,line),Object.keys(line?.dataset??{}).length>0){let newEditable=removeModifier(editable);isTouch&&newEditable&&newEditable.textContent===""&&(newEditable.textContent=self.ZERO_WIDTH_WHITESPACE,setCaret(newEditable));return}let prevline=self.getPrevLine(line);prevline&&(editable.textContent===""&&removeLineNoText(editable,prevline),editable.textContent!==""&&removeLineWithText(editable,prevline))}if(self.container.addEventListener("beforeinput",applyLineRemove),userAgent2.includes("safari")&&!(userAgent2.includes("chrome")&&userAgent2.includes("chromium"))&&self.container.addEventListener("keydown",e=>{try{let range=sel?.getRangeAt(0),isBackspacing=e.key==="Backspace",isAtContainerStart=range?.startOffset===0;isBackspacing&&isAtContainerStart&&applyLineRemove(e)}catch{}}),isTouchDevice){let triggerDeleteLine=!1;self.container.addEventListener("beforeinput",ev=>{let editable=ev.target,deleteContent=ev.inputType==="deleteContentBackward",whitespaceOnly=editable.textContent===self.ZERO_WIDTH_WHITESPACE;deleteContent&&whitespaceOnly&&(triggerDeleteLine=!0)}),self.container.addEventListener("keyup",ev=>{let editable=ev.target;if(triggerDeleteLine){triggerDeleteLine=!1,applyLineRemove(ev);return}editable.textContent===""&&(editable.textContent=self.ZERO_WIDTH_WHITESPACE,setCaret(editable))})}}function caretControl(self){let averageCharWidth=0;function initAverageCharWidth(){let p=document.createElement("p"),span=document.createElement("span");p.id="pocket-editor-mock-p",span.textContent="abcdefghijklmnopqrstuvwxyz0123456789",p?.appendChild(span),self.container.querySelector(".line [contenteditable]")?.appendChild(p),averageCharWidth=span.offsetWidth/36/2,p.remove()}function rangePosInCharLen(line,str){let sel=window.getSelection(),charCount=-1,x=getHorizontalPosition(sel,line),offset=self.caret_x??x.offset,editable=line?.querySelector("[contenteditable]"),textnode=lastTextNode(editable),range=document.createRange();range.setStart(textnode,0),range.setEnd(textnode,0);let rangeX=0;for(let i=0;i<str.length-1;i++){try{range.setStart(textnode,i),range.setEnd(textnode,i)}catch{break}if(rangeX=range.getBoundingClientRect().x-x.editable,rangeX+averageCharWidth>=offset){charCount=i;break}}return charCount}function getParagraphAsArray(line){let editable=line?.querySelector("[contenteditable]");if(!editable)return console.warn("Couldn't get string[], no contenteditable found"),[];let pos=0,rangeY=0,rangeYlast=0,lines=[""],words=(editable.textContent??"").split(" "),textnode=lastTextNode(editable),range=document.createRange();range.setStart(textnode,0),range.setEnd(textnode,0);let isWebkit=navigator.userAgent.includes("AppleWebKit");rangeYlast=rangeY=range.getBoundingClientRect().y;for(let word of words){word=`${word} `,pos+=word.length;try{range.setStart(textnode,pos),range.setEnd(textnode,pos),rangeY=range.getBoundingClientRect().y}catch{}isWebkit&&(lines[0]+=word),rangeY>rangeYlast&&(isWebkit&&(lines[0]=lines[0].trimEnd()),lines.unshift(""),rangeYlast=rangeY),isWebkit===!1&&(lines[0]+=word)}return lines.reverse(),lines}self.container.addEventListener("pointerdown",()=>{self.caret_x=void 0}),self.container.addEventListener("keydown",ev=>{if(!ev.key.includes("Arrow"))return;let goesRight=ev.key==="ArrowRight",goesLeft=ev.key==="ArrowLeft",{line,dir}=detectLineJump(self,ev)??{},sel=window.getSelection(),range=document.createRange(),node=document.createTextNode(""),offset=0;if(goesLeft||goesRight?self.caret_x=void 0:self.caret_x===void 0&&(self.caret_x=getHorizontalPosition(sel,line).offset),!!line){if(averageCharWidth===0&&initAverageCharWidth(),dir==="down"){let nextline=self.getNextLine(line)??line;node=lastTextNode(nextline);let textlen=node.nodeValue?.length||0;if(!goesRight){let rows=getParagraphAsArray(nextline);offset=rangePosInCharLen(nextline,rows[0])??-1,offset<0&&(offset=textlen)}}if(dir==="up"){let prevline=self.getPrevLine(line)??line;node=lastTextNode(prevline);let textlen=node.nodeValue?.length||0;if(offset=textlen,!goesLeft){let rows=getParagraphAsArray(prevline),lastrow=rows[rows.length-1].trimEnd(),lastrowOffset=rangePosInCharLen(prevline,lastrow)??textlen;offset=textlen-(lastrow.length-lastrowOffset),lastrowOffset<0&&(offset=textlen)}}try{range.setStart(node,offset),range.setEnd(node,offset),sel?.removeAllRanges(),sel?.addRange(range),sel?.collapseToEnd(),ev.preventDefault()}catch{console.warn("Cannot set caret")}}})}function getHorizontalPosition(selection,line){let selectionNotValid=!selection?.anchorNode;if(!line||selectionNotValid)return{editable:0,range:0,offset:0};let editableX=line.querySelector("[contenteditable]")?.getBoundingClientRect().x??0,rangeX=selection?.getRangeAt(0)?.cloneRange()?.getBoundingClientRect().x??0;return{editable:editableX,range:rangeX,offset:rangeX-editableX}}function keybindings(self,ev){let editable=ev.target,isValid=(ev.ctrlKey||ev.metaKey)&&ev.shiftKey&&ev.code.includes("Digit"),line=self.getLineFromEditable(editable);if(isValid&&editable){let index=Number.parseInt(ev.code.replace("Digit",""))-1,targetMod=Object.keys(self.mods)[index];if(line?.hasAttribute(`data-${targetMod}`)||index===5){ev.preventDefault(),removeModifier(editable);return}targetMod in self.mods&&targetMod!=="todo-checked"&&(ev.preventDefault(),lineTransform(self,editable,targetMod))}}var PocketEditor=class{container;lines;wrapper;caret_x;ZERO_WIDTH_WHITESPACE="\u200B";mods={h1:"#",h2:"##",h3:"###",list:"-",todo:"[ ]","todo-checked":"[x]"};constructor(parent,options){let div=document.createElement("div"),{text,defer,id}=options??{};if(this.wrapper=typeof parent=="string"?document.querySelector(parent):parent,this.container=div,this.lines=[],this.wrapper===null)throw new Error(`Pocket editor: selector "${parent}" was not found`);id&&(div.id=id),div.dataset.pocketEditor="",typeof defer=="number"?setTimeout(()=>this.init(text),defer):defer===!0?setTimeout(()=>this.init(text)):this.init(text)}init(text){text?this.container.appendChild(toHTML(this,text)):this.container.appendChild(this.createLine({text:""})),this.wrapper&&this.wrapper.appendChild(this.container),this.container.addEventListener("beforeinput",ev=>paragraphControl(this,ev)),this.container.addEventListener("input",ev=>paragraphControl(this,ev)),this.container.addEventListener("keydown",ev=>keybindings(this,ev)),this.container.addEventListener("paste",ev=>pasteEvent(this,ev)),this.container.addEventListener("copy",ev=>copyEvent(this,ev)),this.container.addEventListener("cut",ev=>cutEvent(this,ev)),lineSelection(this),caretControl(this),lineDeletion(this),initUndo(this);let lineObserverCallback=()=>{this.lines=Object.values(this.container.children)};new MutationObserver(lineObserverCallback).observe(this.container,{childList:!0}),this.lines=Object.values(this.container.children)}get value(){return toMarkdown(this.lines)}set value(text){for(let node of Object.values(this.container.children))node.remove();this.container.appendChild(toHTML(this,text))}oninput(listener){let self=this;return this.container.addEventListener("cut",cb),this.container.addEventListener("paste",cb),this.container.addEventListener("input",cb),this.container.addEventListener("beforeinput",cb),()=>{this.container.removeEventListener("cut",cb),this.container.removeEventListener("paste",cb),this.container.removeEventListener("input",cb),this.container.removeEventListener("beforeinput",cb)};function cb(e){e.type==="beforeinput"&&!e.inputType.match(/(deleteContentBackward|insertParagraph)/g)||listener(self.value)}}addEventListener(_,listener){return this.oninput(listener)}getSelectedLines(){return this.lines.filter(line=>line.dataset.selected!==void 0)??[]}getPrevLine(line){return this.lines[this.lines.indexOf(line)-1]}getNextLine(line){return this.lines[this.lines.indexOf(line)+1]}getLineFromEditable(elem){for(;elem?.parentElement;){let parent=elem.parentElement;if(parent.tagName==="DIV")return parent;elem=parent}return null}removeLines(lines){let emptyLine=this.createLine(),prevline=this.getPrevLine(lines[0]);for(let line of lines)line.remove();prevline?this.insertAfter(emptyLine,prevline):this.container.prepend(emptyLine),setCaret(emptyLine),this.container.dispatchEvent(new InputEvent("input",{inputType:"deleteContent",bubbles:!0,data:""}))}createLine(props){let notesline=document.createElement("div"),editable=document.createElement("p"),mod2=props?.modif??"",mods=this.mods;return editable.setAttribute("contenteditable","true"),notesline.appendChild(editable),typeof props?.text=="string"&&(editable.textContent=props.text),mod2 in mods&&lineTransform(this,editable,mod2,!1),notesline}insertAfter(newNode,existingNode){existingNode?.parentNode?.insertBefore(newNode,existingNode.nextSibling)}},index_default=PocketEditor;globalThis.PocketEditor=PocketEditor;var container=document.getElementById("notes_container");function notes(init2,event){if(event){updateNotes(event);return}init2&&(init2.on?initNotes(init2):onSettingsLoad(()=>initNotes(init2)))}async function updateNotes(event){let notes2=(await storage.sync.get("notes"))?.notes;notes2&&(event?.text!==void 0&&(notes2.text=event.text),event?.align!==void 0&&(notes2.align=event.align,handleAlign(notes2.align)),event?.width!==void 0&&(notes2.width=Number.parseInt(event.width),handleWidth(notes2.width)),event?.background&&(notes2.background=hexColorFromSplitRange("notes-background-range"),handleBackground(notes2.background)),eventDebounce({notes:notes2}))}function initNotes(init2){document.getElementById("pocket-editor")?.remove(),handleAlign(init2.align),handleWidth(init2.width),handleBackground(init2.background),handleToggle(init2.on),init2.text=init2.text??translateNotesText(),new index_default("#notes_container",{text:init2.text,id:"pocket-editor"}).oninput(content=>{updateNotes({text:content})})}function handleToggle(state){container?.classList.toggle("hidden",!state)}function handleAlign(value){container?.classList.toggle("center-align",value==="center"),container?.classList.toggle("right-align",value==="right")}function handleWidth(value){value&&document.documentElement.style.setProperty("--notes-width",`${value.toString()}em`)}function handleBackground(hex="#fff2"){container&&(container?.classList.toggle("opaque",hex.includes("#fff")&&opacityFromHex(hex)>7),document.documentElement.style.setProperty("--notes-background",hex))}function translateNotesText(){let lang=getLang();lang&&lang in langList||(lang="en");let line1=tradThis("Edit this note"),line2=tradThis("With markdown titles, lists, and checkboxes"),line3=tradThis("Learn more on <url>");return`## ${line1}!

[ ] ${line2}

[ ] ${line3.replace("<url>","https://bonjourr.fr/docs/overview")}`}var JSON_PROTO=Object.getPrototypeOf({});function fastifyDeepMerge(options){function isNotPrototypeKey(value){return value!=="constructor"&&value!=="prototype"&&value!=="__proto__"}function cloneArray(value){let i=0,il=value.length,result=new Array(il);for(i=0;i<il;++i)result[i]=clone(value[i]);return result}function cloneObject(target){let result={};if(cloneProtoObject&&Object.getPrototypeOf(target)!==JSON_PROTO)return cloneProtoObject(target);let targetKeys=getKeys(target),i,il,key;for(i=0,il=targetKeys.length;i<il;++i)isNotPrototypeKey(key=targetKeys[i])&&(result[key]=clone(target[key]));return result}function concatArrays(target,source){let tl=target.length,sl=source.length,i=0,result=new Array(tl+sl);for(i=0;i<tl;++i)result[i]=clone(target[i]);for(i=0;i<sl;++i)result[i+tl]=clone(source[i]);return result}let propertyIsEnumerable=Object.prototype.propertyIsEnumerable;function getSymbolsAndKeys(value){let result=Object.keys(value),keys=Object.getOwnPropertySymbols(value);for(let i=0,il=keys.length;i<il;++i)propertyIsEnumerable.call(value,keys[i])&&result.push(keys[i]);return result}let getKeys=options&&options.symbols?getSymbolsAndKeys:Object.keys,cloneProtoObject=typeof options?.cloneProtoObject=="function"?options.cloneProtoObject:void 0;function isMergeableObject(value){return typeof value=="object"&&value!==null&&!(value instanceof RegExp)&&!(value instanceof Date)}function isPrimitive(value){return typeof value!="object"||value===null}let isPrimitiveOrBuiltIn=typeof Buffer<"u"?value=>typeof value!="object"||value===null||value instanceof RegExp||value instanceof Date||value instanceof Buffer:value=>typeof value!="object"||value===null||value instanceof RegExp||value instanceof Date,mergeArray=options&&typeof options.mergeArray=="function"?options.mergeArray({clone,deepmerge:_deepmerge,getKeys,isMergeableObject}):concatArrays;function clone(entry){return isMergeableObject(entry)?Array.isArray(entry)?cloneArray(entry):cloneObject(entry):entry}function mergeObject(target,source){let result={},targetKeys=getKeys(target),sourceKeys=getKeys(source),i,il,key;for(i=0,il=targetKeys.length;i<il;++i)isNotPrototypeKey(key=targetKeys[i])&&sourceKeys.indexOf(key)===-1&&(result[key]=clone(target[key]));for(i=0,il=sourceKeys.length;i<il;++i)isNotPrototypeKey(key=sourceKeys[i])&&(key in target&&(targetKeys.indexOf(key)!==-1&&(result[key]=_deepmerge(target[key],source[key])),!0)||(result[key]=clone(source[key])));return result}function _deepmerge(target,source){let sourceIsArray=Array.isArray(source),targetIsArray=Array.isArray(target);return isPrimitive(source)?source:isPrimitiveOrBuiltIn(target)?clone(source):sourceIsArray&&targetIsArray?mergeArray(target,source):sourceIsArray!==targetIsArray?clone(source):mergeObject(target,source)}function _deepmergeAll(){switch(arguments.length){case 0:return{};case 1:return clone(arguments[0]);case 2:return _deepmerge(arguments[0],arguments[1])}let result;for(let i=0,il=arguments.length;i<il;++i)result=_deepmerge(result,arguments[i]);return result}return options&&options.all?_deepmergeAll:_deepmerge}var deepmerge=fastifyDeepMerge({symbols:!1}),deepmergeAll=fastifyDeepMerge({all:!0,symbols:!1});function filterImports(current,target){let newtarget=target,newcurrent=current;return newtarget=convertOldCssSelectors(newtarget),newtarget=booleanSearchbarToObject(newtarget),newtarget=linkListToFlatObjects(newtarget),newtarget=hideArrayToObject(newtarget),newtarget=improvedWeather(newtarget),newtarget=clockDateFormat(newtarget),newtarget=newFontSystem(newtarget),newtarget=newReviewData(newtarget),newtarget=quotesJsonToCsv(newtarget),newtarget=linksDataMigration(newtarget),newtarget=analogClockOptions(newtarget),newtarget=validateLinkGroups(newtarget),newtarget=addSupporters(newtarget),newtarget=toIsoLanguageCode(newtarget),newtarget=newBackgroundsField(newtarget),newtarget=manualTimezonesToIntl(newtarget),newcurrent=deepmergeAll(newcurrent,newtarget,{about:{browser:PLATFORM,version:CURRENT_VERSION}}),newcurrent=removeLinkgroupDuplicates(newcurrent),newcurrent=removeWorldClocksDuplicate(newcurrent,newtarget),newcurrent=toggleMoveWidgets(newcurrent,newtarget),delete newcurrent.settingssync,delete newcurrent.custom_every,delete newcurrent.custom_time,delete newcurrent.searchbar_newtab,delete newcurrent.searchbar_newtab,delete newcurrent.searchbar_engine,delete newcurrent.cssHeight,delete newcurrent.linktabs,delete newcurrent.links,delete newcurrent.dynamic,delete newcurrent.unsplash,delete newcurrent.background_blur,delete newcurrent.background_bright,delete newcurrent.background_type,delete newcurrent.usdate,newcurrent}function addSupporters(data){return data.supporters===void 0&&(data.supporters={enabled:!0,closed:!1,month:-1}),data}function hideArrayToObject(data){let newhide={};return Array.isArray(data.hide)&&(data.hide[0]?.[0]&&(newhide.clock=!0),data.hide[0]?.[1]&&(newhide.date=!0),data.hide[1]?.[0]&&(newhide.greetings=!0),data.hide[1]?.[1]&&(newhide.weatherdesc=!0),data.hide[1]?.[2]&&(newhide.weathericon=!0),data.hide[3]?.[0]&&(newhide.settingsicon=!0),data.hide=newhide,data.time=!(data.hide.clock&&data.hide.date),data.main=!(data.hide.weatherdesc&&data.hide.weathericon&&data.hide.weathericon)),data}function booleanSearchbarToObject(data){return typeof data.searchbar=="boolean"&&(data.searchbar={...SYNC_DEFAULT.searchbar,on:data.searchbar,newtab:data.searchbar_newtab,engine:data.searchbar_engine?.replace("s_","")||"google",suggestions:!1}),data}function linkListToFlatObjects(data){if(Array.isArray(data.links)){data.links.length>0&&data.quicklinks===void 0&&(data.quicklinks=!0),data.links?.forEach(({title,url,icon},i)=>{let id=`links${randomString(6)}`,filteredIcon=icon?.startsWith("alias:")?data[icon]:icon;data[id]={_id:id,order:i,title,url,icon:filteredIcon}});let aliasKeyList=Object.keys(data).filter(key=>key.match("alias:"));for(let key of aliasKeyList)data[key]=void 0}return data}function newFontSystem(data){return data.font&&(data.font.weightlist=data.font?.availWeights??[],data.font.url=void 0,data.font.availWeights=void 0,data.font.system===void 0&&(data.font.system=!1)),data}function newReviewData(data){return data.reviewPopup&&(data.review=data.reviewPopup==="removed"?-1:+data.reviewPopup),data}function quotesJsonToCsv(data){return Array.isArray(data?.quotes?.userlist)&&(data.quotes.userlist=oldJSONToCSV(data.quotes.userlist)),data}function toIsoLanguageCode(data){return data.lang=countryCodeToLanguageCode(data.lang??"en"),data}function clockDateFormat(data){return data.usdate?data.dateformat="us":data.dateformat="auto",data}function removeWorldClocksDuplicate(current,target){return target.worldclocks&&current.worldclocks&&(current.worldclocks=target.worldclocks),current}function manualTimezonesToIntl(data){let timezoneMatches={"-10":"-10:00","-9":"-09:00","-8":"-08:00","-7":"-07:00","-6":"-06:00","-5":"-05:00","-4":"-04:00","-3":"-03:00","+0":"+00:00","+1":"+01:00","+2":"+02:00","+3":"+03:00","+5:30":"+05:30","+7":"+07:00","+8":"+08:00","+9":"+09:00","+10":"+10:00","+12":"+12:00"},oldTimezones=Object.keys(timezoneMatches);return data.clock&&oldTimezones.includes(data.clock.timezone)&&(data.clock.timezone=timezoneMatches[data.clock.timezone]),data.worldclocks?.forEach(({timezone},i)=>{let isOld=oldTimezones.includes(timezone);data.worldclocks?.[i]&&isOld&&(data.worldclocks[i].timezone=timezoneMatches[timezone])}),data}function validateLinkGroups(current){let links=bundleLinks(current),parents=[...new Set(links.map(link=>link.parent))],parentGroups=parents.filter(p=>!p?.toString().startsWith("links")),oldNumberParents=parents.filter(parent=>typeof parent=="number"),oldlinktabs=current.linktabs;if(oldlinktabs&&oldNumberParents.length>0){current.linkgroups={on:oldlinktabs.active,selected:oldlinktabs.titles[oldlinktabs.selected],groups:[...oldlinktabs.titles],synced:[],pinned:[]};for(let link of links)typeof link?.parent=="number"&&(link.parent=current.linkgroups.groups[link.parent]),current[link._id]=link}current.linkgroups||(current.linkgroups=SYNC_DEFAULT.linkgroups);let{groups:groups2,pinned,synced,selected}=current.linkgroups;current.linkgroups.selected=selected||"default",current.linkgroups.groups=groups2.map(val=>val||"default"),current.linkgroups.pinned=pinned.map(val=>val||"default"),current.linkgroups.synced=synced.map(val=>val||"default");for(let link of links)link?.parent||(link.parent=current.linkgroups.selected,current[link._id]=link);links=bundleLinks(current),parents=[...new Set(links.map(link=>link.parent))],parentGroups=parents.filter(p=>!p?.toString().startsWith("links"));for(let group of parentGroups)group&&current.linkgroups.groups.push(group.toString());current.linkgroups.groups.length>1&&(current.linkgroups.on=!0);let parentNoDefault=current.linkgroups.groups.filter(group=>group!=="default"),defaultExists=current.linkgroups.groups.includes("default"),defaultIsEmpty=parentGroups.includes("default")===!1,hasUserGroups=parentNoDefault.length>0,hasLinks=links.length>0;return defaultExists&&defaultIsEmpty&&hasUserGroups&&hasLinks&&(current.linkgroups.groups=parentNoDefault,current.linkgroups.selected=parentNoDefault[0]),current}function linksDataMigration(data){if(data?.linktabs||data?.linkgroups)return data;let notfoundicon="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI2MiIgdmlld0JveD0iMC",list=bundleLinks(data).sort((a,b)=>(a.order??0)-(b.order??0));for(let link of list)link.icon?.startsWith(notfoundicon)&&(link.icon=`${API_DOMAIN}/favicon/blob/`,data[link._id]=link);return data}function improvedWeather(data){if(data.weather&&data.weather?.geolocation===void 0){let oldLocation=data.weather?.location??[];data.weather.geolocation="approximate",data.weather.geolocation=oldLocation.length===0?"off":"precise",data.weather.location=void 0,data.weather.lastState=void 0,data.weather.lastCall=void 0}return data}function newBackgroundsField(data){let olddata=data,defaults=structuredClone(SYNC_DEFAULT);return data.backgrounds||(data.backgrounds=defaults.backgrounds),olddata.background_blur!==void 0&&(data.backgrounds.blur=olddata.background_blur),olddata.background_bright!==void 0&&(data.backgrounds.bright=olddata.background_bright),olddata.background_type!==void 0&&(data.backgrounds.type=olddata.background_type==="unsplash"?"images":"files"),olddata.unsplash&&(data.backgrounds.frequency=olddata.unsplash?.every??"hour"),olddata.unsplash?.collection&&(data.backgrounds.images="unsplash-images-collections",data.backgrounds.queries={"unsplash-images-collections":olddata.unsplash.collection}),data}function analogClockOptions(data){return data.clock?.style&&(data.analogstyle={background:"#fff2",border:"#ffff",face:data?.clock?.face||"none",shape:"round",hands:"modern"},(data.clock.style==="round"||data.clock.style==="square")&&(data.analogstyle.shape=data.clock.style),data.clock.style==="transparent"&&(data.analogstyle.background="#fff0",data.analogstyle.border="#fff0")),data}function removeLinkgroupDuplicates(current){current.linkgroups.groups=[...new Set(current.linkgroups.groups)],current.linkgroups.pinned=[...new Set(current.linkgroups.pinned)],current.linkgroups.synced=[...new Set(current.linkgroups.synced)];let defaultGroupAsParent=bundleLinks(current).map(l=>l.parent).some(parent=>parent==="default");return current.linkgroups.groups.length>1&&!defaultGroupAsParent&&(current.linkgroups.groups=current.linkgroups.groups.filter(item=>item!=="default"),current.linkgroups.pinned=current.linkgroups.pinned.filter(item=>item!=="default"),current.linkgroups.synced=current.linkgroups.synced.filter(item=>item!=="default")),current}function toggleMoveWidgets(current,imported){if(imported.move){current.move=imported.move;let area=(current.move.layouts[current.move.selection]?.grid??defaultLayouts[current.move.selection].grid).flat().join(" ");return current.time=area.includes("time"),current.main=area.includes("main"),current.quicklinks=area.includes("quicklinks"),current.notes&&(current.notes.on=area.includes("notes")),current.quotes&&(current.quotes.on=area.includes("quotes")),current.searchbar&&(current.searchbar.on=area.includes("searchbar")),current}if(!imported.move){let importStates={time:imported.time??current.time,main:imported.main??current.main,notes:imported.notes?.on??current.notes?.on,quotes:imported.quotes?.on??current.quotes?.on,searchbar:imported.searchbar?.on??current.searchbar?.on,quicklinks:imported.quicklinks??current.quicklinks},diffWidgets={time:current.time!==importStates.time,main:current.main!==importStates.main,notes:current.notes?.on!==importStates.notes,quotes:current.quotes?.on!==importStates.quotes,searchbar:current.searchbar?.on!==importStates.searchbar,quicklinks:current.quicklinks!==importStates.quicklinks};Object.keys(imported).some(key=>key.match(/time|main|notes|quotes|searchbar|quicklinks/g))&&(current.move.selection="single");let selection=current.move.selection,layout=structuredClone(current.move.layouts[selection]),diffEntries=Object.entries(diffWidgets).filter(([_,diff])=>diff===!0);if(!layout)return current;for(let[key]of diffEntries){let id=key,gridToggle=importStates[id]?addGridWidget:removeGridWidget;layout.grid=gridParse(gridToggle(gridStringify(layout.grid),id,selection))}current.move.layouts[selection]=layout}return current}function convertOldCssSelectors(data){return data?.css&&(data.css=data.css.replaceAll(".block",".link").replaceAll("#clock","#digital").replaceAll("#analogClock","#analog").replaceAll("#center","#analog-center").replaceAll("#hours","#analog-hours").replaceAll("#minutes","#analog-minutes").replaceAll("#analogSeconds","#analog-seconds").replaceAll("#creditContainer","#credit-container")),data}var import_mod7=__toESM(require_dist());function stringify2(data){let defaultSyncData=structuredClone(SYNC_DEFAULT);for(let link of bundleLinks(data))defaultSyncData[link._id]=link;for(let key of Object.keys(data)){let curr=data[key],def=defaultSyncData[key];isObject(curr)&&isObject(def)&&(defaultSyncData[key]={...def,...curr})}let keys=flattenKeys(defaultSyncData),compare=(a="",b="")=>keys.indexOf(a)-keys.indexOf(b);return JSON.stringify(data,keys.sort(compare),2)}function flattenKeys(obj){let result=[];for(let[key,value]of Object.entries(obj))result.push(key),isObject(value)&&result.push(...flattenKeys(value));return result}function isObject(value){return!Array.isArray(value)&&typeof value=="object"}var settingsInitSync,settingsInitLocal;function settingsInit(sync,local){let showsettings=document.getElementById("show-settings");settingsInitSync=sync,settingsInitLocal=local,document.body?.addEventListener("keydown",settingsInitEvent),showsettings?.addEventListener("pointerdown",settingsInitEvent)}function settingsInitEvent(event){let showsettings=document.getElementById("show-settings"),settings=document.getElementById("settings"),settingsAreHidden=settings?.classList.contains("hidden"),isLeftClick=event?.button===0,isEscape=event?.code==="Escape";if(!(settingsAreHidden&&(isEscape||isLeftClick)))return;let local=settingsInitLocal,sync=settingsInitSync;settings?.removeAttribute("style"),settings?.classList.remove("hidden"),document.dispatchEvent(new Event("settings")),document.addEventListener("toggle-settings",settingsToggle),document.body?.removeEventListener("keydown",settingsInitEvent),showsettings?.removeEventListener("pointerdown",settingsInitEvent),showall(sync.showall,!1),traduction(settings,sync.lang),translatePlaceholders(),initBackgroundOptions(sync,local),initSupportersSettingsNotif(sync),initOptionsValues(sync,local),initOptionsEvents(),settingsFooter(),setTimeout(()=>{initWorldClocksAndTimezone(sync),updateSettingsJson(sync),updateSettingsEvent(),translateAriaLabels(),settingsDrawerBar(),loadCallbacks(),settings?.classList.remove("init")},500)}function settingsToggle(){let dombackgroundactions=document.getElementById("background-actions"),domshowsettings=document.getElementById("show-settings"),dominterface3=document.getElementById("interface"),domsettings=document.getElementById("settings"),domedit=document.getElementById("editlink"),isClosed=domsettings?.classList.contains("shown")===!1;domsettings?.classList.toggle("shown",isClosed),domedit?.classList.toggle("pushed",isClosed),dominterface3?.classList.toggle("pushed",isClosed),domshowsettings?.classList.toggle("shown",isClosed),dombackgroundactions?.classList.toggle("pushed",isClosed),domsettings?.style.removeProperty("transform"),domsettings?.style.removeProperty("transition"),document.dispatchEvent(new Event("close-edit"))}function initOptionsValues(data,local){let domsettings=document.getElementById("settings"),userQuotes=data.quotes?.userlist?.[0]?data.quotes?.userlist:void 0;if(setInput("i_blur",data.backgrounds.blur??15),setInput("i_bright",data.backgrounds.bright??.8),setInput("i_fadein",data.backgrounds.fadein??400),setInput("i_row",data.linksrow||8),setInput("i_linkstyle",data.linkstyle||"default"),setInput("i_type",data.backgrounds.type||"images"),setInput("i_freq",data.backgrounds?.frequency||"hour"),setInput("i_dark",data.dark||"system"),setInput("i_favicon",data.favicon??""),setInput("i_tabtitle",data.tabtitle??""),setInput("i_solid-background",data.backgrounds.color??"#185A63"),setInput("i_texture",data.backgrounds.texture.type??"none"),setInput("i_texture-size",data.backgrounds.texture.size??"220"),setInput("i_texture-opacity",data.backgrounds.texture.opacity??"0.1"),setInput("i_texture-color",data.backgrounds.texture.color??"#ffffff"),setInput("i_pagewidth",data.pagewidth||1600),setInput("i_pagegap",data.pagegap??1),setInput("i_dateformat",data.dateformat||"eu"),setInput("i_greeting",data.greeting??""),setInput("i_textshadow",data.textShadow??.2),setInput("i_noteswidth",data.notes?.width||50),setInput("i_notes-opacity",opacityFromHex(data.notes?.background??"#fff2")),setInput("i_notesalign",data.notes?.align||"left"),setInput("i_sbengine",data.searchbar?.engine||"google"),setInput("i_sbplaceholder",data.searchbar?.placeholder||""),setInput("i_sb-opacity",opacityFromHex(data.searchbar?.background??"#fff2")),setInput("i_sbwidth",data.searchbar?.width??30),setInput("i_sbrequest",data.searchbar?.request||""),setInput("i_qtfreq",data.quotes?.frequency||"day"),setInput("i_qttype",data.quotes?.type||"classic"),setInput("i_qtlist",userQuotes??""),setInput("i_qturl",data.quotes?.url??""),setInput("i_clockface",data.analogstyle?.face||"none"),setInput("i_clockhands",data.analogstyle?.hands||"none"),setInput("i_clockshape",data.analogstyle?.shape||"round"),setInput("i_analog-border-opacity",opacityFromHex(data.analogstyle?.border??"#ffff")),setInput("i_analog-background-opacity",opacityFromHex(data.analogstyle?.background??"#fff2")),setInput("i_clocksize",data.clock?.size??5),setInput("i_timezone",data.clock?.timezone||"auto"),setInput("i_geol",data.weather?.geolocation||"approximate"),setInput("i_units",data.weather?.unit??"metric"),setInput("i_forecast",data.weather?.forecast||"auto"),setInput("i_temp",data.weather?.temperature||"actual"),setInput("i_moreinfo",data.weather?.moreinfo||"none"),setInput("i_provider",data.weather?.provider??""),setInput("i_weight",data.font?.weight||"300"),setInput("i_size",data.font?.size||(IS_MOBILE?"11":"14")),setInput("i_announce",data.announcements??"major"),setInput("i_synctype",local.syncType??(PLATFORM==="online"?"off":"browser")),setFormInput("i_city",local.lastWeather?.approximation?.city??"Paris",data.weather.city),setFormInput("i_customfont",systemfont.placeholder,data.font?.family),setFormInput("i_gistsync","github_pat_XX000X00X",local?.gistToken),setFormInput("i_urlsync","https://pastebin.com/raw/y7XhhiDs",local?.distantUrl),setCheckbox("i_showall",data.showall),setCheckbox("i_settingshide",data.hide?.settingsicon??!1),setCheckbox("i_background-local-compress",local.backgroundCompressFiles??!0),setCheckbox("i_quicklinks",data.quicklinks),setCheckbox("i_linkgroups",data?.linkgroups?.on),setCheckbox("i_linknewtab",data.linknewtab),setCheckbox("i_time",data.time),setCheckbox("i_analog",data.clock?.analog??!1),setCheckbox("i_seconds",data.clock?.seconds??!1),setCheckbox("i_worldclocks",data.clock?.worldclocks??!1),setCheckbox("i_main",data.main),setCheckbox("i_greethide",!data.hide?.greetings),setCheckbox("i_notes",data.notes?.on??!1),setCheckbox("i_sb",data.searchbar?.on??!1),setCheckbox("i_quotes",data.quotes?.on??!1),setCheckbox("i_ampm",data.clock?.ampm??!1),setCheckbox("i_ampm-label",data.clock?.ampmlabel??!1),setCheckbox("i_sbsuggestions",data.searchbar?.suggestions??!0),setCheckbox("i_sbnewtab",data.searchbar?.newtab??!1),setCheckbox("i_qtauthor",data.quotes?.author??!1),setCheckbox("i_supporters_notif",data.supporters?.enabled??!0),colorInput("solid-background",data.backgrounds.color),colorInput("texture-color",data.backgrounds.texture.color??"#ffffff"),paramId("i_analog-border-shade")?.classList.toggle("on",(data.analogstyle?.border??"#fff").includes("#000")),paramId("i_analog-background-shade")?.classList.toggle("on",(data.analogstyle?.background??"#fff").includes("#000")),paramId("i_notes-shade")?.classList.toggle("on",(data.notes?.background??"#fff").includes("#000")),paramId("i_sb-shade")?.classList.toggle("on",(data.searchbar?.background??"#fff").includes("#000")),IS_MOBILE){let tooltiptext=domsettings.querySelector(".tooltiptext .instructions"),text=tradThis("Edit your Quick Links by long-pressing the icon.");tooltiptext&&(tooltiptext.textContent=text)}let langInput=paramId("i_lang");for(let[code,title]of Object.entries(langList)){let option=document.createElement("option");option.value=code,option.text=title,langInput.appendChild(option)}setInput("i_lang",data.lang||"en"),paramId("time_options")?.classList.toggle("shown",data.time),paramId("analog_options")?.classList.toggle("shown",data.clock.analog&&data.showall),paramId("greetings_options")?.classList.toggle("shown",!data.hide?.greetings),paramId("digital_options")?.classList.toggle("shown",!data.clock.analog),paramId("ampm_label")?.classList.toggle("shown",data.clock.ampm),paramId("worldclocks_options")?.classList.toggle("shown",data.clock.worldclocks),paramId("main_options")?.classList.toggle("shown",data.main),paramId("weather_provider")?.classList.toggle("shown",data.weather?.moreinfo==="custom"),paramId("quicklinks_options")?.classList.toggle("shown",data.quicklinks),paramId("notes_options")?.classList.toggle("shown",data.notes?.on),paramId("searchbar_options")?.classList.toggle("shown",data.searchbar?.on),paramId("searchbar_request")?.classList.toggle("shown",data.searchbar?.engine==="custom"),paramId("quotes_options")?.classList.toggle("shown",data.quotes?.on);let gridLayoutButtons=domsettings.querySelectorAll("#grid-layout button"),selectedLayout=data.move?.selection||"single";for(let button of gridLayoutButtons)button?.classList.toggle("selected",button.dataset.layout===selectedLayout);paramId("b_showtitles").classList.toggle("on",data?.linktitles??!0),paramId("b_showbackgrounds").classList.toggle("on",data?.linkbackgrounds??!0);let disableWeather=data.hide?.weatherdesc&&data.hide?.weathericon,descOnly=data.hide?.weatherdesc,iconOnly=data.hide?.weathericon,dateOnly=data.hide?.clock,clockOnly=data.hide?.date,hideTime="all",hideWeather="all";dateOnly?hideTime="date":clockOnly&&(hideTime="clock"),disableWeather?hideWeather="disabled":descOnly?hideWeather="desc":iconOnly&&(hideWeather="icon"),setInput("i_timehide",hideTime),setInput("i_weatherhide",hideWeather),paramId("quotes_options")?.classList.toggle("shown",data.quotes?.on),paramId("quotes_userlist")?.classList.toggle("shown",data.quotes?.type==="user"),paramId("quotes_url")?.classList.toggle("shown",data.quotes?.type==="url");let settingsForms=document.querySelectorAll("#settings form");for(let form of settingsForms){let inputs=form.querySelectorAll("input");for(let input of inputs)input.addEventListener("input",()=>{form.classList.toggle("valid",form.checkValidity())})}let browserSyncOption=document.querySelector("#i_synctype option[value='browser']");browserSyncOption&&(PLATFORM==="firefox"?browserSyncOption.textContent="Firefox Sync":PLATFORM==="chrome"&&BROWSER==="edge"?browserSyncOption.textContent="Edge Sync":PLATFORM==="chrome"?browserSyncOption.textContent="Chrome Sync":PLATFORM==="safari"?browserSyncOption.textContent="Safari":browserSyncOption.textContent=tradThis("Automatic"))}function initOptionsEvents(){if((0,import_mod7.onclickdown)(paramId("b_accept-permissions"),async()=>{await getPermissions("topSites","bookmarks");let data=await storage.sync.get();quickLinks(data),setTimeout(()=>initGroups(data),10),settingsNotifications({"accept-permissions":!1})}),(0,import_mod7.onclickdown)(paramId("i_showall"),(_,target)=>{showall(target.checked,!0)}),paramId("i_lang").addEventListener("change",function(){switchLangs(this.value)}),paramId("i_favicon").addEventListener("input",function(){favicon(this.value,!0)}),paramId("i_favicon").addEventListener("change",function(){this.blur()}),paramId("i_tabtitle").addEventListener("input",function(){tabTitle(this.value,!0)}),paramId("i_tabtitle").addEventListener("change",function(){this.blur()}),paramId("i_dark").addEventListener("change",function(){darkmode(this.value,!0)}),(0,import_mod7.onclickdown)(paramId("i_settingshide"),(_,target)=>{hideElements({settingsicon:target.checked},{isEvent:!0})}),(0,import_mod7.onclickdown)(paramId("i_quicklinks"),(_,target)=>{moveElements(void 0,{widget:["quicklinks",target.checked]})}),paramId("f_addlink").addEventListener("submit",function(event){event.preventDefault(),quickLinks(void 0,{addLinks:[{title:paramId("i_addlink-title").value,url:paramId("i_addlink-url").value}]}),paramId("i_addlink-url").value="",paramId("i_addlink-title").value="",this.classList.remove("valid")}),(0,import_mod7.onclickdown)(paramId("i_linkgroups"),(_,target)=>{quickLinks(void 0,{groups:target.checked})}),(0,import_mod7.onclickdown)(paramId("i_linknewtab"),(_,target)=>{quickLinks(void 0,{newtab:target.checked})}),paramId("i_linkstyle").addEventListener("change",function(){quickLinks(void 0,{styles:{style:this.value}})}),(0,import_mod7.onclickdown)(paramId("b_showtitles"),(_,target)=>{quickLinks(void 0,{styles:{titles:!target.classList.contains("on")}})}),(0,import_mod7.onclickdown)(paramId("b_showbackgrounds"),(_,target)=>{quickLinks(void 0,{styles:{backgrounds:!target.classList.contains("on")}})}),paramId("i_row").addEventListener("input",function(){quickLinks(void 0,{row:this.value})}),(0,import_mod7.onclickdown)(paramId("b_importbookmarks"),async()=>{await getPermissions("topSites","bookmarks"),linksImport()}),paramId("i_type").addEventListener("change",function(){backgroundUpdate({type:this.value})}),paramId("b_solid-background").addEventListener("click",function(){paramId("i_solid-background").click()}),paramId("i_solid-background").addEventListener("input",function(){backgroundUpdate({color:this.value})}),paramId("i_background-provider").addEventListener("input",function(){backgroundUpdate({provider:this.value})}),paramId("f_background-user-coll").addEventListener("submit",function(event){backgroundUpdate({query:event}),event.preventDefault()}),paramId("f_background-user-search").addEventListener("submit",function(event){backgroundUpdate({query:event}),event.preventDefault()}),paramId("i_freq").addEventListener("change",function(){backgroundUpdate({freq:this.value})}),(0,import_mod7.onclickdown)(paramId("i_refresh"),event=>{backgroundUpdate({refresh:event})}),paramId("i_background-upload").addEventListener("change",function(){backgroundUpdate({files:this.files})}),(0,import_mod7.onclickdown)(paramId("b_background-urls"),()=>{backgroundUpdate({urlsapply:!0})}),(0,import_mod7.onclickdown)(paramId("i_background-local-compress"),(_event,target)=>{backgroundUpdate({compress:target.checked})}),paramId("i_texture").addEventListener("change",function(){backgroundUpdate({texture:this.value})}),paramId("b_texture-color").addEventListener("click",function(){paramId("i_texture-color").click()}),paramId("i_texture-color").addEventListener("input",function(){backgroundUpdate({texturecolor:this.value})}),paramId("i_texture-size").addEventListener("input",function(){backgroundUpdate({texturesize:this.value})}),paramId("i_texture-opacity").addEventListener("input",function(){backgroundUpdate({textureopacity:this.value})}),paramId("i_blur").addEventListener("pointerdown",function(){backgroundUpdate({blurenter:!0})}),paramId("i_blur").addEventListener("input",function(){backgroundUpdate({blur:this.value})}),paramId("i_bright").addEventListener("input",function(){backgroundUpdate({bright:this.value})}),paramId("i_fadein").addEventListener("input",function(){backgroundUpdate({fadein:this.value})}),(0,import_mod7.onclickdown)(paramId("i_time"),(_,target)=>{moveElements(void 0,{widget:["time",target.checked]})}),(0,import_mod7.onclickdown)(paramId("i_analog"),(_,target)=>{clock(void 0,{analog:target.checked})}),(0,import_mod7.onclickdown)(paramId("i_seconds"),(_,target)=>{clock(void 0,{seconds:target.checked})}),(0,import_mod7.onclickdown)(paramId("i_worldclocks"),(_,target)=>{paramId("worldclocks_options")?.classList.toggle("shown",target.checked),clock(void 0,{worldclocks:target.checked})}),paramId("i_clockface").addEventListener("change",function(){clock(void 0,{face:this.value})}),paramId("i_clockhands").addEventListener("change",function(){clock(void 0,{hands:this.value})}),paramId("i_analog-border-opacity").addEventListener("input",function(){clock(void 0,{border:"opacity"})}),paramId("i_analog-background-opacity").addEventListener("input",function(){clock(void 0,{background:"opacity"})}),paramId("i_analog-border-shade").addEventListener("click",()=>{clock(void 0,{border:"shade"})}),paramId("i_analog-background-shade").addEventListener("click",()=>{clock(void 0,{background:"shade"})}),paramId("i_clockshape").addEventListener("change",function(){clock(void 0,{shape:this.value})}),paramId("i_clocksize").addEventListener("input",function(){clock(void 0,{size:Number.parseFloat(this.value)})}),(0,import_mod7.onclickdown)(paramId("i_ampm"),(_,target)=>{clock(void 0,{ampm:target.checked}),paramId("ampm_label")?.classList.toggle("shown",target.checked)}),(0,import_mod7.onclickdown)(paramId("i_ampm-label"),(_,target)=>{clock(void 0,{ampmlabel:target.checked})}),paramId("i_timezone").addEventListener("change",function(){clock(void 0,{timezone:this.value})}),paramId("i_dateformat").addEventListener("change",function(){clock(void 0,{dateformat:this.value})}),paramId("i_timehide").addEventListener("change",function(){hideElements({clock:this.value==="clock",date:this.value==="date"},{isEvent:!0})}),(0,import_mod7.onclickdown)(paramId("i_main"),(_,target)=>{moveElements(void 0,{widget:["main",target.checked]})}),paramId("i_geol").addEventListener("change",function(){weather(void 0,{geol:this?.value})}),paramId("i_city").addEventListener("input",function(event){weather(void 0,{suggestions:event})}),paramId("f_location").addEventListener("submit",function(event){weather(void 0,{city:!0}),event.preventDefault()}),paramId("i_units").addEventListener("change",function(){weather(void 0,{units:this.value})}),paramId("i_forecast").addEventListener("change",function(){weather(void 0,{forecast:this.value})}),paramId("i_temp").addEventListener("change",function(){weather(void 0,{temp:this.value})}),paramId("i_moreinfo").addEventListener("change",function(){weather(void 0,{moreinfo:this.value})}),paramId("i_provider").addEventListener("change",function(){weather(void 0,{provider:this.value}),this.blur()}),paramId("i_weatherhide").addEventListener("change",function(){let weatherdesc=this.value==="disabled"||this.value==="desc",weathericon=this.value==="disabled"||this.value==="icon";hideElements({weatherdesc,weathericon},{isEvent:!0}),weather(void 0,{unhide:!0})}),(0,import_mod7.onclickdown)(paramId("i_greethide"),(_,target)=>{document.getElementById("greetings_options")?.classList.toggle("shown",target.checked),hideElements({greetings:!target.checked},{isEvent:!0})}),paramId("i_greeting").addEventListener("input",function(){clock(void 0,{greeting:this.value})}),paramId("i_greeting").addEventListener("change",()=>{paramId("i_greeting").blur()}),paramId("i_greetsize").addEventListener("input",function(){clock(void 0,{greetingsize:this.value})}),(0,import_mod7.onclickdown)(paramId("i_notes"),(_,target)=>{moveElements(void 0,{widget:["notes",target.checked]})}),paramId("i_notesalign").addEventListener("change",function(){notes(void 0,{align:this.value})}),paramId("i_noteswidth").addEventListener("input",function(){notes(void 0,{width:this.value})}),paramId("i_notes-opacity").addEventListener("input",function(){notes(void 0,{background:!0})}),(0,import_mod7.onclickdown)(paramId("i_notes-shade"),()=>{notes(void 0,{background:!0})}),(0,import_mod7.onclickdown)(paramId("i_sb"),(_,target)=>{moveElements(void 0,{widget:["searchbar",target.checked]}),getPermissions("search")}),paramId("i_sbengine").addEventListener("change",function(){searchbar(void 0,{engine:this.value})}),paramId("i_sb-opacity").addEventListener("input",function(){searchbar(void 0,{background:!0})}),paramId("i_sb-shade").addEventListener("click",()=>{searchbar(void 0,{background:!0})}),paramId("i_sbwidth").addEventListener("input",function(){searchbar(void 0,{width:this.value})}),paramId("i_sbrequest").addEventListener("change",function(){searchbar(void 0,{request:this})}),(0,import_mod7.onclickdown)(paramId("i_sbnewtab"),(_,target)=>{searchbar(void 0,{newtab:target.checked})}),(0,import_mod7.onclickdown)(paramId("i_sbsuggestions"),(_,target)=>{searchbar(void 0,{suggestions:target.checked})}),paramId("i_sbplaceholder").addEventListener("keyup",function(){searchbar(void 0,{placeholder:this.value})}),paramId("i_sbplaceholder").addEventListener("change",()=>{paramId("i_sbplaceholder").blur()}),(0,import_mod7.onclickdown)(paramId("i_quotes"),(_,target)=>{moveElements(void 0,{widget:["quotes",target.checked]})}),paramId("i_qtfreq").addEventListener("change",function(){quotes(void 0,{frequency:this.value})}),paramId("i_qttype").addEventListener("change",function(){quotes(void 0,{type:this.value})}),(0,import_mod7.onclickdown)(paramId("i_qtrefresh"),(event,target)=>{inputThrottle(target),turnRefreshButton(event,!0),quotes(void 0,{refresh:!0})}),(0,import_mod7.onclickdown)(paramId("i_qtauthor"),(_,target)=>{quotes(void 0,{author:target.checked})}),paramId("i_qtlist").addEventListener("change",function(){quotes(void 0,{userlist:this.value})}),paramId("f_qturl").addEventListener("submit",function(event){event.preventDefault(),quotes(void 0,{url:paramId("i_qturl").value})}),paramId("i_customfont").addEventListener("pointerenter",()=>{customFont(void 0,{autocomplete:!0})}),paramId("f_customfont").addEventListener("submit",event=>{customFont(void 0,{family:paramId("i_customfont").value}),event.preventDefault()}),paramId("i_weight").addEventListener("input",function(){customFont(void 0,{weight:this.value})}),paramId("i_size").addEventListener("input",function(){customFont(void 0,{size:this.value})}),paramId("i_textshadow").addEventListener("input",function(){textShadow(void 0,Number.parseFloat(this.value))}),(0,import_mod7.onclickdown)(paramId("b_editmove"),()=>{moveElements(void 0,{toggle:!document.getElementById("interface")?.classList.contains("move-edit")})}),paramId("i_pagecolumns").addEventListener("change",function(){moveElements(void 0,{layout:this.value,toggle:!0})}),paramId("i_pagewidth").addEventListener("input",function(){pageControl({width:Number.parseInt(this.value)},!0)}),paramId("i_pagegap").addEventListener("input",function(){pageControl({gap:Number.parseFloat(this.value)},!0)}),paramId("i_pagewidth").addEventListener("touchstart",()=>moveElements(void 0,{overlay:!0}),{passive:!0}),paramId("i_pagewidth").addEventListener("mousedown",()=>moveElements(void 0,{overlay:!0})),paramId("i_pagewidth").addEventListener("touchend",()=>moveElements(void 0,{overlay:!1})),paramId("i_pagewidth").addEventListener("mouseup",()=>moveElements(void 0,{overlay:!1})),paramId("i_announce").addEventListener("change",function(){interfacePopup(void 0,{announcements:this.value})}),(0,import_mod7.onclickdown)(paramId("i_supporters_notif"),(_,target)=>{supportersNotifications(void 0,{enabled:target.checked})}),paramId("i_synctype").addEventListener("change",function(){synchronization(void 0,{type:this.value})}),paramId("f_gistsync").addEventListener("submit",function(event){event.preventDefault(),synchronization(void 0,{gistToken:paramId("i_gistsync").value})}),paramId("f_urlsync").addEventListener("submit",function(event){event.preventDefault(),synchronization(void 0,{url:paramId("i_urlsync").value})}),(0,import_mod7.onclickdown)(paramId("b_storage-persist"),async()=>{let persists=await navigator.storage.persist();synchronization(void 0,{firefoxPersist:persists})}),(0,import_mod7.onclickdown)(paramId("b_gistup"),()=>{synchronization(void 0,{up:!0})}),(0,import_mod7.onclickdown)(paramId("b_gistdown"),()=>{synchronization(void 0,{down:!0})}),(0,import_mod7.onclickdown)(paramId("b_urldown"),()=>{synchronization(void 0,{down:!0})}),paramId("settings-managment").addEventListener("dragenter",()=>{paramId("settings-managment").classList.add("dragging-file")}),paramId("file-import").addEventListener("dragleave",()=>{paramId("settings-managment").classList.remove("dragging-file")}),paramId("b_file-load").addEventListener("click",function(){paramId("file-import")?.click()}),paramId("b_file-save").addEventListener("click",()=>{saveImportFile()}),paramId("file-import").addEventListener("change",function(){loadImportFile(this)}),paramId("b_settings-copy").addEventListener("click",()=>{copySettings()}),paramId("settings-data").addEventListener("input",event=>{toggleSettingsChangesButtons(event.type)}),paramId("settings-data").addEventListener("focus",event=>{toggleSettingsChangesButtons(event.type)}),paramId("settings-data").addEventListener("blur",event=>{toggleSettingsChangesButtons(event.type)}),(0,import_mod7.onclickdown)(paramId("b_settings-cancel"),()=>{toggleSettingsChangesButtons("cancel")}),(0,import_mod7.onclickdown)(paramId("b_settings-apply"),()=>{let val=paramId("settings-data").value;importSettings(parse(val)??{})}),(0,import_mod7.onclickdown)(paramId("b_reset-first"),()=>{resetSettings("first")}),(0,import_mod7.onclickdown)(paramId("b_reset-apply"),()=>{resetSettings("yes")}),(0,import_mod7.onclickdown)(paramId("b_reset-cancel"),()=>{resetSettings("no")}),IS_MOBILE){let rangeInputs=document.querySelectorAll("input[type='range'"),reduceSettingsOpacity=event=>{document.getElementById("settings")?.classList.toggle("see-through",event.type==="touchstart")};for(let input of rangeInputs)input.addEventListener("touchstart",reduceSettingsOpacity,{passive:!0}),input.addEventListener("touchend",reduceSettingsOpacity,{passive:!0})}let fileInputs=document.querySelectorAll('input[type="file"]');for(let input of fileInputs){let toggleDrag=_=>{input.classList.toggle("dragover")};input?.addEventListener("dragenter",toggleDrag),input?.addEventListener("dragleave",toggleDrag),input?.addEventListener("drop",toggleDrag)}let tooltips=document.querySelectorAll(".tooltip");for(let tooltip of tooltips)(0,import_mod7.onclickdown)(tooltip,()=>{let ttclass=[...tooltip.classList].filter(cl=>cl.startsWith("tt"))[0];document.querySelector(`.tooltiptext.${ttclass}`)?.classList.toggle("shown")});let splitRangeButtons=document.querySelectorAll(".split-range button");for(let button of splitRangeButtons)(0,import_mod7.onclickdown)(button,()=>{button.classList.toggle("on")})}function initWorldClocksAndTimezone(data){let template=document.getElementById("timezones-select-template"),citiesSelector='input[name="worldclock-city"]',timezonesSelector=".worldclocks-item select",cities=document.querySelectorAll(citiesSelector),timezone=document.querySelector("#i_timezone"),timezones=document.querySelectorAll(timezonesSelector),zones=["Europe/Paris","America/Sao_Paulo","America/Los_Angeles","Asia/Tokyo","Asia/Kolkata"];for(let select of timezones)select.appendChild(template.content.cloneNode(!0));timezone&&timezone.appendChild(template.content.cloneNode(!0)),cities?.forEach((input,i)=>{input.addEventListener("input",()=>{clock(void 0,{world:{index:i,region:input.value}})}),data.worldclocks[i]&&(input.value=data.worldclocks[i].region)}),timezones?.forEach((select,i)=>{select.addEventListener("change",event=>{let timezone2=event.target.value;clock(void 0,{world:{index:i,timezone:timezone2}})}),select.value=data.worldclocks[i]?.timezone??zones[i]}),timezone&&(timezone.value=data.clock.timezone)}function translatePlaceholders(){let cases=[["i_title","Name"],["i_greeting","Name"],["i_tabtitle","New tab"],["i_sbrequest","Search query: %s"],["i_sbplaceholder","Search"],["css-editor-textarea","Type in your custom CSS"],["i_importtext","or paste as text"],["i_addlink-title","Title"],["i_addlink-url","example.com"],["i_qtlist",`Author, Your quote.
Author, Your second quote.`]];for(let[id,text]of cases)document.getElementById(id)?.setAttribute("placeholder",tradThis(text))}function translateAriaLabels(){for(let element of document.querySelectorAll("[title]")){let title=element.getAttribute("title")??"";element.setAttribute("title",tradThis(title)),element.setAttribute("aria-label",tradThis(title))}}async function switchLangs(nextLang){await toggleTraduction(nextLang),storage.sync.set({lang:nextLang}),storage.local.remove("quotesCache"),document.documentElement.setAttribute("lang",nextLang);let data=await storage.sync.get(),local=await storage.local.get(["quotesCache","userQuoteSelection","lastWeather"]);local?.lastWeather&&(local.lastWeather.timestamp=0,local.lastWeather.forecasted_timestamp=0),data.lang=nextLang,clock(data),changeGroupTitle({old:"",new:""},data),weather({sync:data,lastWeather:local.lastWeather}),quotes({sync:data,local}),tabTitle(data.tabtitle),notes(data.notes),customFont(void 0,{lang:!0}),settingsFooter(),translatePlaceholders(),translateAriaLabels(),supportersNotifications(void 0,{translate:!0})}function showall(val,event){document.getElementById("settings")?.classList.toggle("all",val),event&&storage.sync.set({showall:val})}function settingsFooter(){let one=document.querySelector("#signature-one"),two=document.querySelector("#signature-two"),version=document.getElementById("version"),rand=Math.random()>.5;one&&two&&(one.href=rand?"https://victr.me/":"https://tahoe.be/",two.href=rand?"https://tahoe.be/":"https://victr.me/",one.textContent=rand?"Victor Azevedo":"Tahoe Beetschen",two.textContent=rand?"Tahoe Beetschen":"Victor Azevedo"),version&&(version.textContent=SYNC_DEFAULT.about.version)}function settingsDrawerBar(){let drawerDragDebounce=debounce(()=>{document.getElementById("settings-footer").style.removeProperty("padding"),drawerDragEvents()},600);globalThis.addEventListener("resize",()=>{drawerDragDebounce(),document.getElementById("settings")?.style.transition||document.getElementById("settings")?.setAttribute("style","transition: none")}),drawerDragEvents()}function drawerDragEvents(){let mobileDragZone=document.getElementById("mobile-drag-zone"),settingsDom=document.getElementById("settings"),settingsVh=-75,firstPos2=0,startTouchY=0;mobileDragZone?.addEventListener("touchstart",dragStart,{passive:!1}),mobileDragZone?.addEventListener("pointerdown",dragStart,{passive:!1});function dragStart(e){e.preventDefault(),!settingsDom.classList.contains("dragging-mobile-settings")&&(e.type==="pointerdown"&&(startTouchY=e.clientY),e.type==="touchstart"&&(startTouchY=e.touches[0].clientY),firstPos2===0&&(firstPos2=startTouchY),globalThis.addEventListener("touchmove",dragMove),globalThis.addEventListener("pointermove",dragMove),document.body.addEventListener("touchend",dragEnd),document.body.addEventListener("pointerup",dragEnd),document.body.classList.add("dragging-mobile-settings"))}function dragMove(e){let clientY=0;e.type==="pointermove"&&(clientY=e.clientY),e.type==="touchmove"&&(clientY=e.touches[0].clientY),clientY>60&&(settingsVh=+(100-(clientY-25)/globalThis.innerHeight*100).toFixed(2),settingsDom.style.transform=`translateY(-${settingsVh}dvh)`,settingsDom.style.transition="transform .0s")}function dragEnd(e){let clientY=0;e.type==="pointerup"&&(clientY=e.clientY),e.type==="touchend"&&(clientY=e.changedTouches[0].clientY),globalThis.removeEventListener("touchmove",dragMove),globalThis.removeEventListener("pointermove",dragMove),document.body.removeEventListener("touchend",dragEnd),document.body.removeEventListener("pointerup",dragEnd),startTouchY=0;let footer=document.getElementById("settings-footer");footer.style.paddingBottom=`${100-Math.abs(settingsVh)}dvh`,settingsDom.style.removeProperty("padding"),settingsDom.style.removeProperty("width"),settingsDom.style.removeProperty("overflow"),settingsDom.classList.remove("dragging"),clientY>globalThis.innerHeight-100&&settingsToggle()}}function copySettings(){let copybtn=document.querySelector("#b_settings-copy span"),pre=document.getElementById("settings-data");try{navigator.clipboard.writeText(pre?.textContent??"{}"),copybtn&&(copybtn.textContent=tradThis("Copied!"),setTimeout(()=>{copybtn.textContent=tradThis("Copy")},1e3))}catch{}}async function saveImportFile(){let a=document.getElementById("file-download");if(!a)return;let date=new Date,data=await storage.sync.get()??{},zero=n=>n.toString().length===1?`0${n}`:n.toString(),yyyymmdd=date.toISOString().slice(0,10),hhmmss=`${zero(date.getHours())}_${zero(date.getMinutes())}_${zero(date.getSeconds())}`,bytes=new TextEncoder().encode(stringify2(data)),blob=new Blob([bytes],{type:"application/json;charset=utf-8"}),href=URL.createObjectURL(blob);a.setAttribute("href",href),a.setAttribute("tabindex","-1"),a.setAttribute("download",`bonjourr-${data?.about?.version} ${yyyymmdd} ${hhmmss}.json`),a.click()}function loadImportFile(target){function decodeExportFile(str){let result={};try{result=parse(atob(str))??{}}catch{try{result=parse(str)??{}}catch{result={}}}return result}if(!target.files||target.files&&target.files.length===0)return;let file=target.files[0],reader=new FileReader;reader.onload=()=>{if(typeof reader.result!="string")return!1;let importData=decodeExportFile(reader.result);Object.keys(SYNC_DEFAULT).filter(key=>key in importData).length>0&&importSettings(importData)},reader.readAsText(file)}async function importSettings(imported){try{let data=await storage.sync.get();if(imported?.font?.system===!1){let family=imported?.font?.family,lang=imported?.lang;await fontIsAvailableInSubset(lang,family)===!1&&(imported.font.family="")}imported?.searchbar?.on&&getPermissions("search"),data=filterImports(data,imported),storage.sync.clear(),storage.sync.set(data),fadeOut()}catch{}}function resetSettings(action){if(action==="yes"){storage.clearall().then(fadeOut);return}document.getElementById("reset-first")?.classList.toggle("shown",action==="no"),document.getElementById("reset-conf")?.classList.toggle("shown",action==="first")}function updateSettingsJson(data){data?updateTextArea(data):storage.sync.get().then(updateTextArea);function updateTextArea(data2){let pre=document.getElementById("settings-data");if(pre&&data2.about){let orderedJson=stringify2(data2);data2.about.browser=PLATFORM,pre.textContent=orderedJson}}}function updateSettingsEvent(){let storageUpdate=()=>updateSettingsJson(),removeListener=()=>chrome.storage.onChanged.removeListener(storageUpdate);PLATFORM==="online"?globalThis.addEventListener("storage",storageUpdate):(chrome.storage.onChanged.addListener(storageUpdate),globalThis.addEventListener("beforeunload",removeListener,{once:!0}))}async function toggleSettingsChangesButtons(action){let textarea=paramId("settings-data"),data=await storage.sync.get(),hasChanges=!1;if(action==="input"){let current=stringify2(data),user="";try{user=stringify2(JSON.parse(textarea.value??"{}"))}catch{}hasChanges=user.length>2&&current!==user,hasChanges?paramId("b_settings-apply")?.removeAttribute("disabled"):paramId("b_settings-apply")?.setAttribute("disabled","")}action==="cancel"&&(textarea.value=stringify2(data),hasChanges=!1),action==="focus"&&(paramId("settings-files-options")?.classList.add("hidden"),paramId("settings-changes-options")?.classList.remove("hidden")),action==="blur"&&(paramId("settings-changes-options")?.classList.add("hidden"),paramId("settings-files-options")?.classList.remove("hidden"))}function paramId(str){return document.getElementById(str)}function setCheckbox(id,cat){let checkbox=paramId(id);checkbox.checked=cat}function setInput(id,val){let input=paramId(id);input.value=typeof val=="string"?val:val?.toString()}function setFormInput(id,defaults,value){let input=paramId(id);value?(input.value=value,input.setAttribute("placeholder",value)):input.setAttribute("placeholder",defaults)}var isMousingDownOnInput=!1;function userActions(){document.body.addEventListener("mousedown",detectTargetAsInputs),document.getElementById("b_editmove")?.addEventListener("click",closeSettingsOnMoveOpen),document.addEventListener("click",clickUserActions),document.addEventListener("keydown",keyboardUserActions),document.addEventListener("keyup",keyboardUserActions)}function keyboardUserActions(event){let domsuggestions2=document.getElementById("sb-suggestions");if(event.code==="Escape"){if(domsuggestions2?.classList.contains("shown")){domsuggestions2?.classList.remove("shown");return}let open=isOpen(),keyup=event.type==="keyup";open.contextmenu?document.dispatchEvent(new Event("close-edit")):open.settings&&keyup?document.dispatchEvent(new Event("toggle-settings")):open.selectall?document.dispatchEvent(new Event("remove-select-all")):open.folder?document.dispatchEvent(new Event("close-folder")):keyup&&document.documentElement.dataset.supportersModal===void 0&&document.dispatchEvent(new Event("toggle-settings"));return}if(event.code==="Tab"){document.body.classList.toggle("tabbing",!0);return}}function clickUserActions(event){if(isMousingDownOnInput)return;let open=isOpen(),path=(event.composedPath()??[document.body]).filter(node=>node?.className?.includes),pathIds=path.map(el=>el.id),on={body:path[0].tagName==="BODY",link:path.some(el=>el.classList.contains("link")),linkfolder:path.some(el=>el.className.includes("folder")),addgroup:path.some(el=>el.className.includes("add-group")),folder:path.some(el=>el.className.includes("in-folder")),button:path.some(el=>el.className.includes("param-btn")),localfiles:path.some(el=>el.id==="local_options"),localthumbnail:path.some(el=>el.className.includes("thumbnail")),interface:pathIds.includes("interface"),editlink:pathIds.includes("editlink"),settings:path.some(el=>el.id==="settings"),showsettings:path.some(el=>el.id==="show-settings")};if(document.body.classList.contains("tabbing")&&document.body?.classList.toggle("tabbing",!1),document.querySelectorAll(".thumbnail.selected")&&!on.localthumbnail&&!on.button)for(let node of document.querySelectorAll(".thumbnail.selected"))node.classList.remove("selected");if(on.showsettings&&document.dispatchEvent(new Event("toggle-settings")),open.contextmenu&&!on.editlink){if(on.addgroup&&document.querySelector(".link-title.add-group.selected"))return;document.dispatchEvent(new Event("close-edit"));return}(on.body||on.interface)!==!1&&(open.settings?document.dispatchEvent(new Event("toggle-settings")):open.selectall&&!on.link?document.dispatchEvent(new Event("remove-select-all")):open.folder&&!on.folder&&!on.linkfolder&&document.dispatchEvent(new Event("close-folder")))}function isOpen(){return{settings:!!document.getElementById("settings")?.classList.contains("shown"),folder:!!document.querySelector(".in-folder"),selectall:document.getElementById("linkblocks")?.classList.contains("select-all"),contextmenu:document.querySelector("#editlink")?.open}}function detectTargetAsInputs(event){let tagName=event.composedPath()[0]?.tagName??"";isMousingDownOnInput=["TEXTAREA","INPUT"].includes(tagName)}function closeSettingsOnMoveOpen(){setTimeout(()=>{document.getElementById("element-mover")?.classList.contains("hidden")===!1&&document.dispatchEvent(new Event("toggle-settings"))},20)}try{startup(),serviceWorker(),onlineAndMobile()}catch{console.warn("Startup failed")}async function startup(){let{sync,local}=await storage.init(),oldVersion=sync?.about?.version;(!sync||!local)&&(console.warn("Storage failed, loading Bonjourr with default settings"),sync=structuredClone(SYNC_DEFAULT),local=structuredClone(LOCAL_DEFAULT)),oldVersion!==CURRENT_VERSION&&(console.info(`Updated Bonjourr, ${oldVersion} => ${CURRENT_VERSION}`),localStorage.setItem("upgrade-archive",JSON.stringify(sync)),sync=upgradeSyncStorage(sync),local=upgradeLocalStorage(local),await storage.sync.clear(),await storage.sync.set(sync)),await setTranslationCache(sync.lang,local),displayInterface(void 0,sync),traduction(null,sync.lang),userDate(sync.clock.timezone),suntime(local.lastWeather?.sunrise,local.lastWeather?.sunset),weather({sync,lastWeather:local.lastWeather}),customFont(sync.font),textShadow(sync.textShadow),favicon(sync.favicon),tabTitle(sync.tabtitle),clock(sync),darkmode(sync.dark),searchbar(sync.searchbar),quotes({sync,local}),notes(sync.notes),moveElements(sync.move),customCss(sync.css),hideElements(sync.hide),backgroundsInit(sync,local,!0),quickLinks(sync),synchronization(local),settingsInit(sync,local),pageControl({width:sync.pagewidth,gap:sync.pagegap}),operaExtensionExplainer(local.operaExplained),document.documentElement.dataset.system=SYSTEM_OS,document.documentElement.dataset.browser=BROWSER,document.documentElement.dataset.platform=PLATFORM,document.getElementById("time")?.classList.toggle("hidden",!sync.time),document.getElementById("main")?.classList.toggle("hidden",!sync.main),onInterfaceDisplay(()=>{document.body.classList.remove("init"),setPotatoComputerMode(),userActions(),supportersNotifications(sync),interfacePopup({announce:sync.announcements,review:sync.review??0,new:CURRENT_VERSION,old:oldVersion})})}function upgradeSyncStorage(data){return filterImports(data,data)}function upgradeLocalStorage(data){return data.translations=void 0,storage.local.remove("translations"),data={...LOCAL_DEFAULT,...data},data}function onlineAndMobile(){let dominterface3=document.getElementById("interface"),onlineFirefoxMobile=PLATFORM==="online"&&BROWSER==="firefox"&&IS_MOBILE,onlineSafariIos=PLATFORM==="online"&&BROWSER==="safari"&&SYSTEM_OS==="ios",visibilityHasChanged=!1,firefoxRafTimeout;IS_MOBILE&&document.addEventListener("visibilitychange",updateOnVisibilityChange),onlineFirefoxMobile&&(updateAppHeight(),SYSTEM_OS==="ios"&&(globalThis.requestAnimationFrame(triggerAnimationFrame),setTimeout(()=>cancelAnimationFrame(firefoxRafTimeout),500))),onlineSafariIos&&onSettingsLoad(()=>{let inputs=document.querySelectorAll('input[type="text"], input[type="url"], textarea');for(let input of inputs)input.addEventListener("focus",disableTouchAction),input.addEventListener("blur",enableTouchAction)});async function updateOnVisibilityChange(){if(visibilityHasChanged===!1){visibilityHasChanged=!0;return}visibilityHasChanged=!1;let sync=await storage.sync.get(),local=await storage.local.get(),{backgroundLastChange,lastWeather}=local;if(!sync.clock||!sync.weather)return;let time=(backgroundLastChange?new Date(backgroundLastChange):new Date).getTime(),needNew=needsChange(sync.backgrounds.frequency,time),notColor=sync.backgrounds.type!=="color";clock(sync),weather({sync,lastWeather}),notColor&&needNew&&backgroundsInit(sync,local)}function triggerAnimationFrame(){updateAppHeight(),firefoxRafTimeout=requestAnimationFrame(triggerAnimationFrame)}function updateAppHeight(){document.documentElement.style.setProperty("--app-height",`${globalThis.innerHeight}px`)}function disableTouchAction(){let settingsDom=document.getElementById("settings");dominterface3&&settingsDom&&(dominterface3.style.touchAction="none",settingsDom.style.touchAction="none")}function enableTouchAction(){let settingsDom=document.getElementById("settings");dominterface3&&settingsDom&&(dominterface3.style.removeProperty("touch-action"),settingsDom.style.removeProperty("touch-action"))}}function serviceWorker(){if(ENVIRONNEMENT!=="PROD"||PLATFORM!=="online"||!("serviceWorker"in navigator))return;navigator.serviceWorker.register("service-worker.js");let promptEvent;globalThis.addEventListener("beforeinstallprompt",e=>(promptEvent=e,promptEvent))}function setPotatoComputerMode(){if(BROWSER==="firefox"||BROWSER==="safari")return;let fourHours=1e3*60*60*4,isPotato=localStorage.potato==="yes";if(Date.now()-Number.parseInt(localStorage.lastPotatoCheck??"0")<fourHours){document.body.classList.toggle("potato",isPotato);return}let gl=document.createElement("canvas")?.getContext("webgl"),debugInfo=gl?.getExtension("WEBGL_debug_renderer_info");if(BROWSER==="chrome"&&!gl){document.body.classList.add("potato");return}let vendor=gl?.getParameter(debugInfo?.UNMASKED_VENDOR_WEBGL??0).toString(),renderer=gl?.getParameter(debugInfo?.UNMASKED_RENDERER_WEBGL??0).toString(),detectedPotato=vendor.includes("Google")&&renderer.includes("SwiftShader");localStorage.potato=detectedPotato?"yes":"no",localStorage.lastPotatoCheck=Date.now(),document.body.classList.toggle("potato",detectedPotato)}function operaExtensionExplainer(explained){if(explained||BROWSER!=="opera"||PLATFORM!=="chrome")return;let doc=document.getElementById("opera-explainer-template").content.cloneNode(!0),dialog=doc.getElementById("opera-explainer"),button=doc.getElementById("b_opera-explained");document.body.classList.add("loading"),document.body.appendChild(dialog),dialog.showModal(),setTimeout(()=>dialog.classList.add("shown")),button?.addEventListener("click",()=>{storage.local.set({operaExplained:!0}),document.body.classList.remove("loading"),dialog.close()})}})();
